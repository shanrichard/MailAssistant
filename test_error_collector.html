<!DOCTYPE html>
<html>
<head>
    <title>错误收集器测试</title>
</head>
<body>
    <h1>错误收集器测试页面</h1>
    <button onclick="testConsoleError()">测试 console.error</button>
    <button onclick="testUnhandledRejection()">测试 unhandledRejection</button>
    <button onclick="checkLogs()">查看日志</button>
    <button onclick="sendLogs()">手动发送日志</button>
    <button onclick="clearLogs()">清除日志</button>
    <button onclick="testAPIEndpoint()">测试后端API</button>
    
    <div id="results" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; font-family: monospace;"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        
        function log(message) {
            resultsDiv.textContent += message + '\n';
        }

        async function testConsoleError() {
            log('测试 console.error...');
            console.error('测试错误消息', new Date().toISOString());
        }

        async function testUnhandledRejection() {
            log('测试 unhandledRejection...');
            Promise.reject(new Error('测试 Promise rejection ' + new Date().toISOString()));
        }

        function checkLogs() {
            const errors = localStorage.getItem('mailassistant_frontend_errors');
            if (errors) {
                const errorList = JSON.parse(errors);
                log(`\n发现 ${errorList.length} 条错误日志:`);
                errorList.forEach((error, index) => {
                    log(`\n错误 ${index + 1}:`);
                    log(JSON.stringify(error, null, 2));
                });
            } else {
                log('\n没有找到错误日志');
            }
        }

        async function sendLogs() {
            log('\n尝试发送日志到后端...');
            const errors = localStorage.getItem('mailassistant_frontend_errors');
            if (!errors) {
                log('没有错误日志可发送');
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/api/debug/logs/all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        frontend_errors: JSON.parse(errors)
                    })
                });
                
                const data = await response.json();
                log('发送成功！响应:');
                log(JSON.stringify(data, null, 2));
            } catch (error) {
                log('发送失败: ' + error.message);
            }
        }

        function clearLogs() {
            localStorage.removeItem('mailassistant_frontend_errors');
            log('\n日志已清除');
        }

        async function testAPIEndpoint() {
            log('\n测试后端 API 端点...');
            try {
                // 测试获取后端日志
                const response = await fetch('http://localhost:8000/api/debug/logs/backend');
                const data = await response.json();
                log('后端日志 API 响应:');
                log(JSON.stringify(data, null, 2));
            } catch (error) {
                log('API 测试失败: ' + error.message);
            }
        }

        // 设置错误处理器（模拟 errorCollector.ts 的行为）
        window.addEventListener('unhandledrejection', (event) => {
            const error = {
                type: 'unhandledRejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack,
                timestamp: new Date().toISOString(),
                url: window.location.href
            };
            
            // 保存到 localStorage
            const existingErrors = JSON.parse(localStorage.getItem('mailassistant_frontend_errors') || '[]');
            existingErrors.unshift(error);
            localStorage.setItem('mailassistant_frontend_errors', JSON.stringify(existingErrors.slice(0, 100)));
            
            log('捕获到 unhandledRejection 错误');
        });

        // 拦截 console.error
        const originalError = console.error;
        console.error = function(...args) {
            const error = {
                type: 'console.error',
                message: args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                ).join(' '),
                timestamp: new Date().toISOString(),
                url: window.location.href
            };
            
            // 保存到 localStorage
            const existingErrors = JSON.parse(localStorage.getItem('mailassistant_frontend_errors') || '[]');
            existingErrors.unshift(error);
            localStorage.setItem('mailassistant_frontend_errors', JSON.stringify(existingErrors.slice(0, 100)));
            
            log('捕获到 console.error');
            originalError.apply(console, args);
        };

        log('错误收集器测试页面已加载');
    </script>
</body>
</html>