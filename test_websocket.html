<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Not connected</div>
    <div id="log" style="border: 1px solid black; height: 400px; overflow-y: scroll; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px;"></div>
    
    <script>
        const log = (msg, isError = false) => {
            const logDiv = document.getElementById('log');
            const time = new Date().toISOString();
            const color = isError ? 'red' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            if (isError) {
                console.error(msg);
            } else {
                console.log(msg);
            }
        };

        const updateStatus = (msg) => {
            document.getElementById('status').innerHTML = msg;
        };

        // 获取token
        const getToken = () => {
            try {
                const authData = localStorage.getItem('mailassistant_auth_token');
                if (authData) {
                    const parsed = JSON.parse(authData);
                    return parsed.state?.token || null;
                }
            } catch (e) {
                log('Error getting token: ' + e.message, true);
            }
            return null;
        };

        const token = getToken();
        log('Token: ' + (token ? token.substring(0, 20) + '...' : 'No token found'));

        if (!token) {
            updateStatus('No authentication token found');
            log('Please login to the application first', true);
            log('Open http://localhost:3000 in another tab and login first');
        } else {
            log('Connecting to Socket.IO server...');
            
            const socket = io('http://localhost:8000', {
                auth: {
                    token: token
                },
                transports: ['polling', 'websocket'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
            });

            socket.on('connect', () => {
                updateStatus('✅ Connected');
                log('Connected to Socket.IO server');
                log('Socket ID: ' + socket.id);
                log('Transport: ' + socket.io.engine.transport.name);
            });

            socket.on('disconnect', (reason) => {
                updateStatus('❌ Disconnected');
                log('Disconnected: ' + reason, true);
            });

            socket.on('connect_error', (error) => {
                updateStatus('❌ Connection Error');
                log('Connection error: ' + error.message, true);
                log('Error type: ' + error.type, true);
                if (error.data) {
                    log('Error data: ' + JSON.stringify(error.data), true);
                }
            });

            socket.on('connected', (data) => {
                log('Received "connected" event: ' + JSON.stringify(data));
            });

            socket.on('error', (data) => {
                log('Received error: ' + JSON.stringify(data), true);
            });

            socket.on('agent_event', (data) => {
                log('Received agent_event: ' + JSON.stringify(data));
            });

            // Engine.IO events for debugging
            socket.io.on('upgrade', () => {
                log('🚀 Transport upgraded to: ' + socket.io.engine.transport.name);
            });

            socket.io.on('ping', () => {
                log('Ping sent');
            });

            socket.io.on('pong', (latency) => {
                log('Pong received, latency: ' + latency + 'ms');
            });

            // Test sending a message after connection
            socket.on('connect', () => {
                setTimeout(() => {
                    log('Sending test message...');
                    socket.emit('agent_message', {
                        message: 'Hello from test page',
                        session_id: 'test'
                    });
                }, 2000);
            });
        }
    </script>
</body>
</html>