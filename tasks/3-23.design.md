# Design 3-23

## Requirements

1. **解决intermediate_steps错误**：当前EmailProcessorAgent使用LangChain的create_openai_tools_agent导致日报生成时报错"intermediate_steps"
2. **统一技术栈**：ConversationHandler已经使用LangGraph，需要将EmailProcessorAgent也迁移到LangGraph
3. **保持功能不变**：迁移后所有功能保持一致，特别是日报生成功能
4. **保持性能优化**：维持现有的LLM缓存机制
5. **向后兼容**：不影响现有的API调用方式和其他依赖

## Solution

### 1. 技术方案

修改EmailProcessorAgent，从LangChain迁移到LangGraph：

1. **保持继承结构**：仍然继承自BaseAgent，但重写关键方法
2. **使用create_react_agent**：替换create_openai_tools_agent
3. **无状态设计**：不使用checkpointer（EmailProcessor是无状态的）
4. **保留缓存机制**：LLM缓存继续使用

### 2. 核心改动

```python
# 主要改动点：
1. 导入LangGraph相关模块
   - from langgraph.prebuilt import create_react_agent
   - from langgraph.graph.message import add_messages
   - from langchain_core.messages import HumanMessage, SystemMessage, BaseMessage

2. 重写__init__方法
   - 创建graph_agent而不是agent
   - 不需要checkpointer（无状态）

3. 重写process方法
   - 使用LangGraph的ainvoke调用方式
   - 输入格式改为{"messages": [HumanMessage(content=message)]}
   - 从结果中提取最后一条消息

4. 调整_build_prompt方法
   - 返回List[BaseMessage]而不是ChatPromptTemplate
   - 适配LangGraph的prompt函数签名
```

### 3. 实施步骤

1. **备份当前代码**
   ```bash
   cp backend/app/agents/email_processor.py backend/app/agents/email_processor.py.backup
   ```

2. **修改EmailProcessorAgent类**
   - 添加LangGraph导入
   - 修改继承和初始化逻辑
   - 重写process方法
   - 调整prompt构建

3. **保持向后兼容**
   - 保留所有公共方法签名
   - 保留工具创建逻辑
   - 保留缓存机制

4. **测试验证**
   - 运行单元测试
   - 测试日报生成
   - 验证API功能

## Tests

### 1. 单元测试

```python
# backend/tests/test_email_processor_langgraph.py
import pytest
from backend.app.agents.email_processor import EmailProcessorAgent

@pytest.mark.asyncio
async def test_generate_daily_report():
    """测试生成日报功能"""
    agent = EmailProcessorAgent(user_id=test_user_id, db_session=db)
    report = await agent.process("请生成今天的邮件日报")
    
    assert report is not None
    assert "邮件" in report or "日报" in report
    assert len(report) > 100  # 日报应该有一定长度

@pytest.mark.asyncio
async def test_no_intermediate_steps_error():
    """确保没有intermediate_steps错误"""
    agent = EmailProcessorAgent(user_id=test_user_id, db_session=db)
    report = await agent.process("请生成今天的邮件日报")
    
    assert "intermediate_steps" not in report
    assert "抱歉，处理您的请求时出现了问题" not in report

@pytest.mark.asyncio
async def test_llm_cache_working():
    """测试LLM缓存机制"""
    agent1 = EmailProcessorAgent(user_id="user1", db_session=db)
    agent2 = EmailProcessorAgent(user_id="user2", db_session=db)
    
    # 应该使用相同的缓存
    assert len(EmailProcessorAgent._llm_cache) == 1
```

### 2. 集成测试

```bash
# 测试日报API
curl -X GET http://localhost:8000/api/reports/daily \
  -H "Authorization: Bearer $TOKEN"

# 测试刷新日报
curl -X POST http://localhost:8000/api/reports/daily/refresh \
  -H "Authorization: Bearer $TOKEN"

# 测试并发请求
for i in {1..5}; do
  curl -X GET http://localhost:8000/api/reports/daily \
    -H "Authorization: Bearer $TOKEN" &
done
wait
```

### 3. 回归测试

```bash
# 运行现有测试套件
pytest backend/tests/test_email_processor.py -v
pytest backend/tests/test_reports_api.py -v
pytest backend/tests/test_agents/ -v
```

### 4. 手动测试

```python
# 使用test_agent_error.py测试
python test_agent_error.py

# 预期输出：
# Testing with user: xxx@example.com
# Generating report...
# Report generated: [日报内容]...
```

### 5. 性能测试

```python
@pytest.mark.asyncio
async def test_performance_after_migration():
    """测试迁移后的性能"""
    import time
    
    agent = EmailProcessorAgent(user_id=test_user_id, db_session=db)
    
    start = time.time()
    await agent.process("请生成今天的邮件日报")
    duration = time.time() - start
    
    # 应该在合理时间内完成
    assert duration < 30  # 30秒内
```