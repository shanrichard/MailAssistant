# Design 2-12-8 - Settings页面实现（框架和功能）

## Requirements
实现一个极简的Settings页面，只包含日报定时设置功能。用户可以设置每日报告自动生成的时间。

**注：原本分为框架（2-12-8）和功能（2-12-14）两步，由于Settings页面功能简单，现合并为一个任务。**

### 功能需求
1. **日报时间设置**
   - 用户可以选择每天几点几分生成日报
   - 时间以用户本地时区为准
   - 设置后立即生效，更新后端定时任务

### 用户体验
- 界面极简，只显示必要的设置项
- 清晰的保存反馈
- 显示当前设置的时间

## Solution

### 界面设计
```typescript
// 页面结构
<Settings>
  <h1>设置</h1>
  <Card>
    <h2>日报生成时间</h2>
    <p>设置每天自动生成邮件日报的时间</p>
    <TimePicker value={reportTime} />
    <Button onClick={save}>保存</Button>
  </Card>
</Settings>
```

### 技术实现

#### 前端实现

1. **Settings组件**
```typescript
// Settings.tsx
const Settings: React.FC = () => {
  const [reportTime, setReportTime] = useState<string>('09:00');
  const [loading, setLoading] = useState(false);
  const [timezone, setTimezone] = useState<string>('');
  
  // 加载当前设置
  useEffect(() => {
    loadSettings();
  }, []);
  
  // 保存设置
  const handleSave = async () => {
    setLoading(true);
    try {
      await updateSettings({ 
        daily_report_time: reportTime,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      });
      showSuccessMessage('设置保存成功');
    } catch (error) {
      showErrorMessage('保存失败，请重试');
    } finally {
      setLoading(false);
    }
  };
}
```

2. **API客户端**
```typescript
// services/api.ts
export const schedulerApi = {
  getSchedule: () => api.get('/scheduler/schedule'),
  updateSchedule: (data) => api.post('/scheduler/schedule', data),
  triggerDailyReport: () => api.post('/scheduler/trigger/daily_report')
};
```

3. **Zustand Store**
```typescript
// stores/settingsStore.ts
interface SettingsState {
  dailyReportTime: string;
  timezone: string;
  loadSettings: () => Promise<void>;
  updateSettings: (settings: Partial<Settings>) => Promise<void>;
}
```

#### 后端实现（使用现有scheduler API）

1. **现有的Scheduler API路由**
```python
# api/scheduler.py (已存在)
@router.get("/schedule")
async def get_schedule(user: User = Depends(get_current_user)):
    # 返回用户的调度设置
    return await task_service.get_user_schedule(user.id)

@router.post("/schedule")
async def update_schedule(
    schedule_update: ScheduleUpdate,
    user: User = Depends(get_current_user)
):
    # 更新用户的调度设置
    return await task_service.update_user_schedule(user.id, schedule_update)
```

2. **TaskService实现（已存在）**
```python
# services/task_service.py
class TaskService:
    async def update_user_schedule(self, user_id: str, schedule_update: ScheduleUpdate):
        # 更新数据库中的用户偏好
        # 重新调度定时任务
        # 返回更新后的调度信息
        pass
```

### 错误处理和UI反馈
1. **加载状态**：显示加载动画
2. **保存中**：按钮显示"保存中..."并禁用
3. **保存成功**：显示成功提示3秒后消失
4. **保存失败**：显示错误提示
5. **网络错误**：显示"网络连接失败，请重试"

### 数据流
```
用户选择时间 → 点击保存 → API请求 → 更新数据库 → 更新定时任务 → 返回成功
```

## Tests

### 单元测试
- [ ] Settings组件渲染测试
- [ ] 时间选择器交互测试
- [ ] API调用模拟测试
- [ ] Store状态更新测试

### 功能测试
- [ ] 页面正确加载当前设置的时间
- [ ] 时间选择器正常工作
- [ ] 保存按钮触发API调用
- [ ] 成功保存后显示提示
- [ ] 错误处理（网络错误、服务器错误）

### 集成测试
- [ ] 完整的设置加载流程
- [ ] 完整的设置保存流程
- [ ] 设置保存到数据库
- [ ] 定时任务重新调度验证
- [ ] 时区处理正确性

### E2E测试
- [ ] 用户打开Settings页面
- [ ] 修改时间并保存
- [ ] 验证新时间生效
- [ ] 验证日报按新时间生成

### 用户体验测试
- [ ] 界面简洁清晰
- [ ] 操作反馈及时
- [ ] 无需额外说明即可理解功能