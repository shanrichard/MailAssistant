# Design 3-13

## Requirements

### 背景
当前邮件同步系统过于复杂，涉及：
- Socket.IO 实时通信（与 BackgroundTasks 冲突）
- 后台任务管理
- 心跳机制
- 进度跟踪
- 幂等性保证
- 复杂的状态管理

这些复杂性导致系统不稳定，花费大量时间调试仍无法正常工作。

### 核心需求
实现一个极简的邮件同步方案：
1. **删除所有复杂机制**
   - 去掉 Socket.IO
   - 去掉 BackgroundTasks
   - 去掉心跳机制
   - 去掉进度跟踪
   - 去掉 APScheduler 定时任务

2. **提供三个同步按钮**
   - "同步今天" - 同步今天的邮件
   - "同步本周" - 同步本周的邮件
   - "同步本月" - 同步本月的邮件
   - 任务完成前，按钮置灰

3. **用户体验要求**
   - 用户点击按钮后，页面可能会卡一下（可接受）
   - 同步完成后显示结果：同步了多少封邮件
   - 如果超时（30秒），返回部分结果
   - 界面简单直观，用户一看就懂

4. **技术要求**
   - 使用同步执行，不使用后台任务
   - 使用 asyncio 超时控制（30秒）
   - 简化状态管理，只记录最后同步时间
   - 确保方案 100% 能工作

### 预期效果
- 用户可以根据需要选择同步范围
- 虽然没有进度条，但至少功能稳定可用
- 代码简单，易于维护和调试

## Solution

### 1. 后端实现

#### 1.1 新增三个简单的同步 API
```python
# backend/app/api/gmail.py

@router.post("/sync/today")
async def sync_today_emails(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """同步今天的邮件"""
    try:
        # 使用 asyncio.wait_for 设置 30 秒超时
        result = await asyncio.wait_for(
            sync_emails_by_timerange(
                user=current_user,
                timerange="today",
                db=db
            ),
            timeout=30.0
        )
        return result
    except asyncio.TimeoutError:
        return {
            "success": False,
            "message": "同步超时，请稍后重试",
            "stats": {"new": 0, "updated": 0}
        }

@router.post("/sync/week")
async def sync_week_emails(...):
    # 类似实现，timerange="week"

@router.post("/sync/month")
async def sync_month_emails(...):
    # 类似实现，timerange="month"
```

#### 1.2 实现核心同步函数
```python
# backend/app/services/gmail_service.py

async def sync_emails_by_timerange(
    user: User,
    timerange: str,  # "today", "week", "month"
    db: Session
) -> dict:
    """根据时间范围同步邮件，同步执行"""
    
    # 计算时间范围
    now = datetime.now()
    if timerange == "today":
        start_date = now.replace(hour=0, minute=0, second=0)
    elif timerange == "week":
        start_date = now - timedelta(days=now.weekday())
    elif timerange == "month":
        start_date = now.replace(day=1)
    
    # 调用 Gmail API
    messages = await fetch_messages_from_gmail(
        user=user,
        after_date=start_date,
        max_results=500  # 限制数量避免超时
    )
    
    # 保存到数据库
    stats = {"new": 0, "updated": 0}
    for msg in messages:
        existing = db.query(Email).filter_by(gmail_id=msg["id"]).first()
        if existing:
            # 更新
            stats["updated"] += 1
        else:
            # 新建
            email = Email(...)
            db.add(email)
            stats["new"] += 1
    
    db.commit()
    
    # 更新最后同步时间
    sync_status = db.query(UserSyncStatus).filter_by(user_id=user.id).first()
    if sync_status:
        sync_status.last_sync_time = now
        sync_status.sync_message = f"同步了 {stats['new']} 封新邮件"
    
    db.commit()
    
    return {
        "success": True,
        "message": f"成功同步了 {stats['new']} 封新邮件，更新了 {stats['updated']} 封",
        "stats": stats
    }
```

#### 1.3 需要删除的代码
- 删除 `backend/app/socketio_app.py`
- 删除 `backend/app/services/heartbeat_sync_service.py`
- 删除 `backend/app/services/idempotent_sync_service.py`
- 删除 `backend/app/scheduler/` 目录
- 从 `backend/app/main.py` 中删除所有 Socket.IO 和调度器相关代码
- 从 `backend/app/api/gmail.py` 中删除：
  - `smart_sync_emails` 端点
  - `get_sync_progress` 端点
  - `sync_health_check` 端点
  - 所有 BackgroundTasks 相关代码

### 2. 前端实现

#### 2.1 修改 Settings 页面
```tsx
// frontend/src/pages/Settings.tsx

// 删除复杂的同步状态管理，只保留基本状态
const [isSyncing, setIsSyncing] = useState(false);
const [syncResult, setSyncResult] = useState(null);

// 三个同步函数
const syncToday = async () => {
  setIsSyncing(true);
  setSyncResult(null);
  try {
    const result = await gmailService.syncToday();
    setSyncResult(result);
    showToast(result.message, 'success');
  } catch (error) {
    showToast('同步失败', 'error');
  } finally {
    setIsSyncing(false);
  }
};

const syncWeek = async () => { /* 类似实现 */ };
const syncMonth = async () => { /* 类似实现 */ };

// UI 部分
<div className="flex space-x-3">
  <button
    onClick={syncToday}
    disabled={isSyncing}
    className="px-4 py-2 rounded-md bg-blue-600 text-white"
  >
    {isSyncing ? '同步中...' : '同步今天'}
  </button>
  
  <button onClick={syncWeek} disabled={isSyncing}>
    同步本周
  </button>
  
  <button onClick={syncMonth} disabled={isSyncing}>
    同步本月
  </button>
</div>

{/* 显示同步结果 */}
{syncResult && (
  <div className="mt-4 p-3 bg-green-50 rounded">
    {syncResult.message}
  </div>
)}
```

#### 2.2 修改 Gmail Service
```typescript
// frontend/src/services/gmailService.ts

// 删除所有复杂的同步方法，只保留三个简单方法
async syncToday(): Promise<SyncResult> {
  return await apiClient.post(`${this.baseUrl}/sync/today`);
}

async syncWeek(): Promise<SyncResult> {
  return await apiClient.post(`${this.baseUrl}/sync/week`);
}

async syncMonth(): Promise<SyncResult> {
  return await apiClient.post(`${this.baseUrl}/sync/month`);
}
```

#### 2.3 需要删除的前端代码
- 删除 `useSyncTrigger` hook 中的所有复杂逻辑
- 删除进度跟踪相关的状态和组件
- 删除 WebSocket 相关代码（如果有）

### 3. 数据库简化

简化 `UserSyncStatus` 表，只保留：
- `user_id`
- `last_sync_time`
- `sync_message`

删除所有其他复杂字段（进度、任务ID、心跳时间等）。

## Tests

### 1. 功能测试
- 测试"同步今天"按钮：
  - 点击后应该同步今天的所有邮件
  - 返回同步的邮件数量
  - 更新最后同步时间

- 测试"同步本周"按钮：
  - 点击后应该同步本周的所有邮件
  - 验证时间范围计算正确

- 测试"同步本月"按钮：
  - 点击后应该同步本月的所有邮件
  - 验证时间范围计算正确

### 2. 超时测试
- 模拟大量邮件导致的超时情况
- 验证 30 秒后返回超时错误
- 确保不会导致系统崩溃

### 3. 并发测试
- 测试多次快速点击同步按钮
- 验证系统能正确处理（通过前端禁用按钮）

### 4. 错误处理测试
- 测试网络错误情况
- 测试 Gmail API 错误
- 验证错误信息正确显示给用户