# Design 3-5

## Requirements
- 前端登录后不断报错 WebSocket connection to 'ws://localhost:8000/socket.io/?EIO=4&transport=websocket' failed
- 需要调查项目中的两套 WebSocket 实现机制
- 确定哪套是正在使用的，哪套是历史遗留的
- 解决 WebSocket 连接错误问题

### 深入分析结果（2025-07-20更新）
经过深入调查，发现问题不是简单的配置错误，而是Socket.IO的WebSocket升级机制失败：

1. **问题表现**：
   - Polling阶段成功（获得session ID）
   - WebSocket升级失败："WebSocket is closed before the connection is established"
   - 错误发生在transport层的`freezeTransport`函数

2. **根本原因**：
   - **缺失的依赖**：`python-socketio`包未在requirements.txt中列出
   - **重复连接**：React StrictMode导致组件effect执行两次
   - **代码冲突**：传统WebSocket实现（/ws）与Socket.IO共存造成混淆

### 最终解决方案（已实施）

1. **修复Socket.IO依赖**：
   - 在requirements.txt中添加`python-socketio==5.10.0`
   - 重新安装依赖

2. **防止重复连接**：
   - 在chatStore中添加连接状态检查
   - 移除Chat.tsx中的重复连接代码

3. **清理传统WebSocket代码**：
   - 删除`backend/app/websockets/`目录
   - 移除main.py中的`/ws`端点
   - 更新相关文档

### 成果

- ✅ WebSocket连接错误已解决
- ✅ Socket.IO正常工作，支持从polling升级到WebSocket
- ✅ 代码更加清晰，避免了两套实现的混淆
- ✅ 文档与实际实现保持一致

## 分析结果

经过调查，发现项目中确实存在两套 WebSocket 实现：

1. **Socket.IO 实现** (`backend/app/socketio_app.py`)
   - 这是当前正在使用的实现
   - 前端使用 `socket.io-client` 库连接
   - 后端在 `main.py` 第129行挂载了 Socket.IO 服务

2. **传统 WebSocket 实现** (`backend/app/websockets/agent_ws.py`)
   - 这是之前的实现，现在已被废弃
   - 在 `main.py` 第114行仍然注册了 `/ws` 端点
   - 这部分代码是历史遗留，应该被清理

## 错误原因

前端配置错误：
- 前端 `config/index.ts` 中 `wsUrl` 配置为 `ws://localhost:8000`
- Socket.IO 客户端需要使用 HTTP URL，而不是 WebSocket URL
- Socket.IO 会自动处理协议升级，从 HTTP 升级到 WebSocket

## Solution

根据深入研究，发现：

1. **Socket.IO 是当前主要使用的实现**（在任务 2-12-12 中明确设计并实现）
2. **传统 WebSocket 实现目前没有被实际使用**：
   - `/ws` 端点在 `main.py` 中定义但前端没有连接到它
   - 前端使用 Socket.IO 客户端，不兼容原生 WebSocket
   - `agent_ws.py` 中的处理逻辑是 TODO 状态，没有实际集成

3. **错误原因确认**：
   - 前端 Socket.IO 客户端使用了错误的 URL 格式
   - `wsUrl: 'ws://localhost:8000'` 应该是 `http://localhost:8000`

### 任务拆分

由于本任务涉及多个方面，需要分步骤进行：

1. **3-5-1 修复Socket.IO配置错误**
   - 立即修复前端配置，让系统能正常工作
   - 验证修复效果

2. **3-5-2 研究传统WebSocket代码依赖关系**
   - 深入分析是否有隐藏的依赖
   - 确认是否可以安全删除

3. **3-5-3 清理传统WebSocket代码和更新文档**
   - 删除无用代码
   - 更新相关设计文档，移除相关TODO

## Tests
- 前端登录后不再出现 WebSocket 连接错误
- Socket.IO 连接成功建立
- 实时通信功能正常工作（如聊天功能）