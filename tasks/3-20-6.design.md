# Design 3-20-6 - 重构 EmailProcessorAgent 实现自主日报生成

## Requirements
- EmailProcessorAgent 收到"生成日报"请求后，自主完成任务
- 不依赖 generate_daily_report 工具
- 基于用户偏好生成个性化日报

## Solution

### 1. 确保 EmailProcessorAgent 可用的工具
- 从 email_tools 获取 `sync_emails`
- 从 conversation_tools 获取：
  - `search_email_history` - 查询邮件
  - `get_user_preferences` - 获取用户偏好
  - 可能需要的其他工具

### 2. 修改工具创建逻辑
```python
def _create_tools(self) -> List[Tool]:
    # 创建邮件工具
    email_tools = create_email_tools(self.user_id, self.db, user_context)
    
    # 创建对话工具
    conversation_tools = create_conversation_tools(self.user_id, self.db, user_context)
    
    # 合并工具列表
    return email_tools + conversation_tools
```

### 3. 更新 Agent 提示词
在 EMAIL_PROCESSOR_SYSTEM_PROMPT 中添加：
```
当用户要求生成日报时：
1. 使用 get_user_preferences 获取用户偏好
2. 使用 search_email_history 获取指定日期的所有邮件
3. 基于用户偏好分析哪些邮件是重要的
4. 将邮件按照合适的类别分组
5. 生成结构化的日报数据，包含：
   - 日期
   - 邮件总数
   - 重要邮件列表及原因
   - 分类邮件统计
   - 整体总结
```

### 4. 日报数据保存
- Agent 生成的日报数据需要保存到 DailyReportLog
- 可能需要创建一个工具来保存日报，或在 Agent 响应后由 API 层处理

## Tests
- 测试"生成今天的邮件日报"请求
- 测试"生成昨天的邮件日报"请求
- 验证生成的日报包含正确的结构
- 确认日报基于用户偏好个性化