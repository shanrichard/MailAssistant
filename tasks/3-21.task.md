# Task 3-21 - 日报系统架构优化

## 概述
基于任务3-20完成的邮件分析架构重构，进一步优化日报系统的实现，使其更符合实际使用需求。

## Subtasks
- [x] 3-21-1 实现 GET /api/reports/daily 端点
- [x] 3-21-2 实现触发式邮件同步机制
- [x] 3-21-3 前端改造为Markdown渲染
- [x] 3-21-4 实现日报刷新功能
- [x] 3-21-5 优化并发控制和状态管理

## 子任务详细说明

### 3-21-1 实现 GET /api/reports/daily 端点
- 创建 backend/app/api/reports.py 路由文件
- 实现基础的获取日报逻辑（不含同步触发）
- 处理三种状态：completed、processing、需要生成
- 实现后台任务 trigger_report_generation
- 在 main.py 中注册路由

### 3-21-2 实现触发式邮件同步机制  
- 在 GET /api/reports/daily 中添加同步检查逻辑
- 实现 check_and_trigger_sync 函数
- 使用 BackgroundTasks 触发非阻塞同步
- 确保同步不影响日报生成的响应时间

### 3-21-3 前端改造为Markdown渲染
- 安装 react-markdown 和相关依赖
- 修改 DailyReport.tsx 组件结构
- 更新 dailyReportService.ts 的API调用
- 修改 types/dailyReport.ts 的类型定义
- 实现 Markdown 样式主题适配

### 3-21-4 实现日报刷新功能
- 实现 POST /api/reports/daily/refresh 端点
- 前端添加刷新按钮和处理逻辑
- 处理刷新时的状态转换
- 确保旧日报被正确删除

### 3-21-5 优化并发控制和状态管理
- 添加超时检查逻辑（5分钟）
- 完善错误处理和状态转换
- 编写并发测试用例
- 优化数据库事务处理

## 背景
在任务3-20中，我们移除了预分析机制，实现了基于LLM的Agent架构。但发现以下问题：
1. 前端期望的 `/api/reports/daily` 端点不存在
2. 日报数据没有持久化到 DailyReportLog 表
3. 前端期望结构化数据，但Agent生成的是纯文本
4. 缺少邮件数据新鲜度保证机制