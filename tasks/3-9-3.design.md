# Design 3-9-3: 紧急修复：清理现有僵死任务数据

## Requirements
- 立即清理数据库中的僵死同步任务记录
- 修复特定的数据不一致问题：`task_id = 'sync_60f2ccbd-d754-4fa0-aa4d-35a7d6551d38_1753133270'`
- 批量清理所有超时的僵死任务（>30分钟）
- 验证修复效果，确保用户可以正常使用同步功能

## Solution
**执行顺序化SQL修复脚本**：

1. **修复特定僵死任务**
```sql
UPDATE user_sync_status 
SET 
    is_syncing = FALSE,
    progress_percentage = 0,
    current_stats = '{}',
    updated_at = NOW()
WHERE 
    task_id = 'sync_60f2ccbd-d754-4fa0-aa4d-35a7d6551d38_1753133270'
    AND is_syncing = TRUE;
```

2. **检查其他僵死任务**
```sql
SELECT 
    user_id,
    task_id,
    is_syncing,
    error_message,
    started_at,
    updated_at,
    EXTRACT(EPOCH FROM (NOW() - updated_at))/60 as minutes_since_update
FROM user_sync_status 
WHERE 
    is_syncing = TRUE 
    AND started_at < NOW() - INTERVAL '30 minutes';
```

3. **批量清理超时任务**
```sql
UPDATE user_sync_status 
SET 
    is_syncing = FALSE,
    progress_percentage = 0,
    error_message = CONCAT(COALESCE(error_message, ''), ' - 自动清理超时任务'),
    updated_at = NOW()
WHERE 
    is_syncing = TRUE 
    AND started_at < NOW() - INTERVAL '30 minutes';
```

## Tests
- 执行修复脚本前后的数据对比
- 验证特定僵死任务被正确清理
- 测试用户立即同步功能恢复正常
- 确认前端不再无限轮询

## 免测原因
这是紧急数据修复操作，主要通过SQL脚本执行和手动验证完成。