# Design 3-6-1: 修复 ConversationHandler 的弱引用缓存问题

## Requirements
- 解决 `_checkpointer_cache` 使用弱引用字典导致的竞态条件
- 确保 checkpointer 在使用期间不会被垃圾回收
- 保持内存使用的合理性，避免内存泄漏

## Solution
1. **使用普通字典替代弱引用字典**
   - 将 `weakref.WeakValueDictionary()` 改为普通的 `dict()`
   - 添加 LRU（最近最少使用）缓存策略，限制缓存大小
   - 实现定期清理机制，清除长时间未使用的 checkpointer

2. **改进缓存获取逻辑**
   - 使用 `get()` 方法安全获取值
   - 添加异常处理，捕获潜在的 KeyError
   - 在获取失败时创建新的 checkpointer

3. **添加缓存管理功能**
   - 实现缓存大小限制（如最多 1000 个用户）
   - 添加缓存过期时间（如 24 小时）
   - 提供手动清理缓存的方法

## Tests
- 单元测试：验证缓存在高并发下的稳定性
- 压力测试：模拟多用户同时访问，确保无竞态条件
- 内存测试：验证缓存不会导致内存泄漏