# Design 3-4-4 - 实现前端错误自动发送

## Requirements

在现有错误收集系统的基础上，实现错误自动发送功能，方便 Claude 进行自动化调试。

### 核心需求

1. **自动发送机制**
   - 严重错误（unhandledRejection）立即发送
   - 普通错误（console.error）批量发送
   - 定时发送累积的错误（30秒间隔）

2. **发送策略**
   - 避免频繁请求：批量发送、去重
   - 失败重试：网络错误时暂存，稍后重试
   - 发送后清理：成功发送的错误从 localStorage 移除

3. **保持向后兼容**
   - 保留手动发送功能
   - 不影响现有的错误收集
   - 仅在开发环境启用

## Solution

### 技术方案

1. **改造 errorCollector.ts**
   - 添加自动发送队列管理
   - 实现发送策略（立即/批量）
   - 添加发送状态追踪

2. **实现自动发送逻辑**
   ```typescript
   // 在 errorCollector 中添加
   private autoSendQueue: ErrorLog[] = [];
   private sendTimer: NodeJS.Timeout | null = null;
   private readonly BATCH_INTERVAL = 30000; // 30秒
   
   // 错误分级发送
   private scheduleAutoSend(error: ErrorLog) {
     if (error.type === 'unhandledRejection') {
       // 严重错误立即发送
       this.sendImmediately([error]);
     } else {
       // 普通错误加入队列
       this.autoSendQueue.push(error);
       this.scheduleBatchSend();
     }
   }
   ```

3. **批量发送实现**
   - 使用 debounce 机制避免频繁触发
   - 发送前去重（相同错误只发一次）
   - 发送成功后从 localStorage 清理

4. **失败重试机制**
   - 网络失败时保留在队列
   - 使用指数退避算法重试
   - 最多重试 3 次

5. **集成到现有系统**
   - 在 logError 方法中调用 scheduleAutoSend
   - 保持现有手动发送接口不变
   - 添加配置开关控制自动发送

## Tests

- [x] 严重错误（unhandledRejection）能立即发送
- [x] 普通错误（console.error）能批量发送
- [x] 30秒定时器正确触发批量发送
- [x] 相同错误去重功能正常
- [x] 网络失败时能正确重试
- [x] 发送成功后错误从 localStorage 清除
- [x] 手动发送功能仍然可用
- [x] 仅在开发环境启用自动发送