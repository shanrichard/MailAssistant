# Design 3-4-3 - 集成到现有系统

## Requirements

将错误收集系统集成到现有的 MailAssistant 项目中，确保最小化对现有代码的影响。

### 集成要点

1. **前端集成**
   - 在应用入口初始化错误收集器
   - 确保不影响生产环境
   - 提供便捷的调试工具

2. **后端集成**
   - 添加调试 API 路由
   - 确保开发环境限制
   - 利用现有的日志系统

3. **开发体验**
   - 简单易用
   - 不干扰正常开发流程
   - 方便 Claude 调用

## Solution

### 集成步骤

#### 1. 前端集成

**步骤 1.1: 添加错误收集器**
- 创建 `frontend/src/utils/errorCollector.ts`（使用 3-4-1 的设计）
- 创建 `frontend/src/utils/debugHelper.ts`（使用 3-4-2 的设计）

**步骤 1.2: 在入口文件初始化**
```typescript
// frontend/src/index.tsx
// 在文件顶部添加
import './utils/errorCollector'; // 自动初始化
import './utils/debugHelper';    // 注册全局调试函数

// 原有代码保持不变...
```

**步骤 1.3: 可选 - 添加 ErrorBoundary**
```typescript
// frontend/src/App.tsx
import ErrorBoundary from './components/ErrorBoundary';

function App() {
  return (
    <ErrorBoundary>
      {/* 原有的应用内容 */}
    </ErrorBoundary>
  );
}
```

#### 2. 后端集成

**步骤 2.1: 添加调试路由**
```python
# backend/app/main.py
from app.api import debug_logs  # 新增

# 在现有路由后添加
if settings.ENVIRONMENT == "development":
    app.include_router(debug_logs.router)
```

**步骤 2.2: 确保日志文件可读**
- 确认日志文件路径正确
- 确保日志格式为 JSON（当前项目已经是）

#### 3. 使用说明文档

创建 `docs/debug-logs.md`：

```markdown
# 调试日志系统使用指南

## 功能说明
本系统用于开发环境下收集和查看前后端错误日志。

## 前端错误收集
- 自动捕获 console.error
- 自动捕获未处理的 Promise rejection
- 错误存储在 localStorage (key: mailassistant_frontend_errors)
- 最多保存最近 100 条错误

## 查看日志

### 方式一：通过 API（推荐 Claude 使用）
\`\`\`bash
# 获取后端错误
curl http://localhost:8000/api/debug/logs/backend

# 获取所有错误（需要先在浏览器执行 window.debugLogs.send()）
curl -X POST http://localhost:8000/api/debug/logs/all \
  -H "Content-Type: application/json" \
  -d '{"frontend_errors": []}'
\`\`\`

### 方式二：浏览器控制台
\`\`\`javascript
// 查看前端错误
window.debugLogs.get()

// 发送到后端查看
await window.debugLogs.send()

// 清除错误
window.debugLogs.clear()
\`\`\`

## 注意事项
- 仅在开发环境可用
- 不会影响生产环境性能
- localStorage 有容量限制，会自动循环覆盖
```

### 测试计划

1. **集成测试**
   - 验证错误收集器在应用启动时自动初始化
   - 验证生产环境不会启用
   - 验证 API 端点正确注册

2. **功能测试**
   - 制造各种错误，验证捕获
   - 调用 API 验证日志返回
   - 测试浏览器控制台命令

3. **性能测试**
   - 确保不影响应用启动速度
   - 确保不影响正常错误处理流程

## Tests

- [ ] 错误收集器自动初始化
- [ ] 调试 API 仅在开发环境可用
- [ ] 前端错误正确捕获和存储
- [ ] API 能正确返回日志
- [ ] 不影响现有功能