# Design 3-11-3

创建数据库迁移，真正实施约束

## Requirements

### 问题描述
任务3-9设计了多个数据库约束，但没有创建相应的迁移文件，导致：
- 没有防止多个同时运行任务的机制
- 数据可能出现不一致状态
- 缺少关键的数据完整性保护

### 需要添加的约束
1. **状态一致性检查约束** (`chk_sync_state_consistency`)
2. **部分唯一索引** (`uniq_user_running_sync`) - 只对 is_syncing=true 的记录
3. **任务ID唯一索引** (`uniq_task_id`)

## Solution

### 1. 创建新的迁移文件
```bash
cd backend
alembic revision -m "Add constraints to user_sync_status table"
```

### 2. 迁移文件内容
```python
"""Add constraints to user_sync_status table

Revision ID: xxxxx
Revises: f00564e3c768
Create Date: 2025-01-22 xx:xx:xx

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy import text

def upgrade():
    # 1. 添加状态一致性检查约束
    op.create_check_constraint(
        'chk_sync_state_consistency',
        'user_sync_status',
        """
        (is_syncing = true AND progress_percentage >= 0 AND progress_percentage <= 99)
        OR 
        (is_syncing = false AND progress_percentage IN (0, 100))
        """
    )
    
    # 2. 添加任务ID唯一索引
    op.create_unique_constraint(
        'uniq_task_id',
        'user_sync_status',
        ['task_id']
    )
    
    # 3. 添加部分唯一索引 - 每个用户只能有一个运行中的任务
    op.execute(text("""
        CREATE UNIQUE INDEX uniq_user_running_sync 
        ON user_sync_status (user_id) 
        WHERE is_syncing = true
    """))
    
    # 4. 添加性能索引
    op.create_index(
        'idx_sync_status_updated',
        'user_sync_status',
        ['updated_at']
    )

def downgrade():
    op.drop_index('idx_sync_status_updated', 'user_sync_status')
    op.execute(text("DROP INDEX IF EXISTS uniq_user_running_sync"))
    op.drop_constraint('uniq_task_id', 'user_sync_status', type_='unique')
    op.drop_constraint('chk_sync_state_consistency', 'user_sync_status', type_='check')
```

### 3. 数据清理脚本
在应用约束前，需要清理现有的不一致数据：
```sql
-- 修复数据不一致
UPDATE user_sync_status 
SET is_syncing = false, progress_percentage = 100 
WHERE is_syncing = true AND progress_percentage = 100;

-- 清理僵死任务
UPDATE user_sync_status 
SET is_syncing = false, 
    error_message = 'Cleaned by migration',
    progress_percentage = 0
WHERE is_syncing = true 
  AND updated_at < NOW() - INTERVAL '1 hour';
```

## Tests

### 约束验证测试
1. **唯一运行任务测试**
   ```sql
   -- 应该失败
   INSERT INTO user_sync_status (user_id, is_syncing) 
   VALUES ('user-id', true), ('user-id', true);
   ```

2. **状态一致性测试**
   ```sql
   -- 应该失败
   UPDATE user_sync_status 
   SET is_syncing = true, progress_percentage = 100;
   ```

3. **任务ID唯一性测试**
   ```sql
   -- 应该失败
   INSERT INTO user_sync_status (user_id, task_id) 
   VALUES ('user1', 'task-123'), ('user2', 'task-123');
   ```

### 性能测试
- 验证索引提升查询性能
- 测试并发插入/更新操作

### 验收标准
- [ ] 迁移文件创建并测试通过
- [ ] 所有约束正确应用到数据库
- [ ] 现有数据清理完成，无冲突
- [ ] 约束防止了数据不一致问题