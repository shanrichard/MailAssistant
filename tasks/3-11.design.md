# Design 3-11

修复任务3-9实现中的严重bug，彻底解决立即同步僵死问题

## Requirements

### 问题现状
经过深入调试发现任务3-9虽然设计优秀，但实现存在5个严重bug：

1. **异步函数中使用同步阻塞调用**
   - `email_sync_service.py` 第298行使用 `time.sleep()` 阻塞事件循环
   - 导致心跳线程无法运行

2. **调用不存在的函数**
   - `gmail.py` 第347行调用 `execute_background_sync_v2` 
   - 该函数不存在，导致任务启动失败

3. **数据库约束未实际创建**
   - 迁移文件中没有添加设计的约束
   - `uniq_user_running_sync` 不是部分唯一索引

4. **自动清理调度器可能未启动**
   - 存在两个独立的调度器系统
   - 清理任务可能没有正常运行

5. **心跳机制设计缺陷**
   - 心跳更新和同步在不同异步任务中
   - 同步阻塞会影响心跳

### 修复目标
- 立即同步功能能正常工作，不再产生僵死任务
- 所有任务3-9设计的功能真正生效
- 系统具备自愈能力

## Solution

### 1. 修复异步阻塞（3-11-1）
```python
# email_sync_service.py 第298行
# 修改前：time.sleep(wait_time)
# 修改后：
await asyncio.sleep(wait_time)
```

### 2. 修复函数调用（3-11-2）
```python
# gmail.py 第347行
# 修改前：execute_background_sync_v2
# 修改后：execute_background_sync_with_heartbeat
```

### 3. 创建数据库迁移（3-11-3）
创建新的迁移文件，添加所有缺失的约束：
- 状态一致性检查约束
- 部分唯一索引（只对运行中的任务）
- 任务ID唯一索引

### 4. 整合调度器系统（3-11-4）
将僵死任务清理集成到主调度器中，避免混乱：
- 在 `scheduler_app.py` 的 `setup_system_jobs` 中添加清理任务
- 移除独立的 `scheduled_cleanup.py` 调度器

### 5. 改进心跳机制（3-11-5）
确保心跳更稳定：
- 增加错误处理
- 使用独立的数据库连接
- 添加心跳监控日志

## 执行策略

### 增量式修复和测试方法
每个子任务修复后立即进行测试验证，确保改动有效且不引入新问题。

### 执行顺序（按优先级）
1. **3-11-2** → 修复函数调用（最简单，影响最直接）
2. **3-11-1** → 修复异步阻塞（关键问题）
3. **3-11-4** → 整合调度器（确保清理机制）
4. **3-11-3** → 数据库迁移（最复杂，需要谨慎）
5. **3-11-5** → 全面测试验证

### 每步测试方法

#### Step 1: 修复3-11-2后测试
```bash
# 检查API是否能正常调用
curl -X POST http://localhost:8000/api/gmail/sync/smart \
  -H "Authorization: Bearer $TOKEN"
# 期望：返回task_id，不报错
```

#### Step 2: 修复3-11-1后测试
```bash
# 监控心跳更新
./monitor_heartbeat.sh
# 期望：看到定期的时间戳更新
```

#### Step 3: 修复3-11-4后测试
```bash
# 检查调度器状态
curl http://localhost:8000/api/scheduler/status
# 期望：看到zombie_task_cleanup任务
```

#### Step 4: 修复3-11-3后测试
```sql
-- 测试约束是否生效
-- 期望：第二条插入失败
```

#### Step 5: 全面集成测试
运行完整的e2e测试脚本

## Tests

### 阶段性测试
1. **Step 1 测试** - API调用成功
2. **Step 2 测试** - 心跳正常更新
3. **Step 3 测试** - 调度器包含清理任务
4. **Step 4 测试** - 数据库约束生效
5. **Step 5 测试** - 端到端功能正常

### 验收标准
- [ ] 每个步骤的测试都通过
- [ ] 没有引入新的错误
- [ ] 立即同步功能完全恢复
- [ ] 系统具备自愈能力