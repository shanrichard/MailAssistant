# Design 3-11-5

全面测试验证修复效果

## Requirements

### 测试目标
完成前4个子任务的修复后，需要全面测试验证：
1. 立即同步功能正常工作
2. 不再产生僵死任务
3. 系统具备自愈能力
4. 所有任务3-9的设计真正生效

### 测试范围
- 功能测试
- 性能测试
- 稳定性测试
- 回归测试

## Solution

### 1. 准备测试环境
```bash
# 1. 清理现有僵死任务
curl -X POST http://localhost:8000/api/debug/cleanup-zombie-tasks \
  -H "Authorization: Bearer $TOKEN"

# 2. 检查系统健康状态
curl http://localhost:8000/api/gmail/sync/health

# 3. 验证调度器运行
curl http://localhost:8000/api/scheduler/status
```

### 2. 功能测试脚本
```python
# test_sync_functionality.py
import asyncio
import aiohttp
import time
from datetime import datetime

async def test_immediate_sync():
    """测试立即同步功能"""
    headers = {"Authorization": f"Bearer {TOKEN}"}
    
    # 1. 触发同步
    async with aiohttp.ClientSession() as session:
        # 发起同步请求
        async with session.post(
            "http://localhost:8000/api/gmail/sync/smart",
            headers=headers
        ) as resp:
            result = await resp.json()
            task_id = result["task_id"]
            print(f"[{datetime.now()}] 同步任务启动: {task_id}")
        
        # 2. 监控进度（每5秒检查一次）
        for i in range(60):  # 最多等待5分钟
            await asyncio.sleep(5)
            
            async with session.get(
                f"http://localhost:8000/api/gmail/sync/progress/{task_id}",
                headers=headers
            ) as resp:
                progress = await resp.json()
                print(f"[{datetime.now()}] 进度: {progress['progress']}%, "
                      f"运行中: {progress['isRunning']}")
                
                if not progress['isRunning']:
                    print(f"同步完成! 统计: {progress['stats']}")
                    return True
        
        return False  # 超时

async def test_concurrent_sync():
    """测试并发同步（应该复用任务）"""
    headers = {"Authorization": f"Bearer {TOKEN}"}
    
    async with aiohttp.ClientSession() as session:
        # 快速发送3个同步请求
        tasks = []
        for i in range(3):
            task = session.post(
                "http://localhost:8000/api/gmail/sync/smart",
                headers=headers
            )
            tasks.append(task)
        
        responses = await asyncio.gather(*tasks)
        task_ids = [await r.json() for r in responses]
        
        # 验证是否复用了同一个任务
        unique_ids = set(t["task_id"] for t in task_ids)
        print(f"并发请求返回的任务ID: {unique_ids}")
        assert len(unique_ids) == 1, "应该复用同一个任务！"

# 运行测试
asyncio.run(test_immediate_sync())
asyncio.run(test_concurrent_sync())
```

### 3. 心跳监控测试
```bash
# monitor_heartbeat.sh
#!/bin/bash

echo "监控心跳更新..."
TASK_ID=$(curl -s -X POST http://localhost:8000/api/gmail/sync/smart \
  -H "Authorization: Bearer $TOKEN" | jq -r '.task_id')

echo "任务ID: $TASK_ID"

# 监控30秒，应该看到至少2次心跳更新
for i in {1..6}; do
  sleep 5
  curl -s http://localhost:8000/api/gmail/sync/progress/$TASK_ID \
    -H "Authorization: Bearer $TOKEN" | \
    jq -r '"[\(.updatedAt)] Progress: \(.progress)%, Running: \(.isRunning)"'
done
```

### 4. 僵死任务自动清理测试
```python
# test_zombie_cleanup.py
import time
import requests

# 1. 人为创建一个僵死任务（通过数据库）
# UPDATE user_sync_status SET updated_at = NOW() - INTERVAL '5 minutes' 
# WHERE task_id = 'test_zombie_task';

# 2. 等待2分钟，验证自动清理
print("等待自动清理...")
time.sleep(130)  # 2分钟10秒

# 3. 检查健康状态
health = requests.get("http://localhost:8000/api/gmail/sync/health").json()
print(f"僵死任务数: {health['statistics']['zombie_tasks']}")
assert health['statistics']['zombie_tasks'] == 0
```

### 5. 端到端测试
```bash
# e2e_test.sh
#!/bin/bash

echo "=== 端到端测试开始 ==="

# 1. 检查初始状态
echo "1. 检查系统健康..."
curl -s http://localhost:8000/api/gmail/sync/health | jq .

# 2. 触发同步
echo -e "\n2. 触发立即同步..."
RESPONSE=$(curl -s -X POST http://localhost:8000/api/gmail/sync/smart \
  -H "Authorization: Bearer $TOKEN")
echo $RESPONSE | jq .

# 3. 等待完成
TASK_ID=$(echo $RESPONSE | jq -r '.task_id')
echo -e "\n3. 监控任务进度..."
while true; do
  PROGRESS=$(curl -s http://localhost:8000/api/gmail/sync/progress/$TASK_ID \
    -H "Authorization: Bearer $TOKEN")
  IS_RUNNING=$(echo $PROGRESS | jq -r '.isRunning')
  
  if [ "$IS_RUNNING" = "false" ]; then
    echo "同步完成!"
    echo $PROGRESS | jq .
    break
  fi
  
  echo "进度: $(echo $PROGRESS | jq -r '.progress')%"
  sleep 10
done

# 4. 验证最终状态
echo -e "\n4. 验证最终状态..."
curl -s http://localhost:8000/api/gmail/sync/health | jq .
```

## Tests

### 测试清单
1. **基础功能测试** ✓
   - [ ] 立即同步成功启动
   - [ ] 进度实时更新
   - [ ] 任务正常完成

2. **并发安全测试** ✓
   - [ ] 多次点击只创建一个任务
   - [ ] 任务复用机制正常

3. **心跳机制测试** ✓
   - [ ] 15秒间隔心跳更新
   - [ ] 心跳时间戳递增

4. **自动清理测试** ✓
   - [ ] 僵死任务2分钟内清理
   - [ ] 清理日志正确记录

5. **错误恢复测试** ✓
   - [ ] 网络错误后重试
   - [ ] Token过期自动刷新

### 性能基准
- 同步1000封邮件耗时 < 5分钟
- 心跳更新延迟 < 100ms
- API响应时间 < 200ms

### 验收标准
- [ ] 所有测试用例通过
- [ ] 无僵死任务产生
- [ ] 系统健康检查显示 healthy: true
- [ ] 24小时稳定性测试通过
- [ ] 用户反馈问题已解决