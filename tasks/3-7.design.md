# Design 3-7: 优化WebSocket连接管理

## Requirements
- 解决WebSocket频繁断开和重连的问题
- 确保整个应用只有一个WebSocket连接实例
- 优化组件生命周期管理，避免重复初始化连接
- 提供清晰的连接状态监控和错误处理
- 清理项目中的废弃代码

## Solution

### 3-7-1: 清理废弃的chatService.ts代码
**目标**：删除未使用的WebSocket服务代码，避免混淆

**实施步骤**：
1. 删除 `frontend/src/services/chatService.ts` 文件
2. 确认没有任何地方引用该文件
3. 运行测试确保删除不会影响功能

### 3-7-2: 修复MainLayout组件的重复挂载问题
**目标**：防止组件重新渲染时重复创建WebSocket连接

**实施步骤**：
1. 优化 `MainLayout.tsx` 的 useEffect 依赖数组
2. 使用 useCallback 包装 connectWebSocket 和 disconnectWebSocket
3. 添加连接状态检查，避免重复连接
4. 实现代码：
   ```typescript
   // 使用 useCallback 避免函数引用变化
   const memoizedConnect = useCallback(() => {
     if (user && !isConnected) {
       connectWebSocket();
     }
   }, [user]);
   
   const memoizedDisconnect = useCallback(() => {
     disconnectWebSocket();
   }, []);
   
   useEffect(() => {
     memoizedConnect();
     return memoizedDisconnect;
   }, [memoizedConnect, memoizedDisconnect]);
   ```

### 3-7-3: 检查并优化React开发环境配置
**目标**：确认并处理React.StrictMode导致的双重渲染

**实施步骤**：
1. 检查 `index.tsx` 中是否启用了 React.StrictMode
2. 在开发环境中添加标记，防止双重初始化
3. 实现连接单例模式：
   ```typescript
   // 在 chatStore 中添加
   let connectionInitialized = false;
   
   connectWebSocket: async () => {
     if (connectionInitialized) {
       console.log('WebSocket connection already initialized');
       return;
     }
     connectionInitialized = true;
     // ... 连接逻辑
   }
   ```

### 3-7-4: 改进WebSocket连接生命周期管理
**目标**：优化连接的创建、维护和销毁流程

**实施步骤**：
1. 在 `chatStore.ts` 中改进连接管理：
   - 添加连接锁机制，防止并发连接
   - 优化重连逻辑，避免过度重连
   - 正确清理事件监听器
2. 实现代码框架：
   ```typescript
   interface ChatStoreState {
     // ... 现有字段
     connectionLock: boolean;
     reconnectAttempts: number;
     maxReconnectAttempts: number;
   }
   
   connectWebSocket: async () => {
     const state = get();
     
     // 检查连接锁
     if (state.connectionLock) {
       console.log('Connection already in progress');
       return;
     }
     
     // 检查现有连接
     if (state.socket?.connected) {
       console.log('Already connected');
       return;
     }
     
     set({ connectionLock: true });
     
     try {
       // 连接逻辑
     } finally {
       set({ connectionLock: false });
     }
   }
   ```

### 3-7-5: 添加详细的连接状态监控和日志
**目标**：提供完整的连接生命周期可见性

**实施步骤**：
1. 创建连接状态枚举：
   ```typescript
   enum ConnectionState {
     DISCONNECTED = 'disconnected',
     CONNECTING = 'connecting',
     CONNECTED = 'connected',
     RECONNECTING = 'reconnecting',
     ERROR = 'error'
   }
   ```
2. 在所有连接事件中添加详细日志
3. 创建连接状态监控组件（可选）
4. 集成到现有的调试日志系统

## Tests

### 3-7-1 测试：废弃代码清理
- 确认 chatService.ts 文件已删除
- 运行 `npm run build` 确保构建成功
- 运行现有测试套件确保功能正常

### 3-7-2 测试：组件挂载优化
- 在 MainLayout 组件中添加挂载计数日志
- 验证页面刷新时只创建一个连接
- 测试路由切换时连接保持稳定

### 3-7-3 测试：开发环境配置
- 记录组件渲染次数
- 验证在 StrictMode 下只建立一个连接
- 测试生产构建的行为

### 3-7-4 测试：连接生命周期
- 测试正常连接流程
- 测试网络断开后的重连行为
- 测试并发连接请求的处理
- 验证连接清理是否完整

### 3-7-5 测试：状态监控
- 验证所有连接状态变化都有日志
- 检查日志格式和内容的完整性
- 测试错误场景的日志记录