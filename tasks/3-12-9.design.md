# Design 3-12-9

## Requirements

### 重新测试完整的同步流程

在修复了幂等启动逻辑后，需要全面测试整个同步流程，确保：
1. 用户可以通过前端正常触发同步
2. 后台任务真正执行
3. 进度条实时更新
4. 错误处理正常工作

## Solution

### 测试计划

#### 1. 前端集成测试
- 清理所有现有任务
- 通过前端点击同步按钮
- 观察网络请求和响应
- 验证进度条更新

#### 2. API端点测试
```bash
# 测试同步API
curl -X POST http://localhost:8000/api/gmail/sync/smart \
  -H "Content-Type: application/json" \
  -H "Cookie: session=$SESSION_TOKEN" \
  -d '{"force_full": false}'

# 获取进度
curl http://localhost:8000/api/gmail/sync/progress/$TASK_ID \
  -H "Cookie: session=$SESSION_TOKEN"
```

#### 3. 日志验证
监控以下关键日志：
- "启动幂等同步"
- "检查活跃任务"
- "启动新的后台任务" 或 "复用现有任务"
- "使用asyncio.create_task启动任务"
- "开始执行带心跳的后台同步"
- 进度更新日志

#### 4. 数据库状态验证
```python
# 检查数据库状态的脚本
def check_sync_status():
    db = SessionLocal()
    status = db.query(UserSyncStatus).filter(
        UserSyncStatus.user_id == user_id
    ).first()
    
    print(f"任务ID: {status.task_id}")
    print(f"正在同步: {status.is_syncing}")
    print(f"进度: {status.progress_percentage}%")
    print(f"开始时间: {status.started_at}")
    print(f"更新时间: {status.updated_at}")
    
    db.close()
```

## Tests

### 测试用例清单

1. **正常同步流程**
   - [ ] 点击同步按钮
   - [ ] 获得任务ID，状态为CREATED
   - [ ] 3秒内状态变为RUNNING
   - [ ] 进度从0%开始增长
   - [ ] 最终状态变为SUCCEEDED，进度100%
   - [ ] 邮件正确同步到数据库

2. **重复点击测试（幂等性）**
   - [ ] 快速点击两次同步按钮
   - [ ] 确认返回相同的任务ID
   - [ ] 确认数据库只有一个任务记录
   - [ ] 确认只有一个后台任务在执行

3. **并发测试（专家建议）**
   - [ ] 并发发送5个同步请求
   - [ ] 验证所有请求返回相同task_id
   - [ ] 验证数据库只有一个RUNNING状态任务
   - [ ] 验证没有产生竞态条件

4. **状态转换测试**
   - [ ] CREATED → RUNNING：后台任务启动时
   - [ ] RUNNING → SUCCEEDED：同步成功完成
   - [ ] RUNNING → FAILED：同步过程出错
   - [ ] 验证状态转换的原子性

5. **错误恢复测试**
   - [ ] 模拟Gmail API错误
   - [ ] 确认状态变为FAILED
   - [ ] 确认错误信息被记录
   - [ ] 确认is_syncing被正确释放
   - [ ] 再次点击同步可以重新开始

6. **心跳超时测试**
   - [ ] 启动同步任务
   - [ ] 模拟任务卡住（不更新心跳）
   - [ ] 30分钟后检查健康端点
   - [ ] 验证任务被标记为stuck
   - [ ] 验证清理脚本能正确处理

7. **性能测试**
   - [ ] 同步1000+封邮件
   - [ ] 监控内存使用
   - [ ] 验证进度更新频率（批量+节流）
   - [ ] 验证数据库写入频率合理

### 成功标准
1. 所有测试用例通过
2. 没有"幽灵任务"（卡住的任务）
3. 用户体验流畅（进度条平滑更新）
4. 日志清晰，便于问题排查

## 监控指标

### 关键指标
1. **任务成功率**：完成的任务 / 总任务数
2. **平均执行时间**：从开始到完成的时间
3. **卡住任务数**：is_syncing=true 超过30分钟的任务
4. **错误率**：出错的任务 / 总任务数

### 告警阈值
- 任务成功率 < 95%
- 平均执行时间 > 5分钟
- 卡住任务数 > 0
- 错误率 > 5%

## 回滚计划

如果测试发现新问题：
1. 保存所有日志和错误信息
2. 回滚代码到之前的版本
3. 分析问题原因
4. 制定新的修复方案

## 文档更新

测试完成后，更新以下文档：
1. 更新 3-12.design.md 的执行情况
2. 如果发现新问题，创建新的子任务
3. 更新 README 中的同步功能说明