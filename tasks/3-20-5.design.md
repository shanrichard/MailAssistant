# Design 3-20-5 - 重构偏好系统：实现自然语言偏好管理

## Requirements
- EmailProcessorAgent 需要获取用户偏好来生成个性化日报
- 简化偏好系统，完全基于自然语言
- 删除 UserPreference 表和相关代码
- 只使用 User.preferences_text 字段
- 更新所有偏好相关的工具

## Solution

### 1. 实现 get_user_preferences 工具
```python
@tool
def get_user_preferences() -> str:
    """获取用户的邮件处理偏好。
    
    Returns:
        用户偏好的JSON字符串，包含自然语言描述
    """
    user = db_session.query(User).filter(User.id == user_id).first()
    
    if not user or not user.preferences_text:
        # 默认偏好
        default_preferences = """我希望重点关注以下类型的邮件：
1. 直接发给我的邮件（我是主要收件人，不是抄送）
2. 包含商业机会、合作意向的邮件
3. 来自重要联系人的邮件

我不太关注以下类型的邮件：
1. 群发的通知邮件
2. 营销推广邮件
3. 仅作为抄送的邮件
4. 自动生成的系统通知"""
        
        return json.dumps({
            "preferences": default_preferences,
            "has_preferences": False
        }, ensure_ascii=False)
    
    return json.dumps({
        "preferences": user.preferences_text,
        "has_preferences": True
    }, ensure_ascii=False)
```

### 2. 更新 update_user_preferences 工具
不再向 UserPreference 表插入数据，而是直接更新 User.preferences_text：
```python
def update_user_preferences(preference_description: str) -> str:
    """更新用户偏好设置。
    
    Args:
        preference_description: 偏好的自然语言描述
        
    Returns:
        更新结果的JSON字符串
    """
    user = db_session.query(User).filter(User.id == user_id).first()
    
    if not user:
        return json.dumps({"status": "error", "message": "用户不存在"}, ensure_ascii=False)
    
    # 如果已有偏好，追加新的；否则直接设置
    if user.preferences_text:
        user.preferences_text += f"\n\n{preference_description}"
    else:
        user.preferences_text = preference_description
    
    db_session.commit()
    
    return json.dumps({
        "status": "success",
        "message": "偏好已更新",
        "preferences": user.preferences_text
    }, ensure_ascii=False)
```

### 3. 删除 UserPreference 表和相关代码

#### 3.1 数据库迁移
- 创建新的迁移脚本删除 user_preferences 表

#### 3.2 模型层清理
- 删除 backend/app/models/user_preference.py 文件
- 从 models/__init__.py 移除 UserPreference 导入
- 从 User 模型移除 preferences 关系

#### 3.3 清理引用
- 检查所有使用 UserPreference 的地方
- 特别是 conversation_tools.py 中的相关代码

### 4. 实施步骤
1. 创建数据库迁移脚本，删除 user_preferences 表
2. 删除 UserPreference 模型文件
3. 更新 models/__init__.py 和 User 模型
4. 在 conversation_tools.py 中实现/更新工具：
   - 实现 get_user_preferences（如果不存在）
   - 更新 update_user_preferences
5. 测试所有功能正常

## Tests
- 测试 get_user_preferences 工具能正确返回用户偏好
- 测试 update_user_preferences 能正确更新 User.preferences_text
- 测试无偏好时返回默认偏好
- 验证 EmailProcessorAgent 能调用这些工具
- 确保删除 UserPreference 后系统正常运行