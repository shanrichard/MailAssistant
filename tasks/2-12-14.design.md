# Design 2-12-14 - Settings页面功能实现（可跳过）

**注：Settings页面功能已合并到2-12-8中实现，本任务可跳过。**

## Requirements
~~基于2-12-8的页面框架，实现Settings页面的完整功能，包括前后端集成、状态管理和定时任务更新。~~

**已合并到2-12-8**：由于Settings页面功能简单（仅设置日报时间），将框架和功能实现合并为一个任务更合理。

### 功能要求
1. 从后端加载用户当前的日报时间设置
2. 允许用户修改日报生成时间
3. 保存设置到后端并更新定时任务
4. 提供清晰的操作反馈

## Solution

### 前端实现细节

#### 1. Settings组件实现
```typescript
// Settings.tsx
const Settings: React.FC = () => {
  const [reportTime, setReportTime] = useState<string>('09:00');
  const [loading, setLoading] = useState(false);
  const [timezone, setTimezone] = useState<string>('');
  
  // 加载当前设置
  useEffect(() => {
    loadSettings();
  }, []);
  
  // 保存设置
  const handleSave = async () => {
    await updateSettings({ 
      daily_report_time: reportTime,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    });
  };
}
```

#### 2. API客户端扩展
```typescript
// services/api.ts
export const settingsApi = {
  getSettings: () => api.get('/settings'),
  updateSettings: (data) => api.put('/settings', data)
};
```

#### 3. Zustand Store
```typescript
// stores/settingsStore.ts
interface SettingsState {
  dailyReportTime: string;
  timezone: string;
  loadSettings: () => Promise<void>;
  updateSettings: (settings: Partial<Settings>) => Promise<void>;
}
```

### 后端实现细节

#### 1. Settings API路由
```python
# api/settings.py
@router.get("/settings")
async def get_settings(user: User = Depends(get_current_user)):
    preferences = get_user_preferences(user.id)
    return {
        "daily_report_time": preferences.daily_report_time,
        "timezone": preferences.timezone
    }

@router.put("/settings")
async def update_settings(
    settings: SettingsUpdate,
    user: User = Depends(get_current_user)
):
    # 更新用户偏好
    update_user_preferences(user.id, settings)
    # 重新调度定时任务
    reschedule_daily_report(user.id, settings.daily_report_time)
    return {"status": "success"}
```

#### 2. 定时任务更新
```python
# services/scheduler_service.py
def reschedule_daily_report(user_id: str, time: str):
    """重新调度用户的日报生成任务"""
    # 移除旧任务
    scheduler.remove_job(f"daily_report_{user_id}")
    # 添加新任务
    hour, minute = map(int, time.split(':'))
    scheduler.add_job(
        generate_daily_report,
        'cron',
        hour=hour,
        minute=minute,
        args=[user_id],
        id=f"daily_report_{user_id}"
    )
```

### 错误处理
1. **网络错误**：显示"网络连接失败，请重试"
2. **保存失败**：显示具体错误信息
3. **加载失败**：显示默认值并提示用户

### UI反馈
1. **加载状态**：显示加载动画
2. **保存中**：按钮显示"保存中..."并禁用
3. **保存成功**：显示成功提示3秒后消失
4. **保存失败**：显示错误提示

## Tests

### 单元测试
- [ ] Settings组件渲染测试
- [ ] 时间选择器交互测试
- [ ] API调用模拟测试
- [ ] Store状态更新测试

### 集成测试
- [ ] 完整的设置加载流程
- [ ] 完整的设置保存流程
- [ ] 定时任务重新调度验证
- [ ] 时区处理正确性

### E2E测试
- [ ] 用户打开Settings页面
- [ ] 修改时间并保存
- [ ] 验证新时间生效
- [ ] 验证日报按新时间生成