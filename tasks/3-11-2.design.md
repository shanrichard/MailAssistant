# Design 3-11-2

修复API中调用不存在的函数问题

## Requirements

### 问题描述
在 `gmail.py` 第347行调用了不存在的函数 `execute_background_sync_v2`，导致：
- 后台任务启动失败
- 可能抛出 NameError 异常
- 同步任务无法正常执行

### 影响范围
- 文件：`backend/app/api/gmail.py`
- 行号：347行
- 函数：`smart_sync_emails` API端点

## Solution

### 代码修改
```python
# 修改前（第347行）：
background_tasks.add_task(
    execute_background_sync_v2, current_user.id, force_full, task_id
)

# 修改后：
background_tasks.add_task(
    execute_background_sync_with_heartbeat, current_user.id, force_full, task_id
)
```

### 导入检查
确保正确导入了函数：
```python
from ..services.heartbeat_sync_service import execute_background_sync_with_heartbeat
```

### 函数签名验证
验证 `execute_background_sync_with_heartbeat` 的参数：
- user_id: str
- force_full: bool  
- task_id: str

## Tests

### 单元测试
- Mock BackgroundTasks，验证正确的函数被调用
- 验证参数传递正确

### API测试
```bash
# 测试智能同步API
curl -X POST http://localhost:8000/api/gmail/sync/smart \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"
```

### 错误处理测试
- 验证没有 NameError 异常
- 检查后台任务成功启动
- 监控任务执行日志

### 验收标准
- [ ] 函数名修正为 `execute_background_sync_with_heartbeat`
- [ ] API调用成功返回任务ID
- [ ] 后台任务正常启动并执行
- [ ] 没有函数未定义错误