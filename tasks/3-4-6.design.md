# Design 3-4-6

## Requirements

解决前端认证令牌存储键名不匹配的问题，该问题导致以下错误：
- "No auth token available" 在 WebSocket 连接时
- "No authentication token" 在聊天服务中
- 认证失败和相关功能无法正常工作

通过代码分析发现存在两套不同的令牌存储机制：

### 问题分析
1. **旧的存储方式** (`/Users/shanjingxiang/projects/MailAssistant/frontend/src/utils/auth.ts`)：
   - 使用 `access_token` 作为 localStorage 键名
   - 直接存储 token 字符串
   - 被 chatStore 使用（第87行调用 getToken()）

2. **新的存储方式** (其他服务):
   - 使用 `mailassistant_auth_token` 作为 localStorage 键名（来自配置 `APP_CONSTANTS.STORAGE_KEYS.AUTH_TOKEN`）
   - 存储复杂的 JSON 对象结构 `{state: {token: 'actual_token', user: {...}, isAuthenticated: true}}`
   - 被以下服务使用：
     - apiClient.ts (第96-104行)
     - chatService.ts (第161-169行) 
     - authStore.ts (使用 zustand persist 中间件，第178行配置存储键名)

### 冲突根源
- chatStore 通过 `getToken()` 函数寻找 `access_token` 键
- 但实际的令牌数据存储在 `mailassistant_auth_token` 键中
- 导致 chatStore 和 WebSocket 连接无法获取到认证令牌

### 需要修复的文件
1. `/Users/shanjingxiang/projects/MailAssistant/frontend/src/utils/auth.ts` - 更新存储键名和数据格式
2. `/Users/shanjingxiang/projects/MailAssistant/frontend/src/stores/chatStore.ts` - 确保使用统一的令牌获取方式
3. 任何其他直接调用旧 auth utils 的代码

### 期望结果
- 所有服务使用统一的令牌存储键名 `mailassistant_auth_token`
- 所有服务使用统一的数据格式 `{state: {token, user, isAuthenticated}}`
- WebSocket 连接能够正确获取认证令牌
- 聊天功能恢复正常工作
- 错误日志中不再出现 "No auth token available" 错误