# Design 3-22

## Requirements
- ConversationHandler agent 需要使用 Markdown 格式输出回答
- 前端 Chat 页面需要支持 Markdown 渲染
- 保持良好的视觉效果和用户体验
- 支持常见的 Markdown 元素（标题、列表、代码块、链接等）

## Solution

### 1. 后端修改

#### 1.1 更新 ConversationHandler 系统提示词
在 `backend/app/agents/conversation_handler.py` 的 `_build_system_prompt_for_graph` 方法中添加 Markdown 输出指导：
- 明确要求使用 Markdown 格式
- 提供格式化示例
- 强调结构化输出的重要性

#### 1.2 更新通用 Agent 提示词
在 `backend/app/config/agent_prompts.py` 中更新 `CONVERSATION_AGENT_SYSTEM_PROMPT`：
- 添加 Markdown 格式化要求
- 保持原有功能不变

### 2. 前端修改

#### 2.1 集成 react-markdown
在 `frontend/src/pages/Chat.tsx` 的 `AgentMessage` 组件中：
- 导入 `react-markdown`
- 替换普通文本渲染为 Markdown 渲染
- 配置合适的 Markdown 组件映射

#### 2.2 样式优化
- 利用 Tailwind CSS 的 `@tailwindcss/typography` 插件
- 确保 Markdown 内容在聊天界面中显示美观
- 处理代码块的语法高亮（可选）

### 3. 具体实现细节

#### 3.1 Markdown 提示词模板
```markdown
输出格式要求：
- 使用 Markdown 格式组织回答
- 重要信息用 **粗体** 标记
- 列表项目使用 - 或 1. 2. 3. 格式
- 代码使用 `inline code` 或代码块
- 标题使用 ## 或 ### 来组织内容结构
```

#### 3.2 前端渲染配置
```typescript
// 自定义 Markdown 组件样式
const markdownComponents = {
  h1: ({children}) => <h1 className="text-xl font-bold mb-2">{children}</h1>,
  h2: ({children}) => <h2 className="text-lg font-semibold mb-2">{children}</h2>,
  // ... 其他组件映射
}
```

## Tests

### 1. 后端测试
- 验证 ConversationHandler 输出包含 Markdown 格式
- 测试各种查询场景下的格式化效果
- 确保不影响工具调用功能

### 2. 前端测试
- 测试 Markdown 渲染效果
- 验证各种 Markdown 元素的显示
- 测试性能影响（大量 Markdown 内容）
- 测试移动端显示效果

### 3. 集成测试
- 端到端测试：发送消息 -> Agent 响应 -> Markdown 渲染
- 测试实时流式响应的 Markdown 渲染
- 测试错误处理和降级方案