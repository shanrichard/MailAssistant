# Design 3-9: ç«‹å³åŒæ­¥åŠŸèƒ½åå¤åƒµæ­»é—®é¢˜å½»åº•ä¿®å¤

## Requirements

### æ ¸å¿ƒé—®é¢˜æè¿°
ç«‹å³åŒæ­¥åŠŸèƒ½å­˜åœ¨ä¸€ä¸ªé¡½å›ºçš„é—®é¢˜ï¼šæ¯æ¬¡ç”¨æˆ·ç‚¹å‡»"ç«‹å³åŒæ­¥"æŒ‰é’®åï¼Œç³»ç»Ÿä¼šåˆ›å»ºåå°åŒæ­¥ä»»åŠ¡ï¼Œä½†ä»»åŠ¡ä¼šé™·å…¥åƒµæ­»çŠ¶æ€ï¼Œå¯¼è‡´ï¼š

1. **å‰ç«¯æ˜¾ç¤ºå¼‚å¸¸**ï¼š
   - è¿›åº¦æ¡å¡åœ¨0%
   - æ˜¾ç¤º"æ–°é‚®ä»¶: , æ›´æ–°: , é”™è¯¯: "ï¼ˆç©ºå€¼ï¼‰
   - ä¸€ç›´æ˜¾ç¤º"åŒæ­¥ä¸­"çŠ¶æ€

2. **åç«¯ç–¯ç‹‚è½®è¯¢**ï¼š
   - å‰ç«¯æ¯ç§’æŸ¥è¯¢åƒµæ­»ä»»åŠ¡çŠ¶æ€
   - åç«¯æ—¥å¿—å……æ»¡é‡å¤çš„æ•°æ®åº“æŸ¥è¯¢
   - èµ„æºæµªè´¹ä¸¥é‡

3. **é—®é¢˜åå¤å‡ºç°**ï¼š
   - æ‰‹åŠ¨æ¸…ç†åƒµæ­»ä»»åŠ¡åï¼Œç”¨æˆ·å†æ¬¡ç‚¹å‡»ç«‹å³åŒæ­¥ï¼Œé—®é¢˜é‡å¤å‘ç”Ÿ
   - å·²ä¿®å¤çš„åå°ä»£ç bugï¼Œä½†é—®é¢˜ä¾ç„¶å­˜åœ¨

### å·²å‘ç°çš„åƒµæ­»ä»»åŠ¡ç¤ºä¾‹
```
Task ID: sync_60f2ccbd-d754-4fa0-aa4d-35a7d6551d38_1753133270
Error: "ä»»åŠ¡è¢«ç®¡ç†å‘˜æ‰‹åŠ¨æ¸…ç†ï¼ˆä¿®å¤åï¼‰"
Updated At: 2025-07-22 13:27:50.842634+08:00
Is Syncing: True  â† ğŸ’¥ å…³é”®é—®é¢˜ï¼
Progress: 0%
Current Stats: {}
```

### ğŸ¯ **çœŸç›¸å¤§ç™½ï¼šæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆBREAKTHROUGHï¼‰**

ç»è¿‡æ·±åº¦è°ƒè¯•åˆ†æï¼Œå‘ç°äº†é—®é¢˜çš„**çœŸæ­£æ ¹å› **ï¼š

#### 1. **è¿™ä¸æ˜¯ä»£ç é€»è¾‘é—®é¢˜ï¼Œè€Œæ˜¯æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼**

**æ ¸å¿ƒå‘ç°**ï¼š
- æ•°æ®åº“ä¸­å­˜åœ¨ä¸€ä¸ª**åƒµæ­»çš„åŒæ­¥ä»»åŠ¡è®°å½•**
- è¯¥ä»»åŠ¡çš„`error_message`å·²è¢«è®¾ç½®ï¼Œä½†`is_syncing`ä»ä¸º`True`
- è¿™æ˜¯å…¸å‹çš„**éƒ¨åˆ†æ›´æ–°æˆåŠŸã€éƒ¨åˆ†æ›´æ–°å¤±è´¥**çš„æ•°æ®ä¸ä¸€è‡´çŠ¶æ€

**é—®é¢˜æµç¨‹**ï¼š
1. æŸæ¬¡æ‰‹åŠ¨ä¿®å¤è¿‡ç¨‹ä¸­ï¼ˆæˆ–è„šæœ¬æ‰§è¡Œæ—¶ï¼‰
2. æ•°æ®åº“æ›´æ–°æ“ä½œç¼ºä¹åŸå­æ€§ä¿è¯
3. `error_message`å­—æ®µæ›´æ–°æˆåŠŸ âœ…
4. `is_syncing`å­—æ®µæ›´æ–°å¤±è´¥ âŒ
5. å¯¼è‡´æ•°æ®åº“ä¸­ç•™ä¸‹ä¸ä¸€è‡´çš„è®°å½•

#### 2. **æ¯æ¬¡åŒæ­¥å¤±è´¥çš„çœŸå®åŸå› **

```python
# åœ¨ smart_sync_emails å‡½æ•°ä¸­
if sync_status.is_syncing:  # â† æ°¸è¿œä¸ºTrueï¼Œå› ä¸ºåƒµæ­»ä»»åŠ¡
    return SyncResponse(
        success=True,
        stats=sync_status.current_stats or {},  # â† ç©ºç»Ÿè®¡
        message="åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­",
        in_progress=True,
        progress_percentage=sync_status.progress_percentage,  # â† æ°¸è¿œ0%
        task_id=sync_status.task_id  # â† åƒµæ­»ä»»åŠ¡ID
    )
```

**ç»“æœ**ï¼š
- æ¯æ¬¡ç”¨æˆ·ç‚¹å‡»åŒæ­¥æ—¶ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°"å·²æœ‰åŒæ­¥ä»»åŠ¡åœ¨è¿›è¡Œ"
- è¿”å›åƒµæ­»ä»»åŠ¡çš„ä¿¡æ¯ï¼ˆå›ºå®šçš„é”™è¯¯ä¿¡æ¯ï¼‰
- å‰ç«¯è½®è¯¢å¾—åˆ°çš„æ°¸è¿œæ˜¯åŒæ ·çš„åƒµæ­»çŠ¶æ€
- ç”¨æˆ·æ— æ³•å¯åŠ¨æ–°çš„åŒæ­¥ä»»åŠ¡

#### 3. **é”™è¯¯ä¿¡æ¯çš„æ¥æº**

"ä»»åŠ¡è¢«ç®¡ç†å‘˜æ‰‹åŠ¨æ¸…ç†ï¼ˆä¿®å¤åï¼‰"è¿™ä¸ªé”™è¯¯ä¿¡æ¯ï¼š
- **ä¸æ˜¯ä»£ç è‡ªåŠ¨ç”Ÿæˆçš„**ï¼ˆä»£ç ä¸­æ²¡æœ‰è¿™ä¸ªå­—ç¬¦ä¸²ï¼‰
- **æ˜¯äººä¸ºæ‰‹åŠ¨è®¾ç½®çš„**ï¼ˆå¯èƒ½æ˜¯ä¹‹å‰çš„è°ƒè¯•æˆ–ä¿®å¤å°è¯•ï¼‰
- **è¯æ˜äº†æ›¾ç»æœ‰äººå°è¯•ä¿®å¤è¿™ä¸ªä»»åŠ¡ï¼Œä½†ä¿®å¤ä¸å®Œæ•´**

### å·²ä¿®å¤çš„ç›¸å…³é—®é¢˜
1. âœ… `execute_background_sync`å‡½æ•°å˜é‡ä½œç”¨åŸŸé—®é¢˜ï¼ˆ`sync_status`å˜é‡ï¼‰
2. âœ… `search_messages_paginated`è¿”å›å€¼tuple/dictç±»å‹é”™è¯¯
3. âœ… FastAPI BackgroundTaskså¼‚æ­¥å‡½æ•°æ‰§è¡Œé—®é¢˜

### éœ€è¦å½»åº•è§£å†³çš„é—®é¢˜
1. **ğŸ”¥ ç«‹å³ä¿®å¤æ•°æ®ä¸ä¸€è‡´é—®é¢˜**ï¼ˆPriority 0ï¼‰
2. **çŠ¶æ€ç®¡ç†åŸå­æ€§**ï¼šç¡®ä¿çŠ¶æ€æ›´æ–°æ“ä½œçš„åŸå­æ€§
3. **é˜²æŠ¤æœºåˆ¶**ï¼šé˜²æ­¢ç±»ä¼¼çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜å†æ¬¡å‘ç”Ÿ
4. **è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤**ï¼šå®ç°åƒµæ­»ä»»åŠ¡çš„è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤

## Solution

### ğŸš¨ Priority 0ï¼šç«‹å³ä¿®å¤ç°æœ‰æ•°æ®ä¸ä¸€è‡´é—®é¢˜

**ç«‹å³æ‰§è¡Œçš„SQLä¿®å¤**ï¼š
```sql
-- 1. ä¿®å¤åƒµæ­»ä»»åŠ¡çš„çŠ¶æ€ä¸ä¸€è‡´
UPDATE user_sync_status 
SET 
    is_syncing = FALSE,
    progress_percentage = 0,
    current_stats = '{}',
    updated_at = NOW()
WHERE 
    task_id = 'sync_60f2ccbd-d754-4fa0-aa4d-35a7d6551d38_1753133270'
    AND is_syncing = TRUE;

-- 2. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–åƒµæ­»ä»»åŠ¡
SELECT 
    user_id,
    task_id,
    is_syncing,
    error_message,
    started_at,
    updated_at,
    EXTRACT(EPOCH FROM (NOW() - updated_at))/60 as minutes_since_update
FROM user_sync_status 
WHERE 
    is_syncing = TRUE 
    AND started_at < NOW() - INTERVAL '30 minutes';

-- 3. æ‰¹é‡æ¸…ç†æ‰€æœ‰è¶…æ—¶çš„åƒµæ­»ä»»åŠ¡
UPDATE user_sync_status 
SET 
    is_syncing = FALSE,
    progress_percentage = 0,
    error_message = CONCAT(COALESCE(error_message, ''), ' - è‡ªåŠ¨æ¸…ç†è¶…æ—¶ä»»åŠ¡'),
    updated_at = NOW()
WHERE 
    is_syncing = TRUE 
    AND started_at < NOW() - INTERVAL '30 minutes';
```

### ğŸ† Priority 1ï¼šä¼ä¸šçº§æ•°æ®åº“çº¦æŸï¼ˆä¸“å®¶å»ºè®®ï¼‰

**é‡‡çº³æŠ€æœ¯ä¸“å®¶å»ºè®®ï¼Œåœ¨æ•°æ®åº“å±‚é¢é˜²æ­¢ä¸ä¸€è‡´çŠ¶æ€**ï¼š

1. **æ•°æ®ä¸€è‡´æ€§ç¡¬çº¦æŸ**
   ```sql
   -- â‘  è¿›åº¦ä¸åŒæ­¥çŠ¶æ€å¼ºä¸€è‡´æ€§çº¦æŸ
   ALTER TABLE user_sync_status
   ADD CONSTRAINT chk_sync_state_consistency
   CHECK (
       (is_syncing = TRUE  AND progress_percentage BETWEEN 0 AND 99)
    OR (is_syncing = FALSE AND progress_percentage IN (0, 100))
   );

   -- â‘¡ ç¡®ä¿æ¯ä¸ªç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ªè¿è¡Œä¸­çš„åŒæ­¥ä»»åŠ¡
   CREATE UNIQUE INDEX uniq_user_running_sync
   ON user_sync_status(user_id)
   WHERE is_syncing = TRUE;

   -- â‘¢ é˜²æ­¢ä»»åŠ¡IDé‡å¤
   CREATE UNIQUE INDEX uniq_task_id
   ON user_sync_status(task_id);
   ```

   **å¥½å¤„**ï¼š
   - **å†™å…¥é˜¶æ®µç›´æ¥æ‹’ç»"ä¸åˆæ³•çŠ¶æ€"**ï¼Œè€Œä¸æ˜¯äº‹åé è„šæœ¬æ¸…ç†
   - **æ•°æ®åº“å±‚é¢ä¿è¯ä¸€è‡´æ€§**ï¼Œæ— è®ºä»£ç å¦‚ä½•å˜åŒ–éƒ½ä¸ä¼šå‡ºç°ä¸ä¸€è‡´çŠ¶æ€
   - **å¼ºåˆ¶å•ä»»åŠ¡æ‰§è¡Œ**ï¼Œä»æ ¹æœ¬ä¸Šé˜²æ­¢å¹¶å‘å†²çª

2. **çº¦æŸéªŒè¯è„šæœ¬**
   ```sql
   -- éªŒè¯ç°æœ‰æ•°æ®æ˜¯å¦ç¬¦åˆçº¦æŸï¼ˆåœ¨æ·»åŠ çº¦æŸå‰è¿è¡Œï¼‰
   SELECT 
       user_id,
       task_id,
       is_syncing,
       progress_percentage,
       CASE 
           WHEN is_syncing = TRUE AND progress_percentage NOT BETWEEN 0 AND 99 
           THEN 'è¿›åº¦çŠ¶æ€ä¸ä¸€è‡´'
           WHEN is_syncing = FALSE AND progress_percentage NOT IN (0, 100)
           THEN 'å®ŒæˆçŠ¶æ€ä¸ä¸€è‡´'
           ELSE 'çŠ¶æ€æ­£å¸¸'
       END as status_check
   FROM user_sync_status
   WHERE NOT (
       (is_syncing = TRUE AND progress_percentage BETWEEN 0 AND 99)
       OR (is_syncing = FALSE AND progress_percentage IN (0, 100))
   );
   ```

### ğŸ¯ Priority 2ï¼šå¹‚ç­‰åŒæ­¥å¯åŠ¨æ¥å£ï¼ˆä¸“å®¶å»ºè®®ï¼‰

**é‡æ–°è®¾è®¡åŒæ­¥å¯åŠ¨é€»è¾‘ï¼Œé¿å…é‡å¤ä»»åŠ¡å’ŒçŠ¶æ€å†²çª**ï¼š

```python
def start_sync_idempotent(user_id: str, force_full: bool) -> str:
    """
    å¹‚ç­‰çš„åŒæ­¥å¯åŠ¨æ¥å£
    - å¦‚æœå­˜åœ¨æœ‰æ•ˆçš„è¿›è¡Œä¸­ä»»åŠ¡ï¼ˆ<30åˆ†é’Ÿï¼‰ï¼Œåˆ™å¤ç”¨ç°æœ‰task_id
    - å¦åˆ™ï¼Œæ¸…ç†æ—§çŠ¶æ€å¹¶åˆ›å»ºæ–°ä»»åŠ¡
    - ä½¿ç”¨è¡Œé”ä¿è¯å¹¶å‘å®‰å…¨
    """
    from datetime import datetime, timedelta
    import uuid
    
    with db.begin():
        # ä½¿ç”¨è¡Œé”è·å–ç”¨æˆ·åŒæ­¥çŠ¶æ€
        sync_status = db.query(UserSyncStatus).filter(
            UserSyncStatus.user_id == user_id
        ).with_for_update().first()

        now = datetime.utcnow()
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ‰æ•ˆçš„è¿›è¡Œä¸­ä»»åŠ¡
        if (sync_status and 
            sync_status.is_syncing and 
            sync_status.started_at and
            (now - sync_status.started_at) < timedelta(minutes=30)):
            
            logger.info(f"å¤ç”¨ç°æœ‰åŒæ­¥ä»»åŠ¡: {sync_status.task_id}", user_id=user_id)
            return sync_status.task_id  # å¤ç”¨è€ä»»åŠ¡ï¼Œé¿å…é‡å¤
        
        # åˆ›å»ºæ–°ä»»åŠ¡
        new_task_id = f"sync_{user_id}_{uuid.uuid4().hex[:8]}_{int(now.timestamp())}"
        
        if sync_status:
            # æ›´æ–°ç°æœ‰è®°å½•
            sync_status.task_id = new_task_id
            sync_status.is_syncing = True
            sync_status.sync_type = 'full' if force_full else 'incremental'
            sync_status.started_at = now
            sync_status.updated_at = now
            sync_status.progress_percentage = 0
            sync_status.current_stats = {}
            sync_status.error_message = None
        else:
            # åˆ›å»ºæ–°è®°å½•
            sync_status = UserSyncStatus(
                user_id=user_id,
                task_id=new_task_id,
                is_syncing=True,
                sync_type='full' if force_full else 'incremental',
                started_at=now,
                updated_at=now,
                progress_percentage=0,
                current_stats={}
            )
            db.add(sync_status)
        
        # äº‹åŠ¡æäº¤ï¼Œç¡®ä¿æ•°æ®åº“çŠ¶æ€å…ˆæ›´æ–°
        
    # äº‹åŠ¡æäº¤åå†å¼‚æ­¥å¯åŠ¨çœŸæ­£çš„åŒæ­¥é€»è¾‘
    logger.info(f"å¯åŠ¨æ–°åŒæ­¥ä»»åŠ¡: {new_task_id}", user_id=user_id, force_full=force_full)
    return new_task_id

# åœ¨APIä¸­ä½¿ç”¨
@router.post("/sync/smart", response_model=SyncResponse)
async def smart_sync_emails(
    force_full: bool = Query(default=False),
    background_tasks: BackgroundTasks = None,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
) -> SyncResponse:
    """æ”¹è¿›çš„æ™ºèƒ½åŒæ­¥API"""
    try:
        # ä½¿ç”¨å¹‚ç­‰å¯åŠ¨æ¥å£
        task_id = start_sync_idempotent(current_user.id, force_full)
        
        # å¯åŠ¨åå°ä»»åŠ¡
        if background_tasks:
            background_tasks.add_task(
                execute_background_sync_v2, current_user.id, force_full, task_id
            )
        
        return SyncResponse(
            success=True,
            stats={},
            message="åŒæ­¥ä»»åŠ¡å·²å¯åŠ¨",
            task_id=task_id,
            in_progress=True
        )
        
    except Exception as e:
        logger.error(f"å¯åŠ¨åŒæ­¥å¤±è´¥: {e}", user_id=current_user.id)
        raise HTTPException(status_code=400, detail=f"å¯åŠ¨åŒæ­¥å¤±è´¥: {str(e)}")
```

**ä¼˜åŠ¿**ï¼š
- **é˜²æ­¢é‡å¤ä»»åŠ¡**ï¼šç”¨æˆ·ç‹‚ç‚¹æŒ‰é’®ä¸ä¼šåˆ›å»ºå¤šä¸ªä»»åŠ¡
- **è‡ªåŠ¨ä»»åŠ¡å¤ç”¨**ï¼šæœ‰æ•ˆä»»åŠ¡ç›´æ¥å¤ç”¨ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **å¹¶å‘å®‰å…¨**ï¼šè¡Œé”ä¿è¯åªæœ‰ä¸€ä¸ªåˆ†æ”¯èƒ½å†™å…¥ `is_syncing=TRUE`
- **çŠ¶æ€æ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸä»»åŠ¡çŠ¶æ€

### ğŸ”„ Priority 3ï¼šåå°ä»»åŠ¡å¿ƒè·³æœºåˆ¶ï¼ˆä¸“å®¶å»ºè®®ï¼‰

**æ¯”è¶…æ—¶æ¸…ç†æ›´å¯é çš„æ´»è·ƒåº¦æ£€æµ‹**ï¼š

```python
async def execute_background_sync_v2(user_id: str, force_full: bool, task_id: str):
    """å¸¦å¿ƒè·³æœºåˆ¶çš„åå°åŒæ­¥æ‰§è¡Œå™¨"""
    from asyncio import create_task, sleep
    from datetime import datetime
    
    HEARTBEAT_INTERVAL = 15  # å¿ƒè·³é—´éš”15ç§’
    
    async def heartbeat_worker():
        """å¿ƒè·³å·¥ä½œçº¿ç¨‹"""
        while True:
            try:
                await sleep(HEARTBEAT_INTERVAL)
                
                # æ›´æ–°å¿ƒè·³æ—¶é—´æˆ³
                db = SessionLocal()
                try:
                    result = db.execute(
                        update(UserSyncStatus)
                        .where(UserSyncStatus.task_id == task_id)
                        .values(updated_at=datetime.utcnow())
                    )
                    db.commit()
                    
                    if result.rowcount == 0:
                        logger.warning(f"å¿ƒè·³æ›´æ–°å¤±è´¥ï¼Œä»»åŠ¡å¯èƒ½å·²è¢«æ¸…ç†: {task_id}")
                        break
                        
                except Exception as e:
                    logger.error(f"å¿ƒè·³æ›´æ–°å¼‚å¸¸: {e}", task_id=task_id)
                finally:
                    db.close()
                    
            except Exception as e:
                logger.error(f"å¿ƒè·³çº¿ç¨‹å¼‚å¸¸: {e}", task_id=task_id)
                break

    # å¯åŠ¨å¿ƒè·³ä»»åŠ¡
    heartbeat_task = create_task(heartbeat_worker())
    
    try:
        # æ‰§è¡Œå®é™…çš„åŒæ­¥é€»è¾‘
        await execute_actual_sync(user_id, force_full, task_id)
        
    except Exception as e:
        logger.error(f"åŒæ­¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {e}", task_id=task_id)
        raise
        
    finally:
        # ç¡®ä¿å¿ƒè·³ä»»åŠ¡è¢«å–æ¶ˆ
        heartbeat_task.cancel()
        try:
            await heartbeat_task
        except:
            pass
            
        # é‡Šæ”¾åŒæ­¥çŠ¶æ€
        release_sync_status_atomic(user_id, task_id)

async def execute_actual_sync(user_id: str, force_full: bool, task_id: str):
    """å®é™…æ‰§è¡ŒåŒæ­¥çš„æ ¸å¿ƒé€»è¾‘"""
    db = SessionLocal()
    try:
        user = db.query(User).filter(User.id == user_id).first()
        if not user:
            raise ValueError(f"ç”¨æˆ·ä¸å­˜åœ¨: {user_id}")
            
        # å®šä¹‰è¿›åº¦å›è°ƒ
        def progress_callback(progress_info):
            try:
                db.execute(
                    update(UserSyncStatus)
                    .where(UserSyncStatus.task_id == task_id)
                    .values(
                        progress_percentage=progress_info.get('progress_percentage', 0),
                        current_stats=progress_info.get('current_stats', {}),
                        updated_at=datetime.utcnow()
                    )
                )
                db.commit()
            except Exception as e:
                logger.error(f"è¿›åº¦æ›´æ–°å¤±è´¥: {e}", task_id=task_id)
        
        # æ‰§è¡Œæ™ºèƒ½åŒæ­¥
        result = await email_sync_service.smart_sync_user_emails(
            db, user, force_full, progress_callback=progress_callback
        )
        
        # æ ‡è®°å®Œæˆ
        db.execute(
            update(UserSyncStatus)
            .where(UserSyncStatus.task_id == task_id)
            .values(
                is_syncing=False,
                progress_percentage=100,
                current_stats=result,
                updated_at=datetime.utcnow()
            )
        )
        db.commit()
        
        logger.info(f"åŒæ­¥ä»»åŠ¡å®Œæˆ", task_id=task_id, stats=result)
        
    except Exception as e:
        # è®°å½•é”™è¯¯ä½†ä¸é‡Šæ”¾çŠ¶æ€ï¼ˆç”±finallyå—å¤„ç†ï¼‰
        logger.error(f"åŒæ­¥æ‰§è¡Œå¼‚å¸¸: {e}", task_id=task_id)
        raise
    finally:
        db.close()

def release_sync_status_atomic(user_id: str, task_id: str, error_message: str = None):
    """åŸå­æ€§é‡Šæ”¾åŒæ­¥çŠ¶æ€"""
    db = SessionLocal()
    try:
        with db.begin():
            updates = {
                'is_syncing': False,
                'updated_at': datetime.utcnow()
            }
            if error_message:
                updates['error_message'] = error_message
                updates['progress_percentage'] = 0  # é”™è¯¯æ—¶é‡ç½®è¿›åº¦
                
            db.execute(
                update(UserSyncStatus)
                .where(UserSyncStatus.task_id == task_id)
                .values(**updates)
            )
            
    except Exception as e:
        logger.error(f"çŠ¶æ€é‡Šæ”¾å¤±è´¥: {e}", task_id=task_id)
    finally:
        db.close()
```

**å¿ƒè·³æœºåˆ¶ä¼˜åŠ¿**ï¼š
- **ç²¾ç¡®æ£€æµ‹**ï¼š`updated_at` è¿ç»­ 2Ã—å¿ƒè·³å‘¨æœŸï¼ˆ30ç§’ï¼‰ä¸æ›´æ–°å³å¯è®¤å®šåƒµæ­»
- **æ¯”ç®€å•è¶…æ—¶æ›´å¯é **ï¼šä¸ä¾èµ– `started_at + 30min` åˆ¤å®š
- **å®æ—¶çŠ¶æ€**ï¼šå¯ä»¥æ£€æµ‹åˆ°çœŸæ­£çš„è¿›ç¨‹å´©æºƒæˆ–ç½‘ç»œé—®é¢˜
- **è‡ªåŠ¨æ¢å¤**ï¼šå¿ƒè·³å¤±è´¥ä¼šè‡ªåŠ¨ç»“æŸä»»åŠ¡

### ğŸ›¡ï¸ Priority 4ï¼šåƒµæ­»ä»»åŠ¡è‡ªåŠ¨æ¸…ç†ï¼ˆæ”¹è¿›ç‰ˆï¼‰

**åŸºäºå¿ƒè·³çš„æ›´ç²¾ç¡®æ¸…ç†ç­–ç•¥**ï¼š

```python
async def cleanup_zombie_tasks_v2():
    """åŸºäºå¿ƒè·³çš„åƒµæ­»ä»»åŠ¡æ¸…ç†"""
    HEARTBEAT_TIMEOUT = 60  # å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼ˆ2ä¸ªå¿ƒè·³å‘¨æœŸï¼‰
    
    db = SessionLocal()
    try:
        cutoff_time = datetime.utcnow() - timedelta(seconds=HEARTBEAT_TIMEOUT)
        
        # æŸ¥æ‰¾åƒµæ­»ä»»åŠ¡ï¼šæ­£åœ¨åŒæ­¥ä½†å¿ƒè·³è¶…æ—¶
        zombie_tasks = db.query(UserSyncStatus).filter(
            UserSyncStatus.is_syncing == True,
            UserSyncStatus.updated_at < cutoff_time
        ).all()
        
        for task in zombie_tasks:
            logger.warning(
                f"æ£€æµ‹åˆ°åƒµæ­»ä»»åŠ¡ï¼Œè‡ªåŠ¨æ¸…ç†: {task.task_id}",
                user_id=task.user_id,
                last_update=task.updated_at,
                minutes_silent=(datetime.utcnow() - task.updated_at).total_seconds() / 60
            )
            
            # åŸå­æ€§æ¸…ç†
            release_sync_status_atomic(
                task.user_id,
                task.task_id,
                f"ä»»åŠ¡å¿ƒè·³è¶…æ—¶ï¼Œè‡ªåŠ¨æ¸…ç†äº {datetime.utcnow()}"
            )
            
        if zombie_tasks:
            logger.info(f"è‡ªåŠ¨æ¸…ç†äº† {len(zombie_tasks)} ä¸ªåƒµæ­»ä»»åŠ¡")
            
        return len(zombie_tasks)
        
    except Exception as e:
        logger.error(f"åƒµæ­»ä»»åŠ¡æ¸…ç†å¤±è´¥: {e}")
        return 0
    finally:
        db.close()

# å®šæ—¶ä»»åŠ¡
@scheduler.scheduled_job('interval', minutes=2, id='zombie_task_cleaner_v2')
async def scheduled_zombie_cleanup():
    """æ¯2åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡åƒµæ­»ä»»åŠ¡"""
    cleaned_count = await cleanup_zombie_tasks_v2()
    if cleaned_count > 0:
        logger.info(f"å®šæ—¶æ¸…ç†å®Œæˆï¼Œæ¸…ç†äº† {cleaned_count} ä¸ªåƒµæ­»ä»»åŠ¡")
```

### ğŸ” Priority 5ï¼šå¥åº·æ£€æŸ¥å’Œç›‘æ§å¢å¼º

```python
@router.get("/sync/health")
async def sync_health_check_v2(db: Session = Depends(get_db)):
    """å¢å¼ºç‰ˆåŒæ­¥ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    try:
        now = datetime.utcnow()
        
        # ç»Ÿè®¡å„ç§çŠ¶æ€çš„ä»»åŠ¡
        total_users = db.query(UserSyncStatus).count()
        active_syncs = db.query(UserSyncStatus).filter(
            UserSyncStatus.is_syncing == True
        ).count()
        
        # æ£€æµ‹åƒµæ­»ä»»åŠ¡ï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰
        heartbeat_timeout = now - timedelta(seconds=60)
        zombie_tasks = db.query(UserSyncStatus).filter(
            UserSyncStatus.is_syncing == True,
            UserSyncStatus.updated_at < heartbeat_timeout
        ).all()
        
        # æ£€æµ‹æ•°æ®ä¸€è‡´æ€§é—®é¢˜
        inconsistent_tasks = db.query(UserSyncStatus).filter(
            ~(
                (UserSyncStatus.is_syncing == True) & 
                (UserSyncStatus.progress_percentage.between(0, 99))
                | 
                (UserSyncStatus.is_syncing == False) & 
                (UserSyncStatus.progress_percentage.in_([0, 100]))
            )
        ).count()
        
        # ç»Ÿè®¡æœ€è¿‘å®Œæˆçš„åŒæ­¥
        recent_cutoff = now - timedelta(hours=1)
        recent_syncs = db.query(UserSyncStatus).filter(
            UserSyncStatus.updated_at > recent_cutoff,
            UserSyncStatus.is_syncing == False,
            UserSyncStatus.progress_percentage == 100
        ).count()
        
        health_status = {
            "healthy": len(zombie_tasks) == 0 and inconsistent_tasks == 0,
            "timestamp": now.isoformat(),
            "statistics": {
                "total_users": total_users,
                "active_syncs": active_syncs,
                "zombie_tasks": len(zombie_tasks),
                "inconsistent_tasks": inconsistent_tasks,
                "recent_completed_syncs": recent_syncs
            },
            "zombie_task_details": [
                {
                    "task_id": task.task_id,
                    "user_id": str(task.user_id),
                    "started_at": task.started_at.isoformat() if task.started_at else None,
                    "last_update": task.updated_at.isoformat(),
                    "silent_minutes": int((now - task.updated_at).total_seconds() / 60)
                }
                for task in zombie_tasks[:5]  # åªæ˜¾ç¤ºå‰5ä¸ª
            ]
        }
        
        if not health_status["healthy"]:
            logger.warning("åŒæ­¥ç³»ç»Ÿå¥åº·æ£€æŸ¥å‘ç°é—®é¢˜", health_data=health_status)
            
        return health_status
        
    except Exception as e:
        error_response = {
            "healthy": False,
            "timestamp": datetime.utcnow().isoformat(),
            "error": str(e)
        }
        logger.error("å¥åº·æ£€æŸ¥æ‰§è¡Œå¤±è´¥", error_data=error_response)
        return error_response
```

## Tests

### æµ‹è¯•ç”¨ä¾‹1ï¼šæ•°æ®åº“çº¦æŸéªŒè¯
- å°è¯•æ’å…¥ä¸ä¸€è‡´çŠ¶æ€æ•°æ®
- éªŒè¯çº¦æŸæ­£ç¡®é˜»æ­¢æ’å…¥
- ç¡®è®¤é”™è¯¯ä¿¡æ¯æ¸…æ™°

### æµ‹è¯•ç”¨ä¾‹2ï¼šå¹‚ç­‰åŒæ­¥å¯åŠ¨
- è¿ç»­å¤šæ¬¡è°ƒç”¨åŒæ­¥æ¥å£
- éªŒè¯ä»»åŠ¡å¤ç”¨é€»è¾‘æ­£ç¡®
- ç¡®è®¤ä¸ä¼šåˆ›å»ºé‡å¤ä»»åŠ¡

### æµ‹è¯•ç”¨ä¾‹3ï¼šå¿ƒè·³æœºåˆ¶
- æ¨¡æ‹ŸåŒæ­¥è¿‡ç¨‹ä¸­çš„å¿ƒè·³æ›´æ–°
- æµ‹è¯•å¿ƒè·³ä¸­æ–­åçš„æ£€æµ‹
- éªŒè¯å¿ƒè·³è¶…æ—¶æ¸…ç†é€»è¾‘

### æµ‹è¯•ç”¨ä¾‹4ï¼šå¹¶å‘å®‰å…¨æ€§
- å¤šç”¨æˆ·åŒæ—¶å¯åŠ¨åŒæ­¥
- å•ç”¨æˆ·å¤šæ¬¡å¿«é€Ÿç‚¹å‡»
- éªŒè¯æ•°æ®åº“çº¦æŸå’Œè¡Œé”æœºåˆ¶

### æµ‹è¯•ç”¨ä¾‹5ï¼šåƒµæ­»ä»»åŠ¡æ¸…ç†
- åˆ›å»ºæ¨¡æ‹Ÿåƒµæ­»ä»»åŠ¡
- éªŒè¯è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- ç¡®è®¤æ¸…ç†åç³»ç»Ÿå¯æ­£å¸¸å·¥ä½œ

## å½“å‰çŠ¶æ€

### å·²å®Œæˆ
- âœ… è¯†åˆ«å¹¶è®°å½•äº†é—®é¢˜çš„å®Œæ•´è¡¨ç°
- âœ… ä¿®å¤äº†å·²çŸ¥çš„ä»£ç bug
- âœ… éªŒè¯äº†Gmail APIè¿æ¥æ­£å¸¸
- âœ… **ğŸ¯ å‘ç°äº†çœŸæ­£æ ¹å› ï¼šæ•°æ®ä¸€è‡´æ€§é—®é¢˜**
- âœ… **å®šä½äº†å…·ä½“çš„åƒµæ­»ä»»åŠ¡è®°å½•**
- âœ… **ğŸ† æ•´åˆäº†æŠ€æœ¯ä¸“å®¶çš„ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ**

### è¿›è¡Œä¸­
- ğŸ”„ å‡†å¤‡æ‰§è¡Œç«‹å³ä¿®å¤æ–¹æ¡ˆ

### å¾…è§£å†³
- âŒ **ğŸš¨ Priority 0**: ç«‹å³ä¿®å¤ç°æœ‰æ•°æ®ä¸ä¸€è‡´é—®é¢˜
- âŒ **ğŸ† Priority 1**: å®ç°æ•°æ®åº“ç¡¬çº¦æŸï¼ˆä¸“å®¶å»ºè®®ï¼‰
- âŒ **ğŸ¯ Priority 2**: å®ç°å¹‚ç­‰åŒæ­¥å¯åŠ¨æ¥å£ï¼ˆä¸“å®¶å»ºè®®ï¼‰
- âŒ **ğŸ”„ Priority 3**: å®ç°å¿ƒè·³æœºåˆ¶ï¼ˆä¸“å®¶å»ºè®®ï¼‰
- âŒ **ğŸ›¡ï¸ Priority 4**: å®ç°åŸºäºå¿ƒè·³çš„åƒµæ­»ä»»åŠ¡æ¸…ç†
- âŒ **ğŸ” Priority 5**: å®ç°å¢å¼ºç‰ˆå¥åº·æ£€æŸ¥å’Œç›‘æ§
- âŒ ç¡®ä¿é—®é¢˜ä¸å†å¤ç°

## ç´§æ€¥ç¨‹åº¦ï¼šCRITICAL
è¿™ä¸ªé—®é¢˜æ˜¯æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå½±å“æ‰€æœ‰ç”¨æˆ·çš„åŒæ­¥åŠŸèƒ½ã€‚å¿…é¡»ç«‹å³ä¿®å¤ç°æœ‰çš„æ•°æ®ä¸ä¸€è‡´çŠ¶æ€ï¼Œç„¶åå®æ–½é¢„é˜²æªæ–½ã€‚

## ä¿®å¤ç­–ç•¥

### ğŸš¨ ç«‹å³è¡ŒåŠ¨ï¼ˆPriority 0ï¼‰
1. **æ‰§è¡ŒSQLä¿®å¤è„šæœ¬**æ¸…ç†åƒµæ­»ä»»åŠ¡
2. **éªŒè¯ä¿®å¤æ•ˆæœ**ï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥æ­£å¸¸åŒæ­¥

### ğŸ† ä¼ä¸šçº§æ”¹é€ ï¼ˆPriority 1-3ï¼‰  
1. **å®ç°æ•°æ®åº“ç¡¬çº¦æŸ**ï¼ˆä¸“å®¶å»ºè®®ï¼‰- ä»æ ¹æœ¬ä¸Šé˜²æ­¢ä¸ä¸€è‡´
2. **é‡æ„å¹‚ç­‰åŒæ­¥æ¥å£**ï¼ˆä¸“å®¶å»ºè®®ï¼‰- é˜²æ­¢é‡å¤ä»»åŠ¡
3. **éƒ¨ç½²å¿ƒè·³ç›‘æ§æœºåˆ¶**ï¼ˆä¸“å®¶å»ºè®®ï¼‰- ç²¾ç¡®æ£€æµ‹æ´»è·ƒåº¦

### ğŸ›¡ï¸ é•¿æœŸç›‘æ§ï¼ˆPriority 4-5ï¼‰
1. **åŸºäºå¿ƒè·³çš„è‡ªåŠ¨æ¸…ç†**
2. **å…¨é¢å¥åº·æ£€æŸ¥ç³»ç»Ÿ**

## ğŸ–ï¸ ä¸“å®¶å»ºè®®è¯„ä¼°

æŠ€æœ¯ä¸“å®¶çš„å»ºè®®**éå¸¸ä¼˜ç§€**ï¼Œä½“ç°äº†ä¼ä¸šçº§ç³»ç»Ÿè®¾è®¡çš„æœ€ä½³å®è·µï¼š

### 1. **æ•°æ®åº“çº¦æŸ** - â­â­â­â­â­
- **æ ¹æœ¬æ€§è§£å†³**ï¼šä»æ•°æ®åº“å±‚é¢é˜²æ­¢ä¸ä¸€è‡´çŠ¶æ€
- **é˜²æ‚£äºæœªç„¶**ï¼šå†™å…¥æ—¶å°±æ‹’ç»éæ³•çŠ¶æ€
- **ç»´æŠ¤ç®€å•**ï¼šä¸ä¾èµ–ä»£ç é€»è¾‘ï¼Œæ•°æ®åº“è‡ªåŠ¨ä¿è¯

### 2. **å¹‚ç­‰æ¥å£** - â­â­â­â­â­  
- **ç”¨æˆ·ä½“éªŒä¼˜ç§€**ï¼šé˜²æ­¢é‡å¤ä»»åŠ¡ï¼Œæ”¯æŒä»»åŠ¡å¤ç”¨
- **å¹¶å‘å®‰å…¨**ï¼šè¡Œé”æœºåˆ¶å¯é 
- **é€»è¾‘æ¸…æ™°**ï¼šäº‹åŠ¡å†…çŠ¶æ€æ›´æ–°ï¼Œäº‹åŠ¡å¤–å¼‚æ­¥æ‰§è¡Œ

### 3. **å¿ƒè·³æœºåˆ¶** - â­â­â­â­â­
- **ç²¾ç¡®æ£€æµ‹**ï¼šæ¯”ç®€å•è¶…æ—¶åˆ¤æ–­æ›´å‡†ç¡®
- **å®æ—¶ç›‘æ§**ï¼šå¯ä»¥æ£€æµ‹çœŸæ­£çš„è¿›ç¨‹é—®é¢˜
- **è‡ªåŠ¨æ¢å¤**ï¼šç³»ç»Ÿå…·æœ‰è‡ªæ„ˆèƒ½åŠ›

**å¼ºçƒˆå»ºè®®é‡‡çº³æ‰€æœ‰ä¸“å®¶å»ºè®®ï¼è¿™äº›æ–¹æ¡ˆå°†ä½¿æˆ‘ä»¬çš„ç³»ç»Ÿå…·å¤‡ä¼ä¸šçº§çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚** ğŸ†