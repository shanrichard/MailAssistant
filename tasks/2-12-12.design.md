# Design 2-12-12 - Chaté¡µé¢å“åº”å¤„ç†å’Œå±•ç¤º

## Requirements

å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„Chaté¡µé¢ï¼Œç”¨äºç”¨æˆ·ä¸ConversationHandler Agentçš„äº¤äº’ã€‚é¡µé¢éœ€è¦ï¼š

1. **åŸºç¡€å¯¹è¯åŠŸèƒ½**
   - ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
   - æ˜¾ç¤ºAgentçš„å“åº”
   - æ”¯æŒå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿æŒ

2. **Agentæ€è€ƒè¿‡ç¨‹å¯è§†åŒ–**
   - å±•ç¤ºAgentçš„æ¨ç†è¿‡ç¨‹
   - æ˜¾ç¤ºå·¥å…·è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯
   - å·¥å…·æ‰§è¡Œç»“æœçš„å¯è§†åŒ–å±•ç¤º

3. **å®æ—¶äº¤äº’ä½“éªŒ**
   - æµå¼å“åº”å±•ç¤ºï¼ˆtokençº§åˆ«ï¼‰
   - åŠ è½½çŠ¶æ€æŒ‡ç¤º
   - é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

4. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
   - æ¶ˆæ¯æ—¶é—´æˆ³æ˜¾ç¤º
   - å¯æŠ˜å çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå·¥å…·è°ƒç”¨ç»†èŠ‚ï¼‰

## Solution

### æŠ€æœ¯é€‰å‹

1. **å‰ç«¯UIæ¡†æ¶**ï¼šä½¿ç”¨ LangGraph Agent Chat UI
   - åŸç”Ÿæ”¯æŒå·¥å…·è°ƒç”¨æ¸²æŸ“
   - ä¸LangGraphæ·±åº¦é›†æˆ
   - æ”¯æŒGenerative UI
   - Human-in-the-Loopæ”¯æŒ

2. **åç«¯æ¶æ„è°ƒæ•´**ï¼šè¿ç§»åˆ°LangGraph
   - ä»å½“å‰çš„LangChain Agentè¿ç§»åˆ°LangGraph
   - åˆ©ç”¨LangGraphçš„æµå¼ä¼ è¾“èƒ½åŠ›
   - æ›´å¥½çš„çŠ¶æ€ç®¡ç†å’ŒæŒä¹…åŒ–

### å®ç°æ–¹æ¡ˆ

#### 1. åç«¯ConversationHandlerè¿ç§»åˆ°LangGraph

```python
# backend/app/agents/conversation_handler.py
from langgraph.prebuilt import create_react_agent
from langgraph.graph import StateGraph, END
from typing import TypedDict, Annotated
from operator import add

class AgentState(TypedDict):
    messages: Annotated[list, add]
    user_id: str
    session_id: str

class ConversationHandler:
    def __init__(self, user_id: str, db_session):
        self.user_id = user_id
        self.db = db_session
        self.tools = self._create_tools()
        
        # åˆ›å»ºLangGraph agent
        self.agent = create_react_agent(
            model=self.llm,
            tools=self.tools,
            state_modifier=self._build_system_prompt()
        )
    
    async def stream_response(self, message: str, session_id: str):
        """æµå¼ä¼ è¾“å“åº”ï¼ŒåŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯"""
        initial_state = {
            "messages": [{"role": "user", "content": message}],
            "user_id": self.user_id,
            "session_id": session_id
        }
        
        # é…ç½®æµå¼ä¼ è¾“é€‰é¡¹
        config = {
            "configurable": {"thread_id": session_id},
            "stream_mode": "values",  # è·å–å®Œæ•´çŠ¶æ€æ›´æ–°
            "include_names": ["agent", "tools"]  # åŒ…å«å·¥å…·è°ƒç”¨
        }
        
        # æµå¼ä¼ è¾“äº‹ä»¶
        async for event in self.agent.astream_events(
            initial_state, 
            config=config,
            version="v2"
        ):
            yield self._format_stream_event(event)
    
    def _format_stream_event(self, event):
        """æ ¼å¼åŒ–æµå¼äº‹ä»¶ä¸ºå‰ç«¯å¯ç”¨æ ¼å¼"""
        if event["event"] == "on_chat_model_stream":
            # LLM tokenæµ
            return {
                "type": "agent_response_chunk",
                "content": event["data"]["chunk"].content,
                "timestamp": datetime.now().isoformat()
            }
        elif event["event"] == "on_tool_start":
            # å·¥å…·è°ƒç”¨å¼€å§‹
            return {
                "type": "tool_call_start",
                "tool_name": event["name"],
                "tool_args": event["data"]["input"],
                "timestamp": datetime.now().isoformat()
            }
        elif event["event"] == "on_tool_end":
            # å·¥å…·è°ƒç”¨ç»“æŸ
            return {
                "type": "tool_call_result",
                "tool_name": event["name"],
                "tool_result": event["data"]["output"],
                "timestamp": datetime.now().isoformat()
            }
```

#### 2. WebSocketæ¥å£å¢å¼º

```python
# backend/app/api/websocket.py
from socketio import AsyncServer
from langgraph.constants import Send

sio = AsyncServer(async_mode='asgi', cors_allowed_origins="*")

@sio.event
async def agent_message(sid, data):
    """å¤„ç†æ¥è‡ªå‰ç«¯çš„æ¶ˆæ¯"""
    user_id = await get_user_from_session(sid)
    message = data.get("message")
    session_id = data.get("session_id")
    
    # åˆ›å»ºConversationHandlerå®ä¾‹
    handler = ConversationHandler(user_id, db)
    
    # æµå¼ä¼ è¾“å“åº”
    async for event in handler.stream_response(message, session_id):
        await sio.emit("agent_event", event, room=sid)
```

#### 3. å‰ç«¯Chaté¡µé¢å®ç°

```tsx
// frontend/src/pages/Chat.tsx
import React, { useState, useRef, useEffect } from 'react';
import { AgentChatUI } from '@langchain/agent-chat-ui';
import useChatStore from '../stores/chatStore';
import { ChatMessage, ToolCall, AgentThought } from '../types';

const Chat: React.FC = () => {
  const { 
    messages, 
    isConnected, 
    sendMessage, 
    connectWebSocket 
  } = useChatStore();
  
  const [input, setInput] = useState('');
  const messagesEndRef = useRef<HTMLDivElement>(null);
  
  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };
  
  useEffect(() => {
    scrollToBottom();
  }, [messages]);
  
  // è¿æ¥WebSocket
  useEffect(() => {
    if (!isConnected) {
      connectWebSocket();
    }
  }, []);
  
  const handleSend = async () => {
    if (!input.trim()) return;
    
    await sendMessage(input);
    setInput('');
  };
  
  return (
    <div className="flex flex-col h-full">
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((message) => (
          <MessageItem key={message.id} message={message} />
        ))}
        <div ref={messagesEndRef} />
      </div>
      
      <div className="border-t p-4">
        <div className="flex space-x-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
            placeholder="è¾“å…¥æ¶ˆæ¯..."
            className="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button
            onClick={handleSend}
            disabled={!isConnected || !input.trim()}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
          >
            å‘é€
          </button>
        </div>
      </div>
    </div>
  );
};

// æ¶ˆæ¯é¡¹ç»„ä»¶
const MessageItem: React.FC<{ message: ChatMessage }> = ({ message }) => {
  switch (message.type) {
    case 'user':
      return <UserMessage message={message} />;
    case 'agent':
      return <AgentMessage message={message} />;
    case 'tool_call':
      return <ToolCallCard toolCall={message.toolCall!} />;
    case 'agent_thought':
      return <AgentThoughtCard thought={message.thought!} />;
    default:
      return null;
  }
};

// ç”¨æˆ·æ¶ˆæ¯ç»„ä»¶
const UserMessage: React.FC<{ message: ChatMessage }> = ({ message }) => (
  <div className="flex justify-end">
    <div className="max-w-[70%] bg-blue-600 text-white rounded-lg px-4 py-2">
      <p>{message.content}</p>
      <time className="text-xs text-blue-200">
        {new Date(message.timestamp).toLocaleTimeString()}
      </time>
    </div>
  </div>
);

// Agentæ¶ˆæ¯ç»„ä»¶
const AgentMessage: React.FC<{ message: ChatMessage }> = ({ message }) => (
  <div className="flex justify-start">
    <div className="max-w-[70%] bg-gray-100 rounded-lg px-4 py-2">
      <p className="text-gray-800">{message.content}</p>
      <time className="text-xs text-gray-500">
        {new Date(message.timestamp).toLocaleTimeString()}
      </time>
    </div>
  </div>
);

// å·¥å…·è°ƒç”¨å¡ç‰‡
const ToolCallCard: React.FC<{ toolCall: ToolCall }> = ({ toolCall }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  
  return (
    <div className="mx-8 my-2 bg-blue-50 border border-blue-200 rounded-lg p-3">
      <div 
        className="flex items-center justify-between cursor-pointer"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center space-x-2">
          <span className="text-lg">ğŸ”§</span>
          <span className="font-medium text-blue-800">
            {toolCall.status === 'running' ? 'æ­£åœ¨è°ƒç”¨' : 'å·²å®Œæˆ'}: {toolCall.name}
          </span>
        </div>
        <span className="text-gray-500">{isExpanded ? 'â–¼' : 'â–¶'}</span>
      </div>
      
      {isExpanded && (
        <div className="mt-3 space-y-2">
          <div>
            <p className="text-sm font-medium text-gray-600">å‚æ•°ï¼š</p>
            <pre className="mt-1 p-2 bg-white rounded text-xs overflow-x-auto">
              {JSON.stringify(toolCall.arguments, null, 2)}
            </pre>
          </div>
          {toolCall.result && (
            <div>
              <p className="text-sm font-medium text-gray-600">ç»“æœï¼š</p>
              <pre className="mt-1 p-2 bg-white rounded text-xs overflow-x-auto">
                {JSON.stringify(toolCall.result, null, 2)}
              </pre>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Agentæ€è€ƒè¿‡ç¨‹å¡ç‰‡
const AgentThoughtCard: React.FC<{ thought: AgentThought }> = ({ thought }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  
  return (
    <div className="mx-8 my-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
      <div 
        className="flex items-center justify-between cursor-pointer"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center space-x-2">
          <span className="text-lg">ğŸ¤”</span>
          <span className="font-medium text-yellow-800">Agentæ€è€ƒä¸­...</span>
        </div>
        <span className="text-gray-500">{isExpanded ? 'â–¼' : 'â–¶'}</span>
      </div>
      
      {isExpanded && (
        <div className="mt-2">
          <p className="text-sm text-gray-700">{thought.content}</p>
        </div>
      )}
    </div>
  );
};

export default Chat;
```

#### 4. ç±»å‹å®šä¹‰æ›´æ–°

```typescript
// frontend/src/types/index.ts
export interface ChatMessage {
  id: string;
  type: 'user' | 'agent' | 'tool_call' | 'agent_thought';
  content: string;
  timestamp: Date;
  toolCall?: ToolCall;
  thought?: AgentThought;
  isStreaming?: boolean;
}

export interface ToolCall {
  id: string;
  name: string;
  arguments: Record<string, any>;
  status: 'pending' | 'running' | 'completed' | 'failed';
  result?: any;
  error?: string;
}

export interface AgentThought {
  content: string;
  confidence?: number;
}

export interface WebSocketMessage {
  type: 'agent_response' | 'agent_response_chunk' | 'tool_call_start' | 
        'tool_call_result' | 'agent_thought' | 'error';
  content?: string;
  toolName?: string;
  toolArgs?: Record<string, any>;
  toolResult?: any;
  thought?: string;
  timestamp: Date;
}
```

### å®æ–½æ­¥éª¤

1. **åç«¯è¿ç§»åˆ°LangGraph**
   - ä¿®æ”¹ConversationHandlerä½¿ç”¨LangGraph
   - å®ç°æµå¼ä¼ è¾“æ¥å£
   - æ·»åŠ å·¥å…·è°ƒç”¨äº‹ä»¶æ ¼å¼åŒ–

2. **WebSocketæœåŠ¡å®ç°**
   - ä½¿ç”¨python-socketioå®ç°Socket.IOæœåŠ¡
   - é›†æˆåˆ°FastAPIåº”ç”¨
   - å¤„ç†è®¤è¯å’Œä¼šè¯ç®¡ç†

3. **å‰ç«¯Chaté¡µé¢å¼€å‘**
   - å®ç°åŸºç¡€å¯¹è¯ç•Œé¢
   - æ·»åŠ å·¥å…·è°ƒç”¨å¯è§†åŒ–ç»„ä»¶
   - å¤„ç†æµå¼å“åº”å’ŒçŠ¶æ€æ›´æ–°

4. **é›†æˆæµ‹è¯•**
   - æµ‹è¯•å¤šè½®å¯¹è¯
   - éªŒè¯å·¥å…·è°ƒç”¨å±•ç¤º
   - æ€§èƒ½å’Œé”™è¯¯å¤„ç†æµ‹è¯•

## Tests

### å•å…ƒæµ‹è¯•
- [ ] ConversationHandler LangGraphè¿ç§»æµ‹è¯•
- [ ] æµå¼äº‹ä»¶æ ¼å¼åŒ–æµ‹è¯•
- [ ] WebSocketè¿æ¥å’Œæ¶ˆæ¯å¤„ç†æµ‹è¯•
- [ ] å‰ç«¯ç»„ä»¶æ¸²æŸ“æµ‹è¯•
- [ ] æ¶ˆæ¯ç±»å‹å¤„ç†æµ‹è¯•

### åŠŸèƒ½æµ‹è¯•
- [ ] ç”¨æˆ·å‘é€æ¶ˆæ¯å¹¶æ¥æ”¶å“åº”
- [ ] Agentæ€è€ƒè¿‡ç¨‹å±•ç¤ºï¼ˆå¯æŠ˜å ï¼‰
- [ ] å·¥å…·è°ƒç”¨å®æ—¶å±•ç¤º
- [ ] å·¥å…·æ‰§è¡Œç»“æœå±•ç¤º
- [ ] æµå¼å“åº”é€å­—æ˜¾ç¤º
- [ ] è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
- [ ] è¿æ¥æ–­å¼€é‡è¿æœºåˆ¶

### é›†æˆæµ‹è¯•
- [ ] å®Œæ•´å¯¹è¯æµç¨‹æµ‹è¯•
- [ ] å¤šç§å·¥å…·è°ƒç”¨åœºæ™¯
- [ ] é”™è¯¯å¤„ç†å’Œæ¢å¤
- [ ] å¹¶å‘ç”¨æˆ·æµ‹è¯•
- [ ] é•¿æ—¶é—´å¯¹è¯ç¨³å®šæ€§

### ç”¨æˆ·ä½“éªŒæµ‹è¯•
- [ ] å“åº”æ—¶é—´ < 500msï¼ˆé¦–å­—èŠ‚ï¼‰
- [ ] æµç•…çš„æ‰“å­—æœºæ•ˆæœ
- [ ] æ¸…æ™°çš„çŠ¶æ€æŒ‡ç¤º
- [ ] ç›´è§‚çš„å·¥å…·è°ƒç”¨å±•ç¤º
- [ ] ç§»åŠ¨ç«¯é€‚é…