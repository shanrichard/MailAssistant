# Design 2-12-12 - Chaté¡µé¢å“åº”å¤„ç†å’Œå±•ç¤º

## Requirements

å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„Chaté¡µé¢ï¼Œç”¨äºç”¨æˆ·ä¸ConversationHandler Agentçš„äº¤äº’ã€‚é¡µé¢éœ€è¦ï¼š

1. **åŸºç¡€å¯¹è¯åŠŸèƒ½**
   - ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
   - æ˜¾ç¤ºAgentçš„å“åº”
   - æ”¯æŒå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿æŒ

2. **Agentæ€è€ƒè¿‡ç¨‹å¯è§†åŒ–**
   - å±•ç¤ºAgentçš„æ¨ç†è¿‡ç¨‹
   - æ˜¾ç¤ºå·¥å…·è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯
   - å·¥å…·æ‰§è¡Œç»“æœçš„å¯è§†åŒ–å±•ç¤º

3. **å®æ—¶äº¤äº’ä½“éªŒ**
   - æµå¼å“åº”å±•ç¤ºï¼ˆæ¶ˆæ¯çº§åˆ«ï¼‰
   - åŠ è½½çŠ¶æ€æŒ‡ç¤º
   - é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

4. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
   - æ¶ˆæ¯æ—¶é—´æˆ³æ˜¾ç¤º
   - å¯æŠ˜å çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå·¥å…·è°ƒç”¨ç»†èŠ‚ï¼‰

## Solution

### æŠ€æœ¯é€‰å‹

1. **å‰ç«¯UIæ¡†æ¶**ï¼šä½¿ç”¨ LangGraph Agent Chat UI
   - åŸç”Ÿæ”¯æŒå·¥å…·è°ƒç”¨æ¸²æŸ“
   - ä¸LangGraphæ·±åº¦é›†æˆ
   - æ”¯æŒGenerative UI
   - Human-in-the-Loopæ”¯æŒ

2. **åç«¯æ¶æ„è°ƒæ•´**ï¼šè¿ç§»åˆ°LangGraph
   - ä»å½“å‰çš„LangChain Agentè¿ç§»åˆ°LangGraph
   - åˆ©ç”¨LangGraphçš„æµå¼ä¼ è¾“èƒ½åŠ›
   - æ›´å¥½çš„çŠ¶æ€ç®¡ç†å’ŒæŒä¹…åŒ–

### å®ç°æ–¹æ¡ˆ

#### 1. åç«¯ConversationHandlerè¿ç§»åˆ°LangGraph

```python
# backend/app/agents/conversation_handler.py
from langgraph.prebuilt import create_react_agent
from langgraph.graph import StateGraph, END
from typing import TypedDict, Annotated
from operator import add

class AgentState(TypedDict):
    messages: Annotated[list, add]
    user_id: str
    session_id: str

class ConversationHandler:
    # ç±»çº§åˆ«ç¼“å­˜LLMå®ä¾‹ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
    _llm_cache = {}
    
    def __init__(self, user_id: str, db_session):
        self.user_id = user_id
        self.db = db_session
        self.tools = self._create_tools()
        
        # å¤ç”¨LLMå®ä¾‹
        if not self._llm_cache.get('llm'):
            self._llm_cache['llm'] = self._create_llm()
        
        # åˆ›å»ºLangGraph agent
        self.agent = create_react_agent(
            model=self._llm_cache['llm'],
            tools=self.tools,
            system_prompt=self._build_system_prompt()
        )
    
    async def stream_response(self, message: str, session_id: str):
        """æµå¼ä¼ è¾“å“åº”ï¼ŒåŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯"""
        # åŠ è½½å†å²å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆé™åˆ¶æœ€è¿‘20æ¡ï¼‰
        history_messages = await self._load_conversation_history(session_id, limit=20)
        
        initial_state = {
            "messages": history_messages + [{"role": "user", "content": message}],
            "user_id": self.user_id,
            "session_id": session_id
        }
        
        # é…ç½®æµå¼ä¼ è¾“é€‰é¡¹
        config = {
            "configurable": {"thread_id": f"{self.user_id}_{session_id}"},  # é¿å…ç”¨æˆ·é—´ä¸²è¯
            "stream_mode": "values",  # è·å–å®Œæ•´çŠ¶æ€æ›´æ–°
            "include_names": ["agent", "tools"]  # åŒ…å«å·¥å…·è°ƒç”¨
        }
        
        # æµå¼ä¼ è¾“äº‹ä»¶
        async for event in self.agent.astream_events(
            initial_state, 
            config=config,
            version="v2"
        ):
            yield self._format_stream_event(event)
    
    async def _load_conversation_history(self, session_id: str, limit: int = 20):
        """åŠ è½½å†å²å¯¹è¯ï¼Œé™åˆ¶æ¡æ•°é¿å…tokenè¶…é™"""
        # ä»æ•°æ®åº“æˆ–ç¼“å­˜åŠ è½½æœ€è¿‘çš„å¯¹è¯
        # å®ç°æ—¶éœ€è¦æŒ‰æ—¶é—´å€’åºï¼Œåªå–æœ€è¿‘çš„limitæ¡
        return []  # å®ç°ç»†èŠ‚çœç•¥
    
    def _format_stream_event(self, event):
        """æ ¼å¼åŒ–æµå¼äº‹ä»¶ä¸ºå‰ç«¯å¯ç”¨æ ¼å¼"""
        from datetime import datetime, timezone
        import uuid
        
        timestamp = datetime.now(timezone.utc).isoformat()
        # ç”Ÿæˆç¨³å®šçš„æ¶ˆæ¯IDï¼Œè€Œä¸ä¾èµ–run_id
        message_id = str(uuid.uuid4())
        
        if event["event"] == "on_chat_model_stream":
            # LLM tokenæµ
            return {
                "type": "agent_response_chunk",
                "content": event["data"]["chunk"].content,
                "timestamp": timestamp,
                "id": message_id
            }
        elif event["event"] == "on_tool_start":
            # å·¥å…·è°ƒç”¨å¼€å§‹
            return {
                "type": "tool_call_start",
                "tool_name": event["name"],
                "tool_args": event["data"]["input"],
                "timestamp": timestamp,
                "id": message_id
            }
        elif event["event"] == "on_tool_end":
            # å·¥å…·è°ƒç”¨ç»“æŸ
            return {
                "type": "tool_call_result",
                "tool_name": event["name"],
                "tool_result": event["data"]["output"],
                "timestamp": timestamp,
                "id": message_id
            }
        elif event["event"] == "on_tool_error":
            # å·¥å…·è°ƒç”¨é”™è¯¯
            return {
                "type": "tool_call_error",
                "tool_name": event["name"],
                "error": str(event["data"]),
                "timestamp": timestamp,
                "id": message_id
            }
        elif event["event"] == "on_chain_error":
            # é“¾æ‰§è¡Œé”™è¯¯
            return {
                "type": "agent_error",
                "error": str(event["data"]),
                "timestamp": timestamp
            }
```

#### 2. WebSocketæ¥å£å¢å¼º

```python
# backend/app/api/websocket.py
from socketio import AsyncServer
from langgraph.constants import Send

sio = AsyncServer(async_mode='asgi', cors_allowed_origins="*")

@sio.event
async def agent_message(sid, data):
    """å¤„ç†æ¥è‡ªå‰ç«¯çš„æ¶ˆæ¯"""
    user_id = await get_user_from_session(sid)
    message = data.get("message")
    session_id = data.get("session_id")
    
    # åˆ›å»ºConversationHandlerå®ä¾‹
    handler = ConversationHandler(user_id, db)
    
    # æµå¼ä¼ è¾“å“åº”
    async for event in handler.stream_response(message, session_id):
        await sio.emit("agent_event", event, room=sid)
```

#### 3. å‰ç«¯Chaté¡µé¢å®ç°

```tsx
// frontend/src/pages/Chat.tsx
import React, { useState, useRef, useEffect } from 'react';
import { AgentChatUI } from '@langchain/agent-chat-ui';
import useChatStore from '../stores/chatStore';
import { ChatMessage, ToolCall, AgentThought } from '../types';

const Chat: React.FC = () => {
  const { 
    messages, 
    isConnected, 
    sendMessage, 
    connectWebSocket 
  } = useChatStore();
  
  const [input, setInput] = useState('');
  const messagesEndRef = useRef<HTMLDivElement>(null);
  
  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };
  
  useEffect(() => {
    scrollToBottom();
  }, [messages]);
  
  // è¿æ¥WebSocket
  useEffect(() => {
    if (!isConnected) {
      connectWebSocket();
    }
  }, []);
  
  const handleSend = async () => {
    if (!input.trim()) return;
    
    await sendMessage(input);
    setInput('');
  };
  
  return (
    <div className="flex flex-col h-full">
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((message) => (
          <MessageItem key={message.id} message={message} />
        ))}
        <div ref={messagesEndRef} />
      </div>
      
      <div className="border-t p-4">
        <div className="flex space-x-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
            placeholder="è¾“å…¥æ¶ˆæ¯..."
            className="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button
            onClick={handleSend}
            disabled={!isConnected || !input.trim()}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
          >
            å‘é€
          </button>
        </div>
      </div>
    </div>
  );
};

// æ¶ˆæ¯é¡¹ç»„ä»¶
const MessageItem: React.FC<{ message: ChatMessage }> = ({ message }) => {
  switch (message.type) {
    case 'user':
      return <UserMessage message={message} />;
    case 'agent':
      return <AgentMessage message={message} />;
    case 'tool_call':
      return <ToolCallCard toolCall={message.toolCall!} />;
    case 'agent_thought':
      return <AgentThoughtCard thought={message.thought!} />;
    case 'error':
      return <ErrorMessage message={message} onRetry={message.onRetry} />;
    default:
      return null;
  }
};

// ç”¨æˆ·æ¶ˆæ¯ç»„ä»¶
const UserMessage: React.FC<{ message: ChatMessage }> = ({ message }) => (
  <div className="flex justify-end">
    <div className="max-w-[70%] bg-blue-600 text-white rounded-lg px-4 py-2">
      <p>{message.content}</p>
      <time className="text-xs text-blue-200">
        {new Date(message.timestamp).toLocaleTimeString()}
      </time>
    </div>
  </div>
);

// Agentæ¶ˆæ¯ç»„ä»¶
const AgentMessage: React.FC<{ message: ChatMessage }> = ({ message }) => (
  <div className="flex justify-start">
    <div className="max-w-[70%] bg-gray-100 rounded-lg px-4 py-2">
      <p className="text-gray-800">{message.content}</p>
      <time className="text-xs text-gray-500">
        {new Date(message.timestamp).toLocaleTimeString()}
      </time>
    </div>
  </div>
);

// å·¥å…·è°ƒç”¨å¡ç‰‡
const ToolCallCard: React.FC<{ toolCall: ToolCall }> = ({ toolCall }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  
  return (
    <div className="mx-8 my-2 bg-blue-50 border border-blue-200 rounded-lg p-3">
      <div 
        className="flex items-center justify-between cursor-pointer"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center space-x-2">
          <span className="text-lg">ğŸ”§</span>
          <span className="font-medium text-blue-800">
            {toolCall.status === 'running' ? 'æ­£åœ¨è°ƒç”¨' : 'å·²å®Œæˆ'}: {toolCall.name}
          </span>
        </div>
        <span className="text-gray-500">{isExpanded ? 'â–¼' : 'â–¶'}</span>
      </div>
      
      {isExpanded && (
        <div className="mt-3 space-y-2">
          <div>
            <p className="text-sm font-medium text-gray-600">å‚æ•°ï¼š</p>
            <pre className="mt-1 p-2 bg-white rounded text-xs overflow-x-auto">
              {JSON.stringify(toolCall.arguments, null, 2)}
            </pre>
          </div>
          {toolCall.result && (
            <div>
              <p className="text-sm font-medium text-gray-600">ç»“æœï¼š</p>
              <pre className="mt-1 p-2 bg-white rounded text-xs overflow-x-auto">
                {JSON.stringify(toolCall.result, null, 2)}
              </pre>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Agentæ€è€ƒè¿‡ç¨‹å¡ç‰‡
const AgentThoughtCard: React.FC<{ thought: AgentThought }> = ({ thought }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  
  return (
    <div className="mx-8 my-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
      <div 
        className="flex items-center justify-between cursor-pointer"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center space-x-2">
          <span className="text-lg">ğŸ¤”</span>
          <span className="font-medium text-yellow-800">Agentæ€è€ƒä¸­...</span>
        </div>
        <span className="text-gray-500">{isExpanded ? 'â–¼' : 'â–¶'}</span>
      </div>
      
      {isExpanded && (
        <div className="mt-2">
          <p className="text-sm text-gray-700">{thought.content}</p>
        </div>
      )}
    </div>
  );
};

// é”™è¯¯æ¶ˆæ¯ç»„ä»¶
const ErrorMessage: React.FC<{ message: ChatMessage; onRetry?: () => void }> = ({ message, onRetry }) => (
  <div className="mx-8 my-2 bg-red-50 border border-red-200 rounded-lg p-3">
    <div className="flex items-center justify-between">
      <div className="flex items-center space-x-2">
        <span className="text-lg">âŒ</span>
        <span className="text-red-800">{message.content}</span>
      </div>
      {onRetry && (
        <button
          onClick={onRetry}
          className="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
        >
          é‡è¯•
        </button>
      )}
    </div>
  </div>
);

export default Chat;
```

#### 4. ç±»å‹å®šä¹‰æ›´æ–°

```typescript
// frontend/src/types/index.ts
export interface ChatMessage {
  id: string;
  type: 'user' | 'agent' | 'tool_call' | 'agent_thought' | 'error';
  content: string;
  timestamp: Date;
  toolCall?: ToolCall;
  thought?: AgentThought;
  isStreaming?: boolean;
  onRetry?: () => void;  // é”™è¯¯é‡è¯•å›è°ƒ
}

export interface ToolCall {
  id: string;
  name: string;
  arguments: Record<string, any>;
  status: 'pending' | 'running' | 'completed' | 'failed';
  result?: any;
  error?: string;
}

export interface AgentThought {
  content: string;
  confidence?: number;
}

export interface WebSocketMessage {
  type: 'agent_response' | 'agent_response_chunk' | 'tool_call_start' | 
        'tool_call_result' | 'tool_call_error' | 'agent_thought' | 'agent_error';
  id?: string;  // æ¶ˆæ¯ID
  content?: string;
  toolName?: string;
  toolArgs?: Record<string, any>;
  toolResult?: any;
  thought?: string;
  error?: string;  // é”™è¯¯ä¿¡æ¯
  timestamp: Date;
}
```

### æ€§èƒ½ä¼˜åŒ–å’Œå®‰å…¨è€ƒè™‘

#### æ€§èƒ½ä¼˜åŒ–
1. **è™šæ‹Ÿæ»šåŠ¨**ï¼šé•¿å¯¹è¯ä½¿ç”¨ react-window å®ç°è™šæ‹Ÿæ»šåŠ¨
2. **æ¶ˆæ¯æ‰¹å¤„ç†**ï¼šæµå¼chunkåˆå¹¶ï¼Œé¿å…è¿‡å¤šrender
   ```typescript
   // åœ¨chatStoreä¸­ç»´æŠ¤streamingæ¶ˆæ¯
   if (message.type === 'agent_response_chunk') {
     const lastMsg = messages[messages.length - 1];
     if (lastMsg?.isStreaming) {
       // åˆå¹¶åˆ°ç°æœ‰æ¶ˆæ¯ï¼Œè€Œéåˆ›å»ºæ–°æ¶ˆæ¯
       updateMessage(lastMsg.id, { content: lastMsg.content + message.content });
     }
   }
   ```
3. **é˜²æŠ–å’ŒèŠ‚æµ**ï¼šè¾“å…¥æ¡†å’Œæ»šåŠ¨äº‹ä»¶ä¼˜åŒ–
4. **æ‡’åŠ è½½**ï¼šå·¥å…·è°ƒç”¨è¯¦æƒ…æŒ‰éœ€åŠ è½½

#### å®‰å…¨è€ƒè™‘
1. **XSSé˜²æŠ¤**ï¼šæ‰€æœ‰ç”¨æˆ·è¾“å…¥å’Œå·¥å…·ç»“æœè¿›è¡Œè½¬ä¹‰
2. **è®¤è¯å®‰å…¨**ï¼šJWT tokenéªŒè¯ï¼Œsessionéš”ç¦»
3. **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢æ»¥ç”¨ï¼Œæ¯ç”¨æˆ·æ¯åˆ†é’Ÿé™åˆ¶æ¶ˆæ¯æ•°
   ```python
   # ä½¿ç”¨Rediså®ç°ç®€å•çš„é€Ÿç‡é™åˆ¶
   async def check_rate_limit(user_id: str, limit: int = 20):
       key = f"rate_limit:{user_id}"
       count = await redis.incr(key)
       if count == 1:
           await redis.expire(key, 60)  # 60ç§’è¿‡æœŸ
       return count <= limit
   ```
4. **CORSé…ç½®**ï¼šç”Ÿäº§ç¯å¢ƒä¸¥æ ¼é™åˆ¶è·¨åŸŸ

### å®æ–½æƒ…å†µæ€»ç»“

æ‰€æœ‰ä¸‰ä¸ªé˜¶æ®µçš„åŠŸèƒ½å‡å·²å®ç°å®Œæˆï¼š

#### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å¯¹è¯åŠŸèƒ½ âœ… å·²å®Œæˆ

1. **åç«¯åŸºç¡€è¿ç§»**
   - âœ… ConversationHandlerå·²æˆåŠŸè¿ç§»åˆ°LangGraph
   - âœ… ä½¿ç”¨create_react_agentåˆ›å»ºagentï¼Œæ”¯æŒæç¤ºè¯å‚æ•°
   - âœ… å®ç°äº†checkpointerç¼“å­˜æœºåˆ¶å’ŒLLMå®ä¾‹ç¼“å­˜

2. **Socket.IOé›†æˆ**
   - âœ… åˆ›å»ºäº†backend/app/socketio_app.py
   - âœ… æˆåŠŸé›†æˆåˆ°FastAPIåº”ç”¨
   - âœ… å®ç°äº†agent_messageäº‹ä»¶å¤„ç†
   - âœ… JWT tokenè®¤è¯å’Œé€Ÿç‡é™åˆ¶

3. **å‰ç«¯åŸºç¡€Chaté¡µé¢**
   - âœ… å®ç°äº†Chat.tsxå®Œæ•´é¡µé¢
   - âœ… æ¶ˆæ¯å‘é€å’Œæ¥æ”¶åŠŸèƒ½æ­£å¸¸
   - âœ… ç”¨æˆ·æ¶ˆæ¯å’ŒAgentæ¶ˆæ¯ç»„ä»¶å®Œæˆ
   - âœ… WebSocketè¿æ¥çŠ¶æ€ç®¡ç†

#### ç¬¬äºŒé˜¶æ®µï¼šæµå¼å“åº”å®ç° âœ… å·²å®Œæˆ

1. **åç«¯æµå¼ä¼ è¾“**
   - âœ… å®ç°äº†stream_responseæ–¹æ³•ï¼ˆä½¿ç”¨astreamï¼‰
   - âœ… æ ¼å¼åŒ–agent_response_chunkç­‰äº‹ä»¶
   - âœ… Socket.IOå®æ—¶æ¨é€åŠŸèƒ½æ­£å¸¸

2. **å‰ç«¯æµå¼å±•ç¤º**
   - âœ… å¤„ç†agent_response_chunkäº‹ä»¶
   - âœ… æ¶ˆæ¯å®æ—¶æ›´æ–°ï¼ˆæ¶ˆæ¯çº§åˆ«æµå¼ï¼‰
   - âœ… isStreamingçŠ¶æ€ç®¡ç†

#### ç¬¬ä¸‰é˜¶æ®µï¼šå·¥å…·è°ƒç”¨å¯è§†åŒ– âœ… å·²å®Œæˆ

1. **åç«¯å·¥å…·è°ƒç”¨äº‹ä»¶**
   - âœ… å®Œå–„çš„äº‹ä»¶æ ¼å¼åŒ–ï¼ˆtool_call_start, tool_call_result, tool_errorï¼‰
   - âœ… å·¥å…·é”™è¯¯å¤„ç†æœºåˆ¶
   - âœ… äº‹ä»¶æ¨é€é¡ºåºæ­£ç¡®

2. **å‰ç«¯å¯è§†åŒ–ç»„ä»¶**
   - âœ… ToolCallCardç»„ä»¶å·²å®ç°
   - âœ… AgentThoughtCardç»„ä»¶å·²å®ç°
   - âœ… å¯æŠ˜å çš„è¯¦ç»†ä¿¡æ¯å±•ç¤º
   - âœ… é”™è¯¯æ¶ˆæ¯ç»„ä»¶ErrorMessage

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
   - âœ… æ—¶é—´æˆ³æ ¼å¼åŒ–æ˜¾ç¤º
   - âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
   - âœ… å“åº”å¼å¸ƒå±€æ”¯æŒ

### é¢å¤–å®ç°çš„åŠŸèƒ½

1. **æ¶ˆæ¯è£å‰ªæœºåˆ¶**
   - åŸºäºæ¶ˆæ¯æ•°é‡å’Œtokenæ•°é‡çš„æ™ºèƒ½è£å‰ª
   - å¯é€šè¿‡é…ç½®å¼€å…³æ§åˆ¶

2. **å·¥å…·é›†æˆ**
   - search_email_history - æœç´¢å†å²é‚®ä»¶
   - read_daily_report - è¯»å–é‚®ä»¶æ—¥æŠ¥
   - bulk_mark_read - æ‰¹é‡æ ‡è®°å·²è¯»
   - update_user_preferences - æ›´æ–°ç”¨æˆ·åå¥½
   - trigger_email_processor - è§¦å‘é‚®ä»¶å¤„ç†
   - get_task_status - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

3. **ç»Ÿä¸€é”™è¯¯å¤„ç†**
   - æ‰€æœ‰å·¥å…·éƒ½åŒ…è£…äº†é”™è¯¯å¤„ç†
   - ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯è½¬æ¢

### å¾…ä¼˜åŒ–é¡¹ç›®ï¼ˆéå¿…éœ€ï¼‰

1. **é…ç½®å¤–ç½®**
   - ç³»ç»Ÿæç¤ºè¯å¯è€ƒè™‘ç§»è‡³é…ç½®æ–‡ä»¶

2. **çœŸæ­£çš„tokençº§åˆ«æµå¼**
   - å½“å‰æ˜¯æ¶ˆæ¯çº§åˆ«æµå¼ï¼Œå¯ä¼˜åŒ–ä¸ºtokençº§åˆ«

3. **æµ‹è¯•è¦†ç›–**
   - è¡¥å……å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•


## Tests

### å•å…ƒæµ‹è¯•
- [x] ConversationHandler LangGraphè¿ç§»æµ‹è¯• âœ…
- [ ] æµå¼äº‹ä»¶æ ¼å¼åŒ–æµ‹è¯•
- [ ] WebSocketè¿æ¥å’Œæ¶ˆæ¯å¤„ç†æµ‹è¯•
- [ ] å‰ç«¯ç»„ä»¶æ¸²æŸ“æµ‹è¯•
- [ ] æ¶ˆæ¯ç±»å‹å¤„ç†æµ‹è¯•

### åŠŸèƒ½æµ‹è¯•
- [x] ç”¨æˆ·å‘é€æ¶ˆæ¯å¹¶æ¥æ”¶å“åº” âœ…
- [x] Agentæ€è€ƒè¿‡ç¨‹å±•ç¤ºï¼ˆå¯æŠ˜å ï¼‰âœ…
- [x] å·¥å…·è°ƒç”¨å®æ—¶å±•ç¤º âœ…
- [x] å·¥å…·æ‰§è¡Œç»“æœå±•ç¤º âœ…
- [x] æµå¼å“åº”æ˜¾ç¤ºï¼ˆæ¶ˆæ¯çº§åˆ«ï¼‰âœ…
- [x] è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯ âœ…
- [x] è¿æ¥æ–­å¼€é‡è¿æœºåˆ¶ âœ…

### é›†æˆæµ‹è¯•
- [x] å®Œæ•´å¯¹è¯æµç¨‹æµ‹è¯• âœ…
- [x] å¤šç§å·¥å…·è°ƒç”¨åœºæ™¯ âœ…
- [x] é”™è¯¯å¤„ç†å’Œæ¢å¤ âœ…
- [ ] å¹¶å‘ç”¨æˆ·æµ‹è¯•
- [ ] é•¿æ—¶é—´å¯¹è¯ç¨³å®šæ€§

### ç”¨æˆ·ä½“éªŒæµ‹è¯•
- [x] å“åº”æ—¶é—´å¿«é€Ÿ âœ…
- [x] æµç•…çš„æ¶ˆæ¯æ›´æ–° âœ…
- [x] æ¸…æ™°çš„çŠ¶æ€æŒ‡ç¤º âœ…
- [x] ç›´è§‚çš„å·¥å…·è°ƒç”¨å±•ç¤º âœ…
- [x] å“åº”å¼å¸ƒå±€æ”¯æŒ âœ…