# Design 3-11-4

确保自动清理调度器正确运行

## Requirements

### 问题描述
当前存在两个独立的调度器系统：
1. 主调度器 (`scheduler_app.py`) - 管理令牌刷新、日志清理
2. 清理调度器 (`scheduled_cleanup.py`) - 专门清理僵死任务

这导致：
- 系统复杂度增加
- 清理调度器可能没有正确启动
- 维护困难，容易出错

### 目标
- 将所有定时任务统一到主调度器
- 确保僵死任务清理每2分钟运行一次
- 简化系统架构

## Solution

### 1. 更新主调度器 `scheduler_app.py`
```python
async def setup_system_jobs():
    """设置系统级定时任务"""
    from .jobs import create_token_refresh_job, create_cleanup_job
    from ..services.heartbeat_sync_service import cleanup_zombie_tasks_by_heartbeat
    
    # 1. 令牌健康检查任务（每2小时）
    scheduler.add_job(
        create_token_refresh_job,
        'interval',
        hours=2,
        id='system_token_refresh',
        replace_existing=True,
        name='System Token Refresh Check'
    )
    
    # 2. 日志清理任务（每日凌晨2点）
    scheduler.add_job(
        create_cleanup_job,
        'cron',
        hour=2,
        minute=0,
        id='system_cleanup',
        replace_existing=True,
        name='System Cleanup Task'
    )
    
    # 3. 僵死任务清理（每2分钟） - 新增
    scheduler.add_job(
        cleanup_zombie_tasks_by_heartbeat,
        'interval',
        minutes=2,
        id='zombie_task_cleanup',
        replace_existing=True,
        name='Zombie Task Cleanup',
        max_instances=1,  # 防止重叠执行
        misfire_grace_time=60  # 错过执行时间1分钟内仍执行
    )
    
    logger.info("System jobs scheduled successfully, including zombie task cleanup")
```

### 2. 移除独立调度器启动
从 `main.py` 中移除：
```python
# 删除这些行
from .services.scheduled_cleanup import init_cleanup_scheduler
init_cleanup_scheduler()
```

### 3. 添加调度器监控API
```python
@router.get("/scheduler/status")
async def get_scheduler_status():
    """获取调度器状态和任务列表"""
    from ..scheduler.scheduler_app import get_scheduler_status, get_active_jobs
    
    return {
        "scheduler": get_scheduler_status(),
        "jobs": get_active_jobs(),
        "zombie_cleanup_job": next(
            (job for job in get_active_jobs() if job["id"] == "zombie_task_cleanup"),
            None
        )
    }
```

### 4. 改进清理函数日志
```python
async def cleanup_zombie_tasks_by_heartbeat():
    """基于心跳的僵死任务清理"""
    logger.info("Starting zombie task cleanup...")
    
    # ... 清理逻辑 ...
    
    logger.info(f"Zombie task cleanup completed. Cleaned {cleaned_count} tasks")
    
    # 返回清理结果供调度器记录
    return {"cleaned_count": cleaned_count, "timestamp": datetime.utcnow()}
```

## Tests

### 功能测试
1. **调度器启动验证**
   ```bash
   # 检查调度器状态
   curl http://localhost:8000/api/scheduler/status
   ```

2. **任务执行验证**
   - 创建一个僵死任务
   - 等待2分钟
   - 验证任务被清理
   - 检查清理日志

3. **并发安全测试**
   - 验证 max_instances=1 防止重复执行
   - 测试调度器重启后任务恢复

### 监控测试
- 通过API查看任务列表
- 验证 zombie_task_cleanup 任务存在
- 检查 next_run_time 正确更新

### 验收标准
- [ ] 僵死任务清理集成到主调度器
- [ ] 每2分钟执行一次清理
- [ ] 移除独立的清理调度器
- [ ] 调度器状态API正常工作
- [ ] 清理任务有详细日志输出