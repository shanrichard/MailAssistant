# Design 3-1 - 升级 ConversationHandler 到 LangGraph 0.5.3

## Requirements
- 升级 ConversationHandler 到 LangGraph 0.5.3 / LangChain-Core 0.3.x / Pydantic 2
- 修复 `state_modifier` 参数错误（conversation_handler.py 第 46 行）
- 利用新版本的流式特性和 checkpointer 功能
- 保持与现有前端接口的兼容性
- 最小化对现有代码的侵入性修改
- 提升流式响应性能和稳定性

## Solution

### 1. 依赖版本升级
更新 backend/requirements.txt：
```
# LLM & AI - 精确版本锁定
langchain==0.3.26
langchain-core==0.3.69
langgraph==0.5.3
langchain-openai==0.3.28
langchain-anthropic==0.3.0
langchain-google-genai==0.3.0
openai>=1.25.0  # LangChain 0.3.28 要求
```

### 2. ConversationHandler 重构

#### 2.1 导入路径更新
```python
from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.graph.message import add_messages
from typing import Sequence, Annotated
from langchain_core.messages import BaseMessage
```

#### 2.2 State 定义改进
```python
class AgentState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], add_messages]
    user_id: str
    session_id: str
```

#### 2.3 Agent 创建修改
```python
# 移除 state_modifier，改用 state_preprocessor
def _build_prompt(self, state: Dict, config: Dict) -> List[BaseMessage]:
    """构建包含系统提示的消息列表"""
    system_prompt = self._build_system_prompt_for_graph()
    return [SystemMessage(content=system_prompt)] + state.get("messages", [])

# 创建 agent 时的新方式
self.checkpointer = InMemorySaver()
self.graph_agent = create_react_agent(
    model=self._llm_cache['llm'],
    tools=self.tools,
    state_preprocessor=self._build_prompt,
    checkpointer=self.checkpointer
)
```

#### 2.4 流式响应优化
```python
async def stream_response(self, message: str, session_id: str):
    """新的流式响应实现"""
    try:
        # 构建输入状态（无需手动加载历史）
        input_state = {
            "messages": [HumanMessage(content=message)],
            "user_id": self.user_id,
            "session_id": session_id
        }
        
        # 使用 astream 替代 astream_events
        response_id = str(uuid.uuid4())
        async for chunk in self.graph_agent.astream(
            input_state,
            config={"configurable": {"thread_id": f"{self.user_id}_{session_id}"}},
            stream_mode="updates"
        ):
            # 处理消息更新
            if "agent" in chunk:
                for msg in chunk["agent"].get("messages", []):
                    if isinstance(msg, AIMessage):
                        yield {
                            "type": "agent_response_chunk",
                            "content": msg.content,
                            "timestamp": datetime.now(timezone.utc).isoformat(),
                            "id": response_id
                        }
            
            # 处理工具调用
            if "tools" in chunk:
                tool_calls = chunk["tools"]
                for tool_call in tool_calls:
                    yield {
                        "type": "tool_call_result",
                        "tool_name": tool_call.get("name"),
                        "tool_result": tool_call.get("output"),
                        "timestamp": datetime.now(timezone.utc).isoformat(),
                        "id": str(uuid.uuid4())
                    }
                    
    except Exception as e:
        yield {
            "type": "agent_error",
            "error": str(e),
            "timestamp": datetime.now(timezone.utc).isoformat()
        }
```

#### 2.5 历史管理简化
- 删除 `_load_conversation_history` 方法
- 依赖 checkpointer 自动管理对话历史
- 使用 `thread_id` 配置实现会话隔离

### 3. 工具错误处理改进
```python
def _safe_tool(fn):
    """包装工具函数，统一错误处理"""
    async def _run(*args, **kwargs):
        try:
            return await fn(*args, **kwargs)
        except Exception as e:
            return {"error": str(e), "tool": fn.__name__}
    return Tool(name=fn.__name__, func=_run, return_direct=False)
```

### 4. LLM 缓存优化
- 使用 `(provider, model, temperature)` 作为缓存键
- 支持多模型、多温度参数实例隔离

### 5. 兼容性保证
- 保持现有的流式事件格式不变
- 确保前端无需修改代码
- 向后兼容现有的 API 接口

### 6. 实施步骤
1. **环境准备**
   - 创建新的虚拟环境进行测试
   - 备份当前的 requirements.txt
   
2. **依赖升级**
   - 更新 requirements.txt 中的版本
   - 运行 `pip install --upgrade` 安装新版本
   - 使用 `pipdeptree` 检查依赖冲突
   
3. **代码修改**
   - 修改 conversation_handler.py
   - 删除废弃的方法和参数
   - 实现新的流式响应逻辑
   
4. **测试验证**
   - 运行单元测试
   - 手动测试前端集成
   - 性能基准测试
   
5. **文档更新**
   - 更新代码注释
   - 记录升级过程和注意事项

## Tests

### 单元测试
1. **test_agent_creation**: 验证 agent 能正确创建，无参数错误
2. **test_stream_response**: 测试流式响应功能，确保返回正确的事件格式
3. **test_tool_error_handling**: 验证工具错误时返回结构化错误信息
4. **test_conversation_persistence**: 检查对话历史是否通过 checkpointer 正确持久化
5. **test_multi_user_isolation**: 验证不同用户的对话不会串话
6. **test_llm_cache**: 测试 LLM 缓存的正确性

### 集成测试
1. **test_frontend_compatibility**: 确保流式事件格式与前端兼容
2. **test_tool_visualization**: 验证工具调用信息正确传递到前端
3. **test_performance**: 对比升级前后的响应速度

### 性能基准
- 流式响应首字节时间 < 100ms
- 工具调用开销 < 50ms
- 内存使用相比旧版本不增加超过 10%
- 并发 10 个用户时响应时间不超过 200ms

### CI 验证
- 添加最小可运行示例到 CI
- 运行 `pipdeptree -r -p pydantic` 确保无 v1 依赖
- 版本锁定后的依赖冲突检查
- 自动化回归测试