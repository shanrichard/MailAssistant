# Design 3-24 - 修复邮件搜索大小写敏感和改进 AI 提示词

## Requirements

### 背景
用户反馈：当询问"有什么来自google的邮件"时，ConversationHandler 在 sender 参数中放入 "google"，但由于以下原因查询失败：
1. 数据库中 sender 字段存储格式为 `"Google <no-reply@accounts.google.com>"`（注意首字母大写）
2. 当前查询使用的是大小写敏感的 `contains` 操作
3. AI 提示词没有充分说明 sender 参数的灵活性和处理无结果的情况

### 需求
1. **实现大小写不敏感的搜索**
   - 修改 `search_email_history` 函数中的 sender 查询逻辑
   - 使用 PostgreSQL 的大小写不敏感匹配

2. **改进 ConversationHandler 的提示词**
   - 指导 AI 理解 sender 参数可以是部分匹配（如公司名、域名、邮箱地址的一部分）
   - 指导 AI 在搜索无结果时提供有用的反馈（如建议尝试其他关键词、显示可能的发件人列表等）

## Solution

### 1. 修改 conversation_tools.py 的搜索逻辑

在 `search_email_history` 函数中，需要修改三处查询逻辑以支持大小写不敏感：

```python
# 位置：backend/app/agents/conversation_tools.py
# 行号：约48-57

# 1. 关键词搜索部分（第48-53行）
if query:
    query_builder = query_builder.filter(
        (Email.subject.ilike(f'%{query}%') |  # 使用 ilike 替代 contains
         Email.sender.ilike(f'%{query}%') | 
         Email.body_plain.ilike(f'%{query}%'))
    )

# 2. 发件人筛选部分（第56-57行）
if sender:
    query_builder = query_builder.filter(
        Email.sender.ilike(f'%{sender}%')  # 使用 ilike 进行大小写不敏感匹配
    )
```

注意：PostgreSQL 的 `ilike` 操作符是大小写不敏感的 LIKE，这是最简洁的解决方案。

### 2. 更新 ConversationHandler 的系统提示词

在 `_build_system_prompt_for_graph` 方法中（约第282-295行），更新发件人相关查询的指导：

```python
# 位置：backend/app/agents/conversation_handler.py
# 行号：约282-295

# 替换原有的"2. 发件人相关查询"部分
"""
2. 发件人相关查询：
   重要：数据库中 sender 字段存储的是完整格式，例如：
   - "Google <no-reply@accounts.google.com>"
   - "张三 <zhangsan@example.com>"
   - "Microsoft 帐户团队 <account-security-noreply@accountprotection.microsoft.com>"
   - "support@alphavantage.co"（有些只有邮箱地址）
   
   使用 sender 参数的示例：
   - "张三发的邮件" → 使用 sender="张三"
   - "google的邮件" → 使用 sender="google"（会匹配 "Google <...>"、"googlecloud@google.com" 等）
   - "微软的邮件" → 使用 sender="微软" 或 sender="microsoft"
   - "@gmail.com的邮件" → 使用 sender="gmail.com"
   - "最近有什么人给我发邮件" → 仅使用 days_back，不设置 sender，查看 sender_summary

   sender 参数特性：
   - 部分匹配：输入的文本会在整个 sender 字段中搜索
   - 大小写不敏感：google 能匹配 Google，microsoft 能匹配 Microsoft
   - 可以搜索：姓名（张三）、公司名（Google）、邮箱地址（gmail.com）、邮箱用户名（no-reply）

搜索无结果时的处理：
当邮件搜索返回0条结果时，请：
1. 告知用户没有找到符合条件的邮件
2. 重要：查看返回数据中的 sender_summary 字段，它包含最近邮件的发件人统计
3. 向用户展示 sender_summary 中的前几个发件人，让用户了解实际的发件人格式
4. 建议用户：
   - 如果搜索 "Microsoft"，可以试试 "微软" 或 "microsoft"
   - 如果搜索公司名没结果，可以试试域名如 "microsoft.com"
   - 查看 sender_summary 中的发件人，选择正确的关键词重试
   - 使用 query 参数进行全文搜索
"""
```

### 3. 实现细节说明

1. **为什么使用 ilike 而不是 func.lower()**
   - `ilike` 是 PostgreSQL 原生支持的大小写不敏感 LIKE 操作
   - 性能更好，代码更简洁
   - SQLAlchemy 直接支持，无需额外导入

2. **提示词改进要点**
   - 明确说明 sender 支持部分匹配和大小写不敏感
   - 提供具体的搜索示例
   - 重点强调无结果时的处理策略
   - 利用 sender_summary 提供有用信息

## Tests

### 1. 功能测试 - 大小写不敏感搜索

```python
# 测试文件：backend/tests/test_conversation_tools_search.py

def test_sender_case_insensitive_search():
    """测试发件人搜索的大小写不敏感性"""
    # 准备测试数据
    # 邮件1: sender = "Google <no-reply@accounts.google.com>"
    # 邮件2: sender = "googlecloud@google.com"
    # 邮件3: sender = "GOOGLE WORKSPACE <workspace@google.com>"
    
    # 测试1: 小写搜索
    result = search_email_history(sender="google")
    assert result["results_count"] == 3
    
    # 测试2: 大写搜索
    result = search_email_history(sender="GOOGLE")
    assert result["results_count"] == 3
    
    # 测试3: 混合大小写
    result = search_email_history(sender="GoOgLe")
    assert result["results_count"] == 3

def test_sender_partial_match():
    """测试发件人部分匹配"""
    # 测试域名匹配
    result = search_email_history(sender="gmail.com")
    assert all("gmail.com" in email["sender"].lower() for email in result["results"])
    
    # 测试姓名部分匹配
    result = search_email_history(sender="张")
    assert all("张" in email["sender"] for email in result["results"])
```

### 2. AI 行为测试

```python
# 测试文件：backend/tests/test_conversation_handler_prompts.py

async def test_ai_sender_search_behavior():
    """测试 AI 处理发件人搜索的行为"""
    handler = ConversationHandler(user_id=test_user_id, db_session=db)
    
    # 测试1: 自然语言查询
    response = await handler.process("有什么来自google的邮件")
    # 验证调用了正确的工具
    assert "search_email_history" in response
    assert 'sender="google"' in response or "sender='google'" in response
    
    # 测试2: 无结果时的处理
    response = await handler.process("有什么来自xyz123abc的邮件")
    # 验证 AI 提供了有用的建议
    assert "没有找到" in response
    assert "sender_summary" in response or "最近的发件人" in response

async def test_ai_search_suggestions():
    """测试 AI 在搜索无结果时的建议"""
    handler = ConversationHandler(user_id=test_user_id, db_session=db)
    
    # 模拟搜索无结果的情况
    response = await handler.process("找找Microsoft的邮件")
    if "没有找到" in response:
        # 验证建议内容
        assert any(suggestion in response for suggestion in [
            "尝试", "微软", "更短的关键词", "全文搜索", "最近的发件人"
        ])
```

### 3. 集成测试

```python
# 测试文件：backend/tests/test_email_search_integration.py

def test_full_search_flow():
    """测试完整的邮件搜索流程"""
    # 1. 插入测试数据
    test_emails = [
        {"sender": "Google <no-reply@accounts.google.com>", "subject": "Security alert"},
        {"sender": "Microsoft 365 <office365@microsoft.com>", "subject": "Subscription"},
        {"sender": "张三 <zhangsan@example.com>", "subject": "会议邀请"}
    ]
    
    # 2. 测试各种搜索场景
    scenarios = [
        ("google", 1),  # 小写公司名
        ("MICROSOFT", 1),  # 大写公司名
        ("@example.com", 1),  # 域名搜索
        ("张", 1),  # 中文部分匹配
    ]
    
    for search_term, expected_count in scenarios:
        result = search_email_history(sender=search_term)
        assert result["results_count"] == expected_count
```

### 4. 回归测试

```python
# 确保其他搜索功能不受影响

def test_other_search_parameters():
    """测试其他搜索参数仍然正常工作"""
    # 测试 query 参数（也应该是大小写不敏感的）
    result = search_email_history(query="security")
    assert result["results_count"] > 0
    
    # 测试时间范围
    result = search_email_history(days_back=7)
    assert all(email["received_at"] >= seven_days_ago for email in result["results"])
    
    # 测试组合查询
    result = search_email_history(
        sender="google",
        days_back=30,
        is_read=False
    )
    # 验证所有条件都被应用
    for email in result["results"]:
        assert "google" in email["sender"].lower()
        assert not email["is_read"]
        assert email["received_at"] >= thirty_days_ago
```

### 5. 性能测试

```python
def test_search_performance():
    """测试使用 ilike 后的查询性能"""
    import time
    
    # 测试大数据集下的搜索性能
    start = time.time()
    result = search_email_history(sender="google", limit=100)
    elapsed = time.time() - start
    
    # 确保查询在合理时间内完成（<1秒）
    assert elapsed < 1.0
    assert result["status"] == "success"
```