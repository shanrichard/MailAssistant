# Design 3-11-1

修复异步函数中的同步阻塞调用

## Requirements

### 问题描述
在 `email_sync_service.py` 的 `_full_sync_with_pagination` 方法（异步函数）中使用了 `time.sleep(wait_time)`，这会阻塞整个事件循环，导致：
- 心跳线程无法更新
- 其他异步任务无法执行
- 系统看起来像"僵死"了

### 影响范围
- 文件：`backend/app/services/email_sync_service.py`
- 行号：约298行
- 函数：`_full_sync_with_pagination`

## Solution

### 代码修改
```python
# 修改前（第298行）：
time.sleep(wait_time)

# 修改后：
await asyncio.sleep(wait_time)
```

### 额外检查
需要检查整个文件中是否还有其他同步阻塞调用：
1. 搜索所有 `time.sleep` 调用
2. 检查是否有同步的 I/O 操作
3. 确保所有网络请求都是异步的

### 导入检查
确保文件顶部导入了 asyncio：
```python
import asyncio
```

## Tests

### 单元测试
- 模拟重试场景，验证不会阻塞事件循环
- 使用 pytest-asyncio 测试异步行为

### 集成测试
- 启动同步任务，监控心跳更新
- 验证并发任务能正常执行
- 检查日志中的心跳时间戳

### 验收标准
- [ ] 所有 `time.sleep` 替换为 `await asyncio.sleep`
- [ ] 同步过程中心跳正常更新（15秒间隔）
- [ ] 不再出现事件循环阻塞