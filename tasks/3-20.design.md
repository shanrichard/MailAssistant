# Design 3-20 - 重构邮件分析架构：移除预分析机制

## Requirements

### 背景
当前系统设计存在根本性问题：
1. Email 表中的 category 和 importance_score 字段从未被更新
2. EmailAnalysis 表存储预分析结果，但违背了"基于 LLM 的 Agent 架构"原则
3. 预设的分类和评分限制了系统的灵活性和个性化能力

### 目标
- 移除所有预分析机制，采用基于用户偏好的实时分析
- 简化数据模型，只存储原始邮件数据
- 让 Agent 每次都根据用户偏好动态分析邮件
- 实现真正的"完全基于 LLM 的 Agent 架构"

### 具体需求
1. 移除 Email 表的 category 和 importance_score 字段
2. 移除 EmailAnalysis 表及相关模型
3. 删除 analyze_email 和 batch_analyze_emails 工具
4. 修改 search_email_history，移除 importance_min 和 category 参数
5. 重构 generate_daily_report，实现基于用户偏好的实时分析
6. 确保所有相关代码都能正常工作

## Solution

### 1. 数据库迁移
创建新的迁移脚本：
- 删除 Email 表的 category 和 importance_score 列
- 删除 email_analyses 表
- 更新相关索引

### 2. 模型层修改
- 更新 Email 模型，移除相关字段和关系
- 删除 EmailAnalysis 模型文件
- 删除 UserPreference 模型文件（过度设计，使用 User.preferences_text 即可）
- 更新 models/__init__.py，移除 EmailAnalysis 和 UserPreference 导入
- 更新 User 模型，移除 email_analyses 和 preferences 关系

### 3. 实施顺序（重要）
由于存在依赖关系，必须按以下顺序执行：

#### 第一步：3-20-5 重构偏好系统
- 实现 get_user_preferences 工具
- 更新 update_user_preferences 工具
- 删除 UserPreference 模型和表
- **必须先完成**：因为 generate_daily_report 依赖 UserPreference

#### 第二步：3-20-3 清理 email_tools.py
- 删除 analyze_email 函数
- 删除 batch_analyze_emails 函数
- **删除 generate_daily_report 函数** - 让 EmailProcessorAgent 自主生成日报
- **依赖**：需要先完成偏好系统重构

#### 第三步：3-20-4 修改 search_email_history
- 移除 importance_min 参数
- 移除 category 参数
- 移除相关的查询逻辑
- **注意**：确保 Email 表的相关字段已被删除

#### 第四步：3-20-6 重构 EmailProcessorAgent
- 实现 Agent 自主生成日报的逻辑
- **依赖**：需要 generate_daily_report 已被删除

#### 第五步：3-20-7 最终清理和测试
- 清理所有 EmailAnalysis 引用
- 运行完整测试套件

### 4. EmailProcessorAgent 工作流程重构
EmailProcessorAgent 收到"生成日报"请求后，应该：
1. 调用工具获取用户偏好
2. 调用工具查询指定日期的邮件
3. 基于用户偏好，使用 LLM 分析邮件的重要性和分类
4. 生成结构化的日报数据
5. 保存到 DailyReportLog 表

这样实现真正的"基于 LLM 的 Agent 架构"，而不是依赖预定义的工具逻辑。

### 5. 清理引用
- 检查并清理所有对 EmailAnalysis 的引用
- 更新 migrations/env.py
- 检查前端代码是否使用了这些字段

### 6. 新的工作流程
```
用户访问日报页面 → 前端调用 /api/agents/email-processor
                ↓
EmailProcessorAgent 接收"生成日报"请求
                ↓
Agent 自主执行：
1. 调用 get_user_preferences 获取偏好
2. 调用 search_email_history 获取当天邮件  
3. 基于偏好用 LLM 分析邮件
4. 生成结构化日报
5. 保存到 DailyReportLog
                ↓
返回日报数据给前端展示
```

### 7. 工具需求
EmailProcessorAgent 需要的基础工具：
- `sync_emails` - 同步邮件（保留）
- `get_user_preferences` - 获取用户偏好（需要确保存在）
- `search_email_history` - 搜索邮件（已存在，需要清理参数）
- 不需要 `generate_daily_report` - Agent 自己实现逻辑

## Tests

### 1. 数据库迁移测试
- 确保迁移脚本能正确执行
- 验证 category 和 importance_score 字段已被删除
- 验证 email_analyses 表已被删除

### 2. 功能测试
- 测试邮件同步功能正常工作
- 测试日报生成能正确分析邮件（基于实时分析）
- 测试邮件搜索功能（不依赖 category 和 importance_min）

### 3. API 测试
- 确保所有 API 端点正常工作
- 验证没有任何端点返回已删除的字段

### 4. 前端集成测试
- 确认前端不依赖已删除的字段
- 验证聊天功能正常工作