# Design 3-25-1: 修复JWT错误信息泄露

## Requirements

修复OAuth认证回调失败时在生产环境中泄露敏感调试信息的安全漏洞。

### 问题描述
- 当前在`backend/app/api/auth.py:127-133`中，OAuth回调失败时返回详细的错误信息
- 包含`session_id`、`error_type`、完整错误信息等敏感调试数据
- 在生产环境中会暴露系统内部信息，帮助攻击者进行更精准的攻击

### 修复目标
- 在生产环境中只返回通用的错误信息
- 在开发环境中保留详细的调试信息
- 不破坏前端现有的错误处理逻辑
- 保持日志记录的完整性

## Solution

### 技术方案

#### 1. 修改错误处理逻辑
在`backend/app/api/auth.py`的`google_oauth_callback`函数中修改异常处理：

```python
except Exception as e:
    logger.error("Google OAuth callback failed", 
                error=str(e),
                error_type=type(e).__name__,
                authorization_response=request.authorization_response,
                session_id=request.session_id)
    
    # 根据环境决定错误详情
    if settings.environment == "development":
        error_detail = {
            "error": str(e),
            "error_type": type(e).__name__,
            "session_id": request.session_id,
            "message": f"Authentication failed: {str(e)}"
        }
    else:
        # 生产环境只返回通用错误信息
        error_detail = {
            "message": "Authentication failed. Please try again.",
            "error_code": "AUTH_ERROR"
        }
    
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail=error_detail
    )
```

#### 2. 前端兼容性分析
前端代码在`frontend/src/services/authService.ts:32-36`已经有完善的错误处理：
- 能处理对象类型和字符串类型的错误详情
- 有降级处理机制，当详细信息不可用时使用通用错误信息
- 不依赖特定的错误字段结构

#### 3. 日志保留
关键修改：
- 日志记录保持不变，完整记录所有调试信息
- 只修改返回给客户端的错误响应
- 运维人员仍能通过日志获取完整的错误信息

### 实施步骤

1. **导入配置模块**
   ```python
   from ..core.config import settings
   ```

2. **修改异常处理块**
   - 保持现有日志记录不变
   - 添加环境判断逻辑
   - 根据环境返回不同详细程度的错误信息

3. **测试验证**
   - 开发环境：确保返回详细错误信息
   - 生产环境：确保只返回通用错误信息
   - 前端：确保错误处理逻辑正常工作

### 影响分析

#### 正面影响
- 消除生产环境中的敏感信息泄露风险
- 提高系统安全性
- 符合安全最佳实践

#### 潜在风险
- 无，前端已有完善的错误处理逻辑
- 开发环境保持原有调试体验
- 日志完整性不受影响

#### 兼容性保证
- API接口保持向后兼容
- 前端代码无需修改
- 开发调试体验不受影响

## Tests

### 单元测试

```python
# test_auth_error_handling.py
import pytest
from fastapi.testclient import TestClient
from backend.app.main import app
from backend.app.core.config import settings

def test_oauth_error_production_mode():
    """测试生产环境下OAuth错误不泄露敏感信息"""
    # 临时设置为生产环境
    original_env = settings.environment
    settings.environment = "production"
    
    try:
        client = TestClient(app)
        response = client.post(
            "/api/auth/google",
            json={
                "authorization_response": "invalid_response",
                "session_id": "test_session"
            }
        )
        
        assert response.status_code == 400
        error_detail = response.json()["detail"]
        
        # 确保生产环境不返回敏感信息
        assert "session_id" not in error_detail
        assert "error_type" not in error_detail
        assert "error" not in error_detail
        assert error_detail["message"] == "Authentication failed. Please try again."
        assert error_detail.get("error_code") == "AUTH_ERROR"
        
    finally:
        settings.environment = original_env

def test_oauth_error_development_mode():
    """测试开发环境下OAuth错误返回详细信息"""
    original_env = settings.environment
    settings.environment = "development"
    
    try:
        client = TestClient(app)
        response = client.post(
            "/api/auth/google",
            json={
                "authorization_response": "invalid_response", 
                "session_id": "test_session"
            }
        )
        
        assert response.status_code == 400
        error_detail = response.json()["detail"]
        
        # 开发环境应该包含详细信息
        assert "session_id" in error_detail
        assert "error_type" in error_detail
        assert "error" in error_detail
        assert error_detail["session_id"] == "test_session"
        
    finally:
        settings.environment = original_env

def test_logging_completeness():
    """测试日志记录的完整性"""
    # 使用日志捕获来验证所有调试信息都被记录
    import logging
    
    with pytest.LoggingCapture() as log_capture:
        client = TestClient(app)
        response = client.post(
            "/api/auth/google",
            json={
                "authorization_response": "invalid_response",
                "session_id": "test_session"
            }
        )
        
        # 验证日志包含所有必要信息
        log_records = log_capture.records
        error_log = next((r for r in log_records if "Google OAuth callback failed" in r.getMessage()), None)
        
        assert error_log is not None
        assert "session_id" in str(error_log)
        assert "error_type" in str(error_log)
```

### 集成测试

```python
def test_frontend_error_handling_compatibility():
    """测试前端错误处理兼容性"""
    # 模拟前端错误处理逻辑
    def simulate_frontend_error_handling(response_data):
        """模拟frontend/src/services/authService.ts的错误处理逻辑"""
        error_message = 'Authentication failed'
        
        if response_data.get("detail"):
            detail = response_data["detail"]
            if isinstance(detail, dict):
                error_message = detail.get("message") or detail.get("error") or error_message
            elif isinstance(detail, str):
                error_message = detail
        
        return error_message
    
    # 测试生产环境响应
    settings.environment = "production"
    client = TestClient(app)
    response = client.post("/api/auth/google", json={"authorization_response": "invalid", "session_id": "test"})
    
    frontend_message = simulate_frontend_error_handling(response.json())
    assert frontend_message == "Authentication failed. Please try again."
    
    # 测试开发环境响应
    settings.environment = "development" 
    response = client.post("/api/auth/google", json={"authorization_response": "invalid", "session_id": "test"})
    
    frontend_message = simulate_frontend_error_handling(response.json())
    assert "Authentication failed:" in frontend_message
```

### 安全测试

```python
def test_information_disclosure_prevention():
    """测试信息泄露防护"""
    settings.environment = "production"
    client = TestClient(app)
    
    # 尝试各种无效输入
    test_cases = [
        {"authorization_response": "", "session_id": "test"},
        {"authorization_response": "malformed_url", "session_id": "sensitive_session_123"},
        {"authorization_response": "http://evil.com/callback", "session_id": "internal_session_data"},
    ]
    
    for test_case in test_cases:
        response = client.post("/api/auth/google", json=test_case)
        assert response.status_code == 400
        
        error_detail = response.json()["detail"]
        
        # 确保没有泄露任何输入数据
        assert test_case["session_id"] not in str(error_detail)
        assert test_case["authorization_response"] not in str(error_detail)
        
        # 确保只返回通用错误
        assert error_detail["message"] == "Authentication failed. Please try again."
        assert error_detail.get("error_code") == "AUTH_ERROR"
```

### 性能测试

```python
def test_error_handling_performance():
    """确保错误处理不影响性能"""
    import time
    
    client = TestClient(app)
    
    start_time = time.time()
    for _ in range(10):
        response = client.post(
            "/api/auth/google", 
            json={"authorization_response": "invalid", "session_id": "test"}
        )
        assert response.status_code == 400
    
    end_time = time.time()
    
    # 确保10次错误处理在合理时间内完成（例如1秒）
    assert (end_time - start_time) < 1.0
```

### 测试覆盖要求

- **功能测试**: 验证生产/开发环境不同行为
- **兼容性测试**: 确保前端错误处理正常
- **安全测试**: 验证敏感信息不泄露
- **性能测试**: 确保修复不影响性能
- **回归测试**: 确保现有功能正常

所有测试必须通过才能认为此安全修复完成。