# Design 4 - 生产环境部署配置

本任务将MailAssistant项目部署到生产环境：后端部署到Railway，前端部署到Vercel。

## Requirements

需要为MailAssistant项目配置生产环境部署，具体要求如下：

### 后端部署（Railway）
- 配置Railway部署所需的文件和配置
- 设置生产环境的环境变量
- 配置PostgreSQL数据库连接
- 设置正确的CORS配置以支持Vercel前端
- 配置健康检查和启动脚本
- 处理Socket.IO和WebSocket在生产环境的配置

### 前端部署（Vercel）
- 配置Vercel部署文件
- 设置前端环境变量，指向Railway后端URL
- 配置构建和输出设置
- 设置正确的路由重写规则
- 处理静态资源和SPA路由

### 环境变量管理
- 生产环境环境变量清单
- 安全配置要求（密钥生成等）
- 数据库和API密钥配置指南
- CORS和认证回调URL配置

### 部署文档
- 详细的部署步骤说明
- 环境变量配置指南
- 故障排除和监控建议
- 生产环境与开发环境的差异说明

### 安全考虑
- 生产环境关闭调试模式
- 正确的CORS配置
- 环境变量安全管理
- SSL/HTTPS配置要求

## Solution

### 1. Railway后端部署配置

**1.1 创建Railway配置文件**
- 创建 `railway.json` 配置文件，指定Python版本和构建脚本
- 创建 `Procfile` 指定启动命令
- 创建 `runtime.txt` 指定Python版本

**1.2 生产启动脚本**
- 修改 `start_backend.py` 支持生产环境
- 使用Gunicorn作为WSGI服务器，支持并发和稳定性
- 配置日志和错误处理

**1.3 数据库迁移脚本**
- 创建自动化数据库迁移脚本
- 在启动时自动运行Alembic迁移

**1.4 CORS和Socket.IO配置**
- 更新CORS配置支持Vercel域名
- 配置Socket.IO允许的域名
- 确保WebSocket连接在生产环境正常工作

### 2. Vercel前端部署配置

**2.1 创建Vercel配置文件**
- 创建 `vercel.json` 配置文件
- 配置构建命令和输出目录
- 设置SPA路由重写规则

**2.2 环境变量配置**
- 配置生产API URL指向Railway后端
- 配置WebSocket URL
- 配置Google OAuth Client ID

**2.3 构建优化**
- 配置生产环境构建参数
- 启用构建缓存和优化

### 3. 环境变量管理方案

**3.1 后端环境变量**
```bash
# 必需变量
DATABASE_URL=postgresql://...
SECRET_KEY=生成的强密钥
ENCRYPTION_KEY=32字节加密密钥
GOOGLE_CLIENT_ID=OAuth客户端ID
GOOGLE_CLIENT_SECRET=OAuth客户端密钥
GOOGLE_REDIRECT_URI=https://你的域名.vercel.app/auth/callback

# LLM配置（至少一个）
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GEMINI_API_KEY=...

# 生产环境配置
ENVIRONMENT=production
DEBUG=false
CORS_ALLOWED_ORIGINS=["https://你的域名.vercel.app"]
```

**3.2 前端环境变量**
```bash
REACT_APP_API_URL=https://你的后端.railway.app
REACT_APP_WS_URL=https://你的后端.railway.app
REACT_APP_GOOGLE_CLIENT_ID=同后端的CLIENT_ID
REACT_APP_DEBUG=false
```

### 4. 安全配置

**4.1 密钥生成**
- SECRET_KEY: 使用强随机字符串（至少32字符）
- ENCRYPTION_KEY: 32字节随机密钥，用于敏感数据加密

**4.2 CORS严格配置**
- 仅允许生产域名的请求
- 禁用调试模式下的宽松CORS

**4.3 数据库安全**
- 使用Railway提供的PostgreSQL实例
- 确保数据库连接使用SSL

### 5. 监控和日志

**5.1 健康检查**
- 利用现有的 `/health` 端点
- Railway自动监控服务状态

**5.2 日志配置**
- 配置结构化日志输出
- 移除开发环境特有的调试日志

**5.3 错误监控**
- 关闭开发环境的debug_logs API
- 配置生产环境错误收集

## Tests

### 1. 部署前测试

**1.1 本地生产环境模拟测试**
```bash
# 后端测试
export ENVIRONMENT=production
export DEBUG=false
export CORS_ALLOWED_ORIGINS='["https://test-domain.vercel.app"]'
python start_backend.py
# 验证：
# - API响应正常
# - 调试端点被禁用
# - CORS配置正确
```

**1.2 前端构建测试**
```bash
# 前端测试
export REACT_APP_API_URL=https://test-backend.railway.app
npm run build
# 验证：
# - 构建成功无错误
# - 环境变量正确注入
# - 生产优化生效
```

### 2. 部署后集成测试

**2.1 API连通性测试**
- GET /health 返回200状态
- POST /api/auth/google-auth-url 正常工作
- WebSocket连接建立成功

**2.2 OAuth认证流程测试**
- Google OAuth跳转正确
- 回调URL处理正常
- 用户认证状态保持

**2.3 核心功能测试**
- Gmail同步功能正常
- Agent对话功能正常
- 日报生成功能正常

### 3. 性能和安全测试

**3.1 性能测试**
- API响应时间< 2秒
- WebSocket连接稳定
- 数据库连接池正常工作

**3.2 安全测试**
- CORS策略生效
- 调试接口被禁用
- 敏感信息不泄露

### 4. 监控测试

**4.1 健康检查测试**
- Railway监控正常
- 健康检查端点响应

**4.2 日志测试**
- 应用日志正常输出
- 错误日志正确记录
- 调试日志在生产环境被禁用