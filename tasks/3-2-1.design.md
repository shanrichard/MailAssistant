# Design 3-2-1 - API 使用细节修正和代码清理

## Requirements

### 必需修正项
1. 将 `create_react_agent` 的 `state_preprocessor` 参数改为 `prompt`（符合 LangGraph 0.5.3 API）
2. 修复工具调用事件在 "updates" 模式下的解析结构
3. 移除未使用的 import（StateGraph、END、json）

### 目标
- 确保代码符合 LangGraph 0.5.3 的最新 API
- 提高代码整洁度
- 保持与前端的完全兼容性

## Solution

### 1. 修改 create_react_agent 参数

```python
# 在 __init__ 方法中，第55-60行
self.graph_agent = create_react_agent(
    model=self._llm_cache[cache_key],
    tools=self.tools,
    prompt=self._build_prompt,  # 改为 prompt
    checkpointer=self.checkpointer
)
```

### 2. 修复工具调用解析

```python
# 在 stream_response 方法中，替换第173-191行的工具处理逻辑
# 处理工具调用 - 适配新的 patch 结构
if "tool" in chunk:
    tool_data = chunk["tool"]
    # 工具开始事件
    if "name" in tool_data and "args" in tool_data:
        yield {
            "type": "tool_call_start",
            "tool_name": tool_data.get("name"),
            "tool_args": tool_data.get("args"),
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "id": str(uuid.uuid4())
        }
    # 工具结果事件
    if "output" in tool_data:
        yield {
            "type": "tool_call_result",
            "tool_result": tool_data.get("output"),
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "id": str(uuid.uuid4())
        }

# 保留原有的 tools chunk 处理作为后备
elif "tools" in chunk:
    # 原有逻辑保持不变，作为兼容性后备
```

### 3. 清理未使用的 import

```python
# 移除第12行
# from langgraph.graph import StateGraph, END  # 删除此行

# 移除第7行
# import json  # 删除此行
```

### 4. 完整的修改后导入部分

```python
"""
ConversationHandler Agent - 基于LangGraph的对话处理代理
"""
from typing import List, Dict, Any, Optional, Annotated, TypedDict, Sequence
from datetime import datetime, timezone
import uuid

from langchain.tools import Tool
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage, BaseMessage
from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.graph.message import add_messages

from .base_agent import StatefulAgent
from .conversation_tools import create_conversation_tools
from ..core.config import settings
from ..core.logging import get_logger
from ..models.conversation import ConversationMessage
```

## Tests

### 单元测试

1. **test_create_agent_with_prompt**
   ```python
   def test_create_agent_with_prompt():
       """验证 create_react_agent 使用 prompt 参数"""
       handler = ConversationHandler("test_user", db_session)
       assert handler.graph_agent is not None
       # 验证不会抛出参数错误
   ```

2. **test_tool_event_parsing**
   ```python
   async def test_tool_event_parsing():
       """测试工具调用事件的正确解析"""
       handler = ConversationHandler("test_user", db_session)
       # 模拟包含 tool 的 chunk
       mock_chunk = {
           "tool": {
               "name": "search_email_history",
               "args": {"query": "test"},
               "output": "Found 5 emails"
           }
       }
       # 验证生成正确的事件格式
   ```

3. **test_imports_cleaned**
   ```python
   def test_imports_cleaned():
       """验证未使用的 import 已清理"""
       import ast
       with open("conversation_handler.py") as f:
           tree = ast.parse(f.read())
       imports = [node for node in ast.walk(tree) if isinstance(node, ast.Import)]
       # 确保没有 json、StateGraph、END 的导入
   ```

### 集成测试

1. **test_frontend_compatibility**
   - 验证流式事件格式与前端期望一致
   - 测试工具调用可视化功能正常

2. **test_conversation_flow**
   - 端到端测试对话流程
   - 确保 API 修改后功能正常

### 验收标准

- [ ] 代码通过所有单元测试
- [ ] 前端无需修改即可正常接收流式响应
- [ ] 工具调用事件正确显示在前端
- [ ] 代码符合 Python linting 规范（无未使用的 import）
- [ ] LangGraph 0.5.3 不再报参数警告