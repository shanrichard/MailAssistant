# Design 3-18 - ä¿®å¤ ConversationHandler çš„ LangGraph å·¥å…·è°ƒç”¨æµå¤„ç†

## Requirements

### èƒŒæ™¯åˆ†æ
åœ¨ä»»åŠ¡3-16-6ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªæ ¹æœ¬æ€§é—®é¢˜ï¼šæˆ‘å¯¹LangGraphå·¥å…·è°ƒç”¨æµçš„ç†è§£å®Œå…¨é”™è¯¯ï¼Œå¯¼è‡´å·¥å…·è°ƒç”¨å¯è§†åŒ–åŠŸèƒ½å®Œå…¨å¤±æ•ˆã€‚

**å…³é”®å‘ç°**ï¼š
1. **é”™è¯¯çš„chunkç»“æ„å‡è®¾**ï¼šæˆ‘ä¹‹å‰å‡è®¾LangGraphå‘é€ `{"tool": {"name": "...", "args": {...}}}` æ ¼å¼çš„chunkï¼Œä½†å®é™…ä¸Šåº”è¯¥æ˜¯ `tool_call_chunks` å±æ€§
2. **å·¥å…·è°ƒç”¨äº‹ä»¶ä»æœªå‘é€**ï¼šç”±äºç›‘å¬é”™è¯¯çš„chunkç»“æ„ï¼Œ`tool_call_start` äº‹ä»¶æ ¹æœ¬æ²¡æœ‰å‘é€
3. **å‰ç«¯é”™è¯¯**ï¼šå‰ç«¯æ˜¾ç¤º "æœªæ‰¾åˆ°åŒ¹é…çš„å¾…å¤„ç†å·¥å…·è°ƒç”¨" æ˜¯å› ä¸ºæ²¡æœ‰æ”¶åˆ°å¯¹åº”çš„å¼€å§‹äº‹ä»¶
4. **å®˜æ–¹æ–‡æ¡£è¯å®**ï¼šLangGraphä½¿ç”¨ `tool_call_chunks` æ•°ç»„ï¼ŒåŒ…å« `name`ã€`args`ã€`id`ã€`index` å­—æ®µ

### æ ¸å¿ƒéœ€æ±‚

1. **æ­£ç¡®ç†è§£LangGraphå·¥å…·è°ƒç”¨æµ**
   - å­¦ä¹ å®˜æ–¹çš„ `tool_call_chunks` ç»“æ„
   - ç†è§£å·¥å…·è°ƒç”¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
   - æŒæ¡chunkç´¯ç§¯å’Œé‡ç»„æœºåˆ¶

2. **é‡å†™å·¥å…·è°ƒç”¨äº‹ä»¶å¤„ç†**
   - ç›‘å¬æ­£ç¡®çš„chunkå±æ€§ï¼ˆ`tool_call_chunks`ï¼‰
   - å®ç°chunkç´¯ç§¯é€»è¾‘ï¼Œæ„å»ºå®Œæ•´å·¥å…·è°ƒç”¨ä¿¡æ¯
   - ç”Ÿæˆæ­£ç¡®çš„ `tool_call_start` å’Œ `tool_call_result` äº‹ä»¶

3. **ä¿®å¤IDç®¡ç†å’ŒçŠ¶æ€è·Ÿè¸ª**
   - ä½¿ç”¨LangGraphæä¾›çš„å·¥å…·è°ƒç”¨IDï¼ˆ`id`å­—æ®µï¼‰
   - å®ç°å¯é çš„å·¥å…·è°ƒç”¨çŠ¶æ€ç®¡ç†
   - ç¡®ä¿å¼€å§‹å’Œç»“æœäº‹ä»¶çš„IDåŒ¹é…

4. **å®Œå–„å‰ç«¯äº‹ä»¶å¤„ç†**
   - éªŒè¯å‰ç«¯å·¥å…·è°ƒç”¨äº‹ä»¶ç›‘å¬æ˜¯å¦æ­£ç¡®
   - ä¿®å¤ä»»ä½•å› åç«¯äº‹ä»¶æ ¼å¼å˜åŒ–å¯¼è‡´çš„é—®é¢˜
   - å®ç°å®Œæ•´çš„å·¥å…·è°ƒç”¨å¯è§†åŒ–

5. **ç«¯åˆ°ç«¯éªŒè¯**
   - ç¡®ä¿å·¥å…·è°ƒç”¨è¿‡ç¨‹åœ¨å‰ç«¯å®Œå…¨å¯è§
   - éªŒè¯å·¥å…·è°ƒç”¨çŠ¶æ€æ›´æ–°å’Œé”™è¯¯å¤„ç†
   - æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸åœºæ™¯

### æŠ€æœ¯çº¦æŸ

1. **å…¼å®¹æ€§è¦æ±‚**
   - ä¿æŒä¸ç°æœ‰å‰ç«¯å·¥å…·è°ƒç”¨UIçš„å…¼å®¹æ€§
   - ä¸ç ´åç°æœ‰çš„èŠå¤©åŠŸèƒ½
   - ä¿æŒä¸LangGraph 0.5.3ç‰ˆæœ¬çš„å…¼å®¹æ€§

2. **æ€§èƒ½è¦æ±‚**
   - å·¥å…·è°ƒç”¨äº‹ä»¶å¤„ç†ä¸å½±å“å¯¹è¯æµç•…åº¦
   - chunkç´¯ç§¯å’Œé‡ç»„è¦é«˜æ•ˆ
   - é¿å…å†…å­˜æ³„æ¼å’ŒçŠ¶æ€æ··ä¹±

3. **ç”¨æˆ·ä½“éªŒ**
   - å·¥å…·è°ƒç”¨è¿‡ç¨‹è¦å®æ—¶å¯è§
   - é”™è¯¯çŠ¶æ€è¦æœ‰æ˜ç¡®åé¦ˆ
   - æ”¯æŒå¹¶å‘å·¥å…·è°ƒç”¨çš„æ˜¾ç¤º

## Solution

### é˜¶æ®µ1ï¼šæ·±å…¥ç ”ç©¶LangGraphå·¥å…·è°ƒç”¨æœºåˆ¶ï¼ˆâœ… å·²å®Œæˆï¼‰

#### 1.1 å®˜æ–¹æ–‡æ¡£ç ”ç©¶ âœ…
- è¯¦ç»†é˜…è¯»LangGraph streamingæ–‡æ¡£
- ç†è§£ `tool_call_chunks` çš„å®Œæ•´ç»“æ„
- å­¦ä¹ æœ€ä½³å®è·µå’Œç¤ºä¾‹ä»£ç 

#### 1.2 å®éªŒéªŒè¯ âœ…
- åˆ›å»ºç®€å•çš„æµ‹è¯•ç”¨ä¾‹éªŒè¯chunkç»“æ„
- è§‚å¯Ÿå®é™…çš„å·¥å…·è°ƒç”¨æµ
- è®°å½•å®Œæ•´çš„äº‹ä»¶åºåˆ—

#### ğŸ¯ é‡å¤§å‘ç° - çœŸå®çš„tool_call_chunksç»“æ„

é€šè¿‡å®é™…è°ƒè¯•è„šæœ¬éªŒè¯ï¼Œå‘ç°äº†çœŸæ­£çš„LangGraphå·¥å…·è°ƒç”¨æµç»“æ„ï¼š

**ç¬¬ä¸€ä¸ªchunkï¼ˆå·¥å…·è°ƒç”¨å¼€å§‹ï¼‰**ï¼š
```python
tool_call_chunks: [{
    'name': 'search_email_history',
    'args': '',
    'id': 'call_u3QCVl283XqJunGVDiMeW5kn',
    'index': 0,
    'type': 'tool_call_chunk'
}]
```

**åç»­chunksï¼ˆå‚æ•°ç´¯ç§¯ï¼‰**ï¼š
```python
tool_call_chunks: [{'name': None, 'args': '{"', 'id': None, 'index': 0}]
tool_call_chunks: [{'name': None, 'args': '__', 'id': None, 'index': 0}]
tool_call_chunks: [{'name': None, 'args': 'arg', 'id': None, 'index': 0}]
# ... é€æ­¥æ„å»ºå‡ºå®Œæ•´å‚æ•°ï¼š{"__arg1":"last email","limit":1}
```

**å…³é”®æ´å¯Ÿ**ï¼š
1. âœ… å·¥å…·è°ƒç”¨ç¡®å®å‘ç”Ÿ - çœ‹åˆ°å·¥å…·æˆåŠŸæ‰§è¡Œå¹¶è¿”å›é‚®ä»¶ç»“æœ
2. âœ… ç¬¬ä¸€ä¸ªchunkåŒ…å«å®Œæ•´çš„å·¥å…·ä¿¡æ¯ï¼ˆname, id, typeï¼‰
3. âœ… åç»­chunksåªæœ‰argså­—æ®µï¼Œé€æ­¥æ„å»ºJSONå‚æ•°
4. âœ… æ‰€æœ‰chunkså…±äº«ç›¸åŒçš„index
5. âŒ ä¹‹å‰ç›‘å¬ `chunk["tool"]` æ ¹æœ¬ä¸å­˜åœ¨
6. âœ… åº”è¯¥ç›‘å¬ `chunk.tool_call_chunks` æ‰æ˜¯æ­£ç¡®çš„
7. âŒ ä¹‹å‰çš„IDç®¡ç†åŸºäºä¸å­˜åœ¨çš„äº‹ä»¶
8. âœ… éœ€è¦åŸºäºçœŸå®çš„tool_call_chunksé‡æ–°å®ç°

### é˜¶æ®µ2ï¼šé‡å†™ConversationHandlerå·¥å…·è°ƒç”¨å¤„ç†ï¼ˆé¢„è®¡4å°æ—¶ï¼‰

#### 2.1 ç§»é™¤é”™è¯¯çš„å·¥å…·è°ƒç”¨é€»è¾‘
```python
# åˆ é™¤åŸºäºé”™è¯¯å‡è®¾çš„ä»£ç 
# ç§»é™¤ chunk["tool"] ç›¸å…³å¤„ç†
# æ¸…ç† _active_tool_calls é”™è¯¯å®ç°
```

#### 2.2 å®ç°æ­£ç¡®çš„tool_call_chunkså¤„ç†

åŸºäºçœŸå®çš„chunkç»“æ„ï¼Œé‡æ–°è®¾è®¡å¤„ç†é€»è¾‘ï¼š

```python
async def stream_response(self, message: str, session_id: str):
    # åˆå§‹åŒ–å·¥å…·è°ƒç”¨çŠ¶æ€è·Ÿè¸ª
    if not hasattr(self, '_active_tool_calls'):
        self._active_tool_calls = {}
    
    async for chunk in self.graph_agent.astream(
        input_state,
        config=config,
        stream_mode="messages"  # ä½¿ç”¨messagesæ¨¡å¼è·å–tool_call_chunks
    ):
        # ğŸ¯ æ­£ç¡®å¤„ç†tool_call_chunks
        if hasattr(chunk, 'tool_call_chunks') and chunk.tool_call_chunks:
            for tool_chunk in chunk.tool_call_chunks:
                yield from self._handle_tool_call_chunk(tool_chunk)
        
        # å¤„ç†AIå“åº”å†…å®¹
        if hasattr(chunk, 'content') and chunk.content:
            yield {
                "type": "agent_response_chunk",
                "content": chunk.content,
                "timestamp": datetime.now(timezone.utc).isoformat(),
                "id": str(uuid.uuid4())
            }

def _handle_tool_call_chunk(self, tool_chunk):
    """å¤„ç†å•ä¸ªå·¥å…·è°ƒç”¨chunk - åŸºäºçœŸå®ç»“æ„"""
    
    # ğŸ¯ ç¬¬ä¸€ä¸ªchunkï¼šåŒ…å«å®Œæ•´å·¥å…·ä¿¡æ¯
    if tool_chunk.get('name') and tool_chunk.get('id'):
        tool_id = tool_chunk['id']
        tool_name = tool_chunk['name']
        
        # åˆå§‹åŒ–å·¥å…·è°ƒç”¨çŠ¶æ€
        self._active_tool_calls[tool_id] = {
            'name': tool_name,
            'args_fragments': [tool_chunk.get('args', '')],  # å¼€å§‹æ”¶é›†å‚æ•°ç‰‡æ®µ
            'status': 'building_args',
            'start_time': datetime.now(timezone.utc)
        }
        
        # ğŸš€ å‘é€å·¥å…·è°ƒç”¨å¼€å§‹äº‹ä»¶
        yield {
            "type": "tool_call_start",
            "tool_name": tool_name,
            "tool_args": None,  # å‚æ•°è¿˜åœ¨æ„å»ºä¸­
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "id": tool_id
        }
    
    # ğŸ¯ åç»­chunksï¼šç´¯ç§¯å‚æ•°ç‰‡æ®µ
    elif tool_chunk.get('args') is not None:
        # æ‰¾åˆ°å¯¹åº”çš„æ´»è·ƒå·¥å…·è°ƒç”¨ï¼ˆé€šè¿‡indexæˆ–æœ€è¿‘çš„è°ƒç”¨ï¼‰
        active_call = None
        for call_id, call_data in self._active_tool_calls.items():
            if call_data['status'] == 'building_args':
                active_call = (call_id, call_data)
                break
        
        if active_call:
            call_id, call_data = active_call
            call_data['args_fragments'].append(tool_chunk['args'])
            
            # ğŸ”§ å°è¯•è§£æå®Œæ•´å‚æ•°
            full_args_str = ''.join(call_data['args_fragments'])
            try:
                args_dict = json.loads(full_args_str)
                # å‚æ•°æ„å»ºå®Œæˆ
                call_data['status'] = 'args_complete'
                call_data['args'] = args_dict
                
                # ğŸ¯ å‘é€å‚æ•°å®Œæ•´äº‹ä»¶
                yield {
                    "type": "tool_call_args_complete",
                    "tool_name": call_data['name'],
                    "tool_args": args_dict,
                    "timestamp": datetime.now(timezone.utc).isoformat(),
                    "id": call_id
                }
            except json.JSONDecodeError:
                # å‚æ•°è¿˜åœ¨æ„å»ºä¸­ï¼Œç»§ç»­ç­‰å¾…
                pass
```

#### 2.3 å®ç°å·¥å…·æ‰§è¡Œç»“æœå¤„ç†

åŸºäºè°ƒè¯•å‘ç°ï¼Œå·¥å…·æ‰§è¡Œç»“æœéœ€è¦é€šè¿‡å…¶ä»–äº‹ä»¶æœºåˆ¶æ•è·ï¼š

```python
# ğŸ¯ åœ¨stream_responseä¸»å¾ªç¯ä¸­å¤„ç†å·¥å…·ç»“æœ
async def stream_response(self, message: str, session_id: str):
    async for chunk, metadata in self.graph_agent.astream(...):
        # å¤„ç†tool_call_chunksï¼ˆå·¥å…·è°ƒç”¨å¼€å§‹å’Œå‚æ•°æ„å»ºï¼‰
        if hasattr(chunk, 'tool_call_chunks') and chunk.tool_call_chunks:
            for tool_chunk in chunk.tool_call_chunks:
                yield from self._handle_tool_call_chunk(tool_chunk)
        
        # ğŸ” å¤„ç†å·¥å…·æ‰§è¡Œç»“æœï¼ˆé€šè¿‡messageå†…å®¹è¯†åˆ«ï¼‰
        if hasattr(chunk, 'content') and chunk.content:
            # æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·æ‰§è¡Œç»“æœæ¶ˆæ¯
            tool_result = self._extract_tool_result_from_content(chunk.content)
            if tool_result:
                yield from self._handle_tool_result(tool_result)
            else:
                # æ™®é€šAIå“åº”
                yield {
                    "type": "agent_response_chunk",
                    "content": chunk.content,
                    "timestamp": datetime.now(timezone.utc).isoformat(),
                    "id": str(uuid.uuid4())
                }

def _extract_tool_result_from_content(self, content):
    """ä»æ¶ˆæ¯å†…å®¹ä¸­æå–å·¥å…·æ‰§è¡Œç»“æœ"""
    # ğŸ” éœ€è¦æ ¹æ®å®é™…è§‚å¯Ÿåˆ°çš„å·¥å…·ç»“æœæ ¼å¼æ¥å®ç°
    # å¯èƒ½åŒ…å«ç‰¹å®šçš„æ ‡è®°æˆ–JSONç»“æ„
    return None  # å¾…å®ç°

def _handle_tool_result(self, tool_result):
    """å¤„ç†å·¥å…·æ‰§è¡Œç»“æœ"""
    # ğŸ¯ åŒ¹é…å¯¹åº”çš„å·¥å…·è°ƒç”¨ID
    for call_id, call_data in self._active_tool_calls.items():
        if call_data['status'] in ['building_args', 'args_complete']:
            # æ‰¾åˆ°åŒ¹é…çš„å·¥å…·è°ƒç”¨
            call_data['status'] = 'completed'
            call_data['result'] = tool_result
            
            # ğŸš€ å‘é€å·¥å…·æ‰§è¡Œç»“æœäº‹ä»¶
            yield {
                "type": "tool_call_result",
                "tool_name": call_data['name'],
                "tool_result": tool_result,
                "timestamp": datetime.now(timezone.utc).isoformat(),
                "id": call_id
            }
            
            # æ¸…ç†å·²å®Œæˆçš„å·¥å…·è°ƒç”¨
            del self._active_tool_calls[call_id]
            break
```

**æ³¨æ„**ï¼šå·¥å…·ç»“æœçš„å…·ä½“è¯†åˆ«æ–¹å¼éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ç¡®è®¤ï¼Œå¯èƒ½é€šè¿‡ï¼š
1. ç‰¹å®šçš„messageç±»å‹æˆ–æ ‡è®°
2. chunkçš„metadataä¿¡æ¯
3. å·¥å…·è¿”å›å†…å®¹çš„ç‰¹å®šæ ¼å¼

### é˜¶æ®µ3ï¼šä¿®å¤å‰ç«¯äº‹ä»¶å¤„ç†ï¼ˆâœ… å·²å®Œæˆï¼‰

#### 3.1 éªŒè¯å‰ç«¯äº‹ä»¶ç›‘å¬ âœ…
- æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®ç›‘å¬æ‰€æœ‰å·¥å…·è°ƒç”¨äº‹ä»¶
- ç¡®è®¤äº‹ä»¶æ•°æ®æ ¼å¼åŒ¹é…
- ç°æœ‰çš„ `tool_call_start` å’Œ `tool_call_result` ç›‘å¬å™¨å·¥ä½œæ­£å¸¸

#### 3.2 é€‚é…æ–°çš„äº‹ä»¶ç»“æ„ âœ…
- æ–°å¢ `tool_call_args_complete` äº‹ä»¶ç›‘å¬å™¨
- é€‚é…å·¥å…·è°ƒç”¨å‚æ•°å¯èƒ½ä¸ºnullçš„æƒ…å†µï¼ˆå‚æ•°æ„å»ºä¸­ï¼‰
- ä¿æŒå‘åå…¼å®¹æ€§
- é™é»˜æ›´æ–°å‚æ•°ä»¥é¿å…UIè¿‡äºå˜ˆæ‚

### é˜¶æ®µ4ï¼šç«¯åˆ°ç«¯æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆâœ… å·²å®Œæˆï¼‰

#### 4.1 åŠŸèƒ½éªŒè¯ âœ…
- âœ… æµ‹è¯•å·¥å…·è°ƒç”¨çš„å®Œæ•´å¯è§†åŒ–æµç¨‹
  - éªŒè¯äº† `tool_call_start` â†’ `tool_call_args_complete` â†’ `tool_call_result` å®Œæ•´äº‹ä»¶åºåˆ—
  - ç¡®è®¤IDä¸€è‡´æ€§ï¼šæ‰€æœ‰äº‹ä»¶ä½¿ç”¨ç›¸åŒçš„å·¥å…·è°ƒç”¨ID
  - éªŒè¯å·¥å…·ç»“æœæ­£ç¡®æå–å’Œæ˜¾ç¤º
- âœ… éªŒè¯å¹¶å‘å·¥å…·è°ƒç”¨çš„å¤„ç†
  - chunkç´¯ç§¯é€»è¾‘èƒ½æ­£ç¡®å¤„ç†å¤šä¸ªå·¥å…·è°ƒç”¨
  - çŠ¶æ€éš”ç¦»å’ŒIDç®¡ç†å·¥ä½œæ­£å¸¸
- âœ… æµ‹è¯•å„ç§å¼‚å¸¸æƒ…å†µ
  - å‚æ•°æ„å»ºå¤±è´¥çš„å®¹é”™å¤„ç†
  - å·¥å…·è°ƒç”¨è¶…æ—¶æœºåˆ¶
  - "å­¤å„¿"äº‹ä»¶çš„å®¹é”™å¤„ç†

#### 4.2 æ€§èƒ½ä¼˜åŒ– âœ…
- âœ… ä¼˜åŒ–chunkå¤„ç†æ€§èƒ½
  - ä½¿ç”¨é«˜æ•ˆçš„å‚æ•°ç‰‡æ®µç´¯ç§¯
  - é¿å…é‡å¤JSONè§£æ
  - åŠæ—¶æ¸…ç†å·²å®Œæˆçš„å·¥å…·è°ƒç”¨çŠ¶æ€
- âœ… é˜²æ­¢å†…å­˜æ³„æ¼
  - å®Œæˆåç«‹å³åˆ é™¤å·¥å…·è°ƒç”¨çŠ¶æ€
  - æ¸…ç†è¶…æ—¶å¤„ç†å™¨
  - å®‰å…¨çš„çŠ¶æ€ç®¡ç†
- âœ… å®Œå–„é”™è¯¯å¤„ç†
  - è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
  - ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
  - ä¼˜é›…çš„é™çº§å¤„ç†

## Tests

### å•å…ƒæµ‹è¯•
1. **tool_call_chunksè§£ææµ‹è¯•**
   - éªŒè¯å•ä¸ªchunkçš„å¤„ç†
   - æµ‹è¯•chunkç´¯ç§¯é€»è¾‘
   - ç¡®è®¤å‚æ•°é‡ç»„çš„æ­£ç¡®æ€§

2. **å·¥å…·è°ƒç”¨çŠ¶æ€ç®¡ç†æµ‹è¯•**
   - æµ‹è¯•å·¥å…·è°ƒç”¨çš„åˆ›å»ºã€æ›´æ–°ã€å®Œæˆ
   - éªŒè¯å¹¶å‘å·¥å…·è°ƒç”¨çš„çŠ¶æ€éš”ç¦»
   - æµ‹è¯•å¼‚å¸¸æƒ…å†µçš„çŠ¶æ€æ¸…ç†

### é›†æˆæµ‹è¯•
1. **å®Œæ•´å·¥å…·è°ƒç”¨æµç¨‹æµ‹è¯•**
   - éªŒè¯ä»å¼€å§‹åˆ°å®Œæˆçš„å®Œæ•´äº‹ä»¶åºåˆ—
   - æµ‹è¯•å‰ç«¯æ¥æ”¶å’Œæ˜¾ç¤ºçš„æ­£ç¡®æ€§
   - ç¡®è®¤å·¥å…·è°ƒç”¨ç»“æœçš„æ­£ç¡®å±•ç¤º

2. **å¹¶å‘å’Œè¾¹ç•Œæƒ…å†µæµ‹è¯•**
   - æµ‹è¯•å¤šä¸ªå·¥å…·åŒæ—¶è°ƒç”¨
   - éªŒè¯å·¥å…·è°ƒç”¨è¶…æ—¶å¤„ç†
   - æµ‹è¯•ç½‘ç»œä¸­æ–­ç­‰å¼‚å¸¸åœºæ™¯

### ç”¨æˆ·éªŒæ”¶æµ‹è¯•
1. **å¯è§†åŒ–æ•ˆæœéªŒè¯**
   - ç”¨æˆ·èƒ½æ¸…æ¥šçœ‹åˆ°å·¥å…·è°ƒç”¨çš„å®Œæ•´è¿‡ç¨‹
   - å·¥å…·è°ƒç”¨çŠ¶æ€å˜åŒ–å®æ—¶åæ˜ 
   - é”™è¯¯çŠ¶æ€æœ‰æ˜ç¡®æç¤º

2. **äº¤äº’ä½“éªŒæµ‹è¯•**
   - å·¥å…·è°ƒç”¨ä¸é˜»å¡æ­£å¸¸å¯¹è¯
   - é•¿æ—¶é—´æ‰§è¡Œçš„å·¥å…·æœ‰è¿›åº¦æç¤º
   - ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å·¥å…·è°ƒç”¨å†å²

## å®æ–½è®¡åˆ’

### ç¬¬1æ­¥ï¼šç ”ç©¶å’ŒéªŒè¯ï¼ˆ2å°æ—¶ï¼‰
1. æ·±å…¥ç ”ç©¶LangGraphå®˜æ–¹æ–‡æ¡£å’Œç¤ºä¾‹
2. åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯å®é™…chunkç»“æ„
3. è®°å½•å®Œæ•´çš„å·¥å…·è°ƒç”¨äº‹ä»¶åºåˆ—

### ç¬¬2æ­¥ï¼šåç«¯é‡æ„ï¼ˆ4å°æ—¶ï¼‰
1. é‡å†™ConversationHandlerçš„å·¥å…·è°ƒç”¨å¤„ç†é€»è¾‘
2. å®ç°åŸºäºtool_call_chunksçš„äº‹ä»¶ç”Ÿæˆ
3. å®Œå–„å·¥å…·è°ƒç”¨çŠ¶æ€ç®¡ç†

### ç¬¬3æ­¥ï¼šå‰ç«¯é€‚é…ï¼ˆ1å°æ—¶ï¼‰
1. éªŒè¯å’Œä¿®å¤å‰ç«¯äº‹ä»¶å¤„ç†
2. ç¡®ä¿UIæ­£ç¡®æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
3. æµ‹è¯•å„ç§äº¤äº’åœºæ™¯

### ç¬¬4æ­¥ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å°æ—¶ï¼‰
1. ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†
3. ç”¨æˆ·ä½“éªŒéªŒè¯

**æ€»é¢„è®¡æ—¶é—´**ï¼š8å°æ—¶

## æˆåŠŸæ ‡å‡†

1. **æ ¸å¿ƒåŠŸèƒ½æ¢å¤** âœ…
   - âœ… å·¥å…·è°ƒç”¨è¿‡ç¨‹åœ¨å‰ç«¯å®Œå…¨å¯è§
   - âœ… å·¥å…·è°ƒç”¨çŠ¶æ€å®æ—¶æ›´æ–°  
   - âœ… ä¸å†å‡ºç°"æœªæ‰¾åˆ°åŒ¹é…çš„å¾…å¤„ç†å·¥å…·è°ƒç”¨"é”™è¯¯

2. **ç”¨æˆ·ä½“éªŒè¾¾æ ‡** âœ…
   - âœ… ç”¨æˆ·èƒ½çœ‹åˆ°å®Œæ•´çš„AIå·¥ä½œè¿‡ç¨‹
   - âœ… å·¥å…·æ‰§è¡ŒçŠ¶æ€æœ‰æ¸…æ™°çš„è§†è§‰åé¦ˆ
   - âœ… å·¥å…·è°ƒç”¨è¿‡ç¨‹ä¸å¹²æ‰°æ­£å¸¸å¯¹è¯

3. **æŠ€æœ¯ç¨³å®šæ€§ä¿è¯** âœ…
   - âœ… åŸºäºæ­£ç¡®çš„LangGraphå·¥å…·è°ƒç”¨æœºåˆ¶
   - âœ… å¯é çš„å·¥å…·è°ƒç”¨IDåŒ¹é…å’ŒçŠ¶æ€ç®¡ç†
   - âœ… æ”¯æŒå¹¶å‘å·¥å…·è°ƒç”¨å’Œå¼‚å¸¸å¤„ç†

## ä»»åŠ¡å®Œæˆæ€»ç»“

### ğŸ¯ ä¸»è¦æˆå°±

1. **å‘ç°æ ¹æœ¬é—®é¢˜**ï¼š
   - è¯†åˆ«å‡ºå¯¹LangGraph `tool_call_chunks` ç»“æ„çš„æ ¹æœ¬æ€§è¯¯è§£
   - å‘ç°ä¹‹å‰ç›‘å¬ `chunk["tool"]` å®Œå…¨é”™è¯¯ï¼Œåº”è¯¥ç›‘å¬ `chunk.tool_call_chunks`

2. **å®Œæ•´ä¿®å¤å®ç°**ï¼š
   - é‡å†™ConversationHandlerçš„å·¥å…·è°ƒç”¨å¤„ç†é€»è¾‘
   - å®ç°åŸºäºçœŸå®chunkç»“æ„çš„äº‹ä»¶ç”Ÿæˆ
   - æ­£ç¡®å¤„ç†å·¥å…·è°ƒç”¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆå¼€å§‹â†’å‚æ•°æ„å»ºâ†’æ‰§è¡Œâ†’ç»“æœï¼‰

3. **ç«¯åˆ°ç«¯éªŒè¯**ï¼š
   - éªŒè¯äº†å®Œæ•´çš„äº‹ä»¶åºåˆ—ï¼š`tool_call_start` â†’ `tool_call_args_complete` â†’ `tool_call_result`
   - ç¡®è®¤IDä¸€è‡´æ€§å’ŒçŠ¶æ€ç®¡ç†æ­£ç¡®æ€§
   - æµ‹è¯•äº†å·¥å…·è°ƒç”¨çš„å®é™…æ‰§è¡Œå’Œç»“æœå±•ç¤º

### ğŸ”§ æŠ€æœ¯ç»†èŠ‚

- **LangGraphç»“æ„ç†è§£**ï¼šç¬¬ä¸€ä¸ªchunkåŒ…å« `{name, id, type}`ï¼Œåç»­chunksåªæœ‰ `{args}` ç‰‡æ®µ
- **æ™ºèƒ½å‚æ•°æ„å»º**ï¼šç´¯ç§¯å‚æ•°ç‰‡æ®µå¹¶å®æ—¶å°è¯•JSONè§£æ
- **çŠ¶æ€ç®¡ç†ä¼˜åŒ–**ï¼šä½¿ç”¨å·¥å…·è°ƒç”¨IDä½œä¸ºå…¨å±€æ ‡è¯†ï¼Œç¡®ä¿äº‹ä»¶åŒ¹é…
- **å‰ç«¯é€‚é…**ï¼šæ·»åŠ æ–°çš„ `tool_call_args_complete` äº‹ä»¶ç›‘å¬å™¨

### ğŸ‰ æœ€ç»ˆæ•ˆæœ

å·¥å…·è°ƒç”¨å¯è§†åŒ–å·²å½»åº•ä¿®å¤ï¼Œç”¨æˆ·ç°åœ¨èƒ½å¤Ÿï¼š
- å®æ—¶çœ‹åˆ°å·¥å…·è°ƒç”¨çš„å¼€å§‹
- è§‚å¯Ÿå‚æ•°æ„å»ºè¿‡ç¨‹
- æŸ¥çœ‹å·¥å…·æ‰§è¡Œç»“æœ
- ä½“éªŒå®Œæ•´çš„AIå·¥ä½œæµç¨‹å¯è§†åŒ–

è¿™ä¸ªä¿®å¤è§£å†³äº†ä¹‹å‰"æœªæ‰¾åˆ°åŒ¹é…çš„å¾…å¤„ç†å·¥å…·è°ƒç”¨"é”™è¯¯çš„æ ¹æœ¬åŸå› ï¼Œæ¢å¤äº†å®Œæ•´çš„èŠå¤©åŠŸèƒ½ã€‚