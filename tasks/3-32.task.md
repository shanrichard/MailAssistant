# Task 3-32: 优化邮件同步架构，解决内存溢出和时间空洞问题

## 背景
在生产环境部署时，用户点击"同步一个月邮件"导致Railway服务内存溢出崩溃（8GB内存被占满）。经过深入分析，发现当前同步设计存在严重的内存管理问题和架构缺陷。

## 问题分析

### 1. 内存溢出原因
- **N+1查询问题**：虽然任务3-14和3-30已经优化了API调用次数，但仍使用`format='full'`获取完整邮件数据
- **内存累积**：一次性加载1000封邮件到内存，包括原始JSON、解析后对象、SQLAlchemy ORM对象等多层累积
- **SQLAlchemy Session缓存**：所有待提交对象都在session中，直到`commit()`才释放
- **实际内存占用**：1000封邮件可能占用5-8GB内存（远超理论计算的2GB）

### 2. 架构设计缺陷
- 缺乏分批处理机制
- 没有断点续传能力
- 事务粒度过大
- 错误恢复机制不完善

### 3. 时间空洞问题
用户指出了一个重要边界情况：如果数据库中存在"时间空洞"（如有1-3号和7号的邮件，但缺少4-6号），同步系统需要能够检测并填补这些空洞。

## 子任务规划

基于问题的复杂性和模块化需求，将任务拆分为以下子任务：

- [x] 3-32-1 实现内存友好的分批同步机制
- [x] 3-32-2 集成Gmail History API实现精确增量同步
- [ ] 3-32-3 实现时间空洞检测与填补算法
- [ ] 3-32-4 优化数据库操作和事务管理
- [ ] 3-32-5 实现并发安全机制

## 进度更新

### 已完成（2025-01-26）

1. **3-32-1: 内存友好的分批同步机制**
   - 实现了 `sync_emails_by_query_with_monitoring_paginated` 方法
   - 添加了内存监控和智能垃圾回收
   - 支持批量处理和定期提交
   - 集成了性能监控器

2. **3-32-2: Gmail History API集成**
   - 实现了 `sync_emails_with_history_api` 方法
   - 支持精确追踪邮件变化（新增、删除、标签变更）
   - 处理了 historyId 过期的情况
   - 使用 Gmail Batch API 提高效率

3. **生产环境问题修复**
   - 修复了数据库连接池耗尽问题
   - 优化了后台任务的数据库会话管理
   - 添加了 gunicorn 配置限制工作进程数
   - 将 `db.expire_all()` 替换为 `db.flush()` 避免过度查询

### 待完成

- 3-32-3: 时间空洞检测算法
- 3-32-4: 数据库批量操作优化
- 3-32-5: 并发控制机制