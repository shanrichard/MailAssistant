# Design 3-9-4: 实现数据库硬约束防止数据不一致

## Requirements
- 在数据库层面添加硬约束，防止数据不一致状态的产生
- 实现进度与同步状态的强一致性检查
- 确保每个用户只能有一个运行中的同步任务
- 防止任务ID重复

## Solution
**采用专家建议的企业级数据库约束方案**：

### 1. 数据一致性硬约束
```sql
-- ① 进度与同步状态强一致性约束
ALTER TABLE user_sync_status
ADD CONSTRAINT chk_sync_state_consistency
CHECK (
    (is_syncing = TRUE  AND progress_percentage BETWEEN 0 AND 99)
 OR (is_syncing = FALSE AND progress_percentage IN (0, 100))
);

-- ② 确保每个用户只能有一个运行中的同步任务
CREATE UNIQUE INDEX uniq_user_running_sync
ON user_sync_status(user_id)
WHERE is_syncing = TRUE;

-- ③ 防止任务ID重复
CREATE UNIQUE INDEX uniq_task_id
ON user_sync_status(task_id);
```

### 2. 约束验证脚本
```sql
-- 验证现有数据是否符合约束（在添加约束前运行）
SELECT 
    user_id,
    task_id,
    is_syncing,
    progress_percentage,
    CASE 
        WHEN is_syncing = TRUE AND progress_percentage NOT BETWEEN 0 AND 99 
        THEN '进度状态不一致'
        WHEN is_syncing = FALSE AND progress_percentage NOT IN (0, 100)
        THEN '完成状态不一致'
        ELSE '状态正常'
    END as status_check
FROM user_sync_status
WHERE NOT (
    (is_syncing = TRUE AND progress_percentage BETWEEN 0 AND 99)
    OR (is_syncing = FALSE AND progress_percentage IN (0, 100))
);
```

## Tests
- 尝试插入不一致状态数据，验证约束正确阻止
- 尝试为同一用户创建多个运行中任务，验证唯一索引生效
- 尝试插入重复的任务ID，验证唯一性约束
- 确认现有数据全部符合约束条件

**好处**：
- 写入阶段直接拒绝"不合法状态"，而不是事后靠脚本清理
- 数据库层面保证一致性，无论代码如何变化都不会出现不一致状态
- 强制单任务执行，从根本上防止并发冲突