<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Fix Test</title>
</head>
<body>
    <h1>WebSocket修复测试</h1>
    <p>此测试页面用于验证WebSocket连接修复是否生效</p>
    
    <h2>期望结果：</h2>
    <ul>
        <li>刷新页面后，应该只有1-2个WebSocket连接（不是3个）</li>
        <li>不应该再出现3个超时错误</li>
        <li>如果仍有超时，应该只有1-2个</li>
    </ul>
    
    <h2>测试步骤：</h2>
    <ol>
        <li>在应用中刷新页面（Cmd+R）</li>
        <li>等待15秒</li>
        <li>查看控制台是否有超时错误</li>
        <li>可以运行simple_monitor.js查看详细状态</li>
    </ol>
    
    <h2>修改内容：</h2>
    <pre>
MainLayout.tsx:
- 修改了useEffect的依赖项，从[user, connectWebSocket, disconnectWebSocket]改为[user?.id]
- 使用useChatStore.getState()直接获取store函数，避免依赖变化
- 添加了cancelled标志，防止组件卸载后处理错误
- 捕获连接错误，避免未处理的Promise rejection
    </pre>
</body>
</html>