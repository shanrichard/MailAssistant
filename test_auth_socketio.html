<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Auth Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <h1>Socket.IO 认证测试</h1>
    <button onclick="testAuth()">测试认证</button>
    <button onclick="viewLogs()">查看日志</button>
    <div id="log"></div>
    
    <script>
        const logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            console.log(logEntry);
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            document.getElementById('log').innerHTML = '<pre>' + logs.join('\n') + '</pre>';
        }
        
        function getAuthToken() {
            try {
                const authData = localStorage.getItem('mailassistant_auth_token');
                if (authData) {
                    const parsed = JSON.parse(authData);
                    return parsed.state?.token || null;
                }
                return localStorage.getItem('access_token');
            } catch (e) {
                log('Failed to parse auth token: ' + e.message, 'error');
                return null;
            }
        }
        
        async function testAuth() {
            logs.length = 0; // Clear logs
            
            const token = getAuthToken();
            log(`Auth token: ${token ? 'Found (' + token.substring(0, 20) + '...)' : 'Not found'}`);
            
            if (!token) {
                log('Please login first!', 'error');
                return;
            }
            
            log('Creating Socket.IO connection...');
            
            const socket = io('http://localhost:8000', {
                auth: {
                    token: token
                },
                transports: ['polling', 'websocket'],
                upgrade: true,
                reconnection: false // 禁用自动重连以便看到错误
            });
            
            socket.on('connect', () => {
                log('✅ Connected successfully!', 'success');
                log(`Socket ID: ${socket.id}`);
                log(`Transport: ${socket.io.engine.transport.name}`);
                
                // 监听升级事件
                socket.io.on('upgrade', (transport) => {
                    log(`✅ Upgraded to: ${transport.name}`, 'success');
                });
                
                // 发送测试消息
                log('Sending test message...');
                socket.emit('agent_message', {
                    message: 'Hello from test client',
                    session_id: 'test-session'
                });
            });
            
            socket.on('connect_error', (error) => {
                log(`❌ Connection error: ${error.message}`, 'error');
                log(`Error type: ${error.type}`, 'error');
                if (error.data) {
                    log(`Error data: ${JSON.stringify(error.data)}`, 'error');
                }
            });
            
            socket.on('disconnect', (reason) => {
                log(`Disconnected: ${reason}`, 'warn');
            });
            
            socket.on('error', (error) => {
                log(`Socket error: ${error.message || error}`, 'error');
            });
            
            socket.on('agent_event', (data) => {
                log(`Received agent event: ${JSON.stringify(data)}`, 'info');
            });
            
            socket.on('connected', (data) => {
                log(`Server confirmed connection: ${JSON.stringify(data)}`, 'success');
            });
            
            // 10秒后断开连接
            setTimeout(() => {
                if (socket.connected) {
                    log('Test complete, disconnecting...');
                    socket.disconnect();
                }
            }, 10000);
        }
        
        function viewLogs() {
            // 在新窗口查看后端日志
            window.open('http://localhost:8000/api/debug/logs/backend', '_blank');
        }
        
        window.onload = () => {
            log('Page loaded. Click "测试认证" to start.');
        };
    </script>
</body>
</html>