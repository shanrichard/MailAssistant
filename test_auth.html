<!DOCTYPE html>
<html>
<head>
    <title>Auth Token Test</title>
</head>
<body>
    <h1>Auth Token Test</h1>
    <div id="results"></div>
    
    <script>
        function checkAuth() {
            const results = document.getElementById('results');
            let html = '<h2>Checking Authentication...</h2>';
            
            // Check old format
            const oldToken = localStorage.getItem('access_token');
            html += `<p>Old format (access_token): ${oldToken ? 'Found' : 'Not found'}</p>`;
            
            // Check new format
            const newTokenRaw = localStorage.getItem('mailassistant_auth_token');
            if (newTokenRaw) {
                try {
                    const parsed = JSON.parse(newTokenRaw);
                    const token = parsed.state?.token;
                    const isAuth = parsed.state?.isAuthenticated;
                    html += `<p>New format (mailassistant_auth_token): Found</p>`;
                    html += `<p>- Token exists: ${!!token}</p>`;
                    html += `<p>- Is authenticated: ${isAuth}</p>`;
                    html += `<p>- User email: ${parsed.state?.user?.email || 'N/A'}</p>`;
                } catch (e) {
                    html += `<p>New format parse error: ${e.message}</p>`;
                }
            } else {
                html += `<p>New format (mailassistant_auth_token): Not found</p>`;
            }
            
            // Test getToken function
            html += '<h3>Testing getToken() function:</h3>';
            html += '<pre>';
            html += `
// Auth utilities
export const getToken = (): string | null => {
  try {
    // 先尝试从新的存储格式读取
    const authData = localStorage.getItem('mailassistant_auth_token');
    if (authData) {
      const parsed = JSON.parse(authData);
      return parsed.state?.token || null;
    }
    
    // 回退到旧的存储格式
    return localStorage.getItem('access_token');
  } catch {
    // 如果解析失败，回退到旧格式
    return localStorage.getItem('access_token');
  }
};
            `;
            html += '</pre>';
            
            // Simulate getToken
            function getToken() {
                try {
                    const authData = localStorage.getItem('mailassistant_auth_token');
                    if (authData) {
                        const parsed = JSON.parse(authData);
                        return parsed.state?.token || null;
                    }
                    return localStorage.getItem('access_token');
                } catch {
                    return localStorage.getItem('access_token');
                }
            }
            
            const token = getToken();
            html += `<p><strong>getToken() result: ${token ? 'Token found' : 'No token found'}</strong></p>`;
            
            results.innerHTML = html;
        }
        
        // Run test
        checkAuth();
    </script>
</body>
</html>