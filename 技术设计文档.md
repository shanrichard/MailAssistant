# 邮件管家 - 技术设计文档

## 技术架构概览

### 总体架构
**方案：单体应用 + Agent架构**

- **后端**：FastAPI + LangGraph + SQLAlchemy
- **前端**：React + TypeScript
- **数据库**：PostgreSQL + pgvector扩展
- **认证**：Google OAuth2
- **LLM**：支持OpenAI/Anthropic/Gemini多Provider

### 核心设计原则
1. **Agent优先**：能用AI的地方都用AI，避免硬编码
2. **简洁架构**：最少的节点数量，最大的可靠性
3. **个性化**：基于用户偏好的智能分析
4. **可扩展**：支持多种LLM Provider

## LangGraph Agent架构

### 精简的2节点设计

**1. EmailProcessor节点**
- **职责**：邮件获取、分析、分类、日报生成
- **触发**：定时任务或手动触发
- **工具调用**：Gmail API、数据库操作、LLM分析

**2. ConversationHandler节点**
- **职责**：用户对话、偏好更新、执行用户操作
- **触发**：用户交互
- **工具调用**：偏好管理、邮件搜索、批量操作

### Agent工具集
- **GmailFetcher**：获取邮件
- **GmailMarker**：标记邮件已读
- **GmailSearcher**：搜索邮件
- **PreferenceManager**：管理用户偏好
- **DatabaseManager**：数据库操作
- **EmailAnalyzer**：LLM分析邮件

## 数据库设计

### 混合存储方案
- **PostgreSQL**：用户信息、邮件元数据、分类结果
- **pgvector扩展**：用户偏好向量存储和相似性匹配

### 核心表结构

**用户表 (users)**
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    google_id VARCHAR(255) UNIQUE NOT NULL,
    encrypted_gmail_tokens TEXT,
    preferences_text TEXT,
    daily_report_time TIME DEFAULT '08:00:00',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**邮件表 (emails)**
```sql
CREATE TABLE emails (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    gmail_id VARCHAR(255) NOT NULL,
    subject TEXT,
    sender VARCHAR(255),
    body_text TEXT,
    is_important BOOLEAN DEFAULT FALSE,
    importance_reason TEXT,
    category VARCHAR(100),
    received_at TIMESTAMP WITH TIME ZONE,
    processed_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(user_id, gmail_id)
);
```

**用户偏好向量表 (user_preferences_vectors)**
```sql
CREATE TABLE user_preferences_vectors (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    preference_text TEXT NOT NULL,
    embedding vector(1536),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## API设计

### RESTful API接口

**认证相关**
- `POST /auth/google` - Google OAuth登录
- `POST /auth/refresh` - 刷新令牌
- `DELETE /auth/logout` - 登出

**邮件处理**
- `POST /emails/process` - 手动触发邮件处理
- `GET /emails/daily-report` - 获取日报
- `POST /emails/mark-read` - 批量标记已读
- `GET /emails/search` - 搜索邮件

**偏好管理**
- `GET /preferences` - 获取用户偏好
- `POST /preferences` - 更新用户偏好
- `POST /chat` - 对话式交互

### WebSocket接口
- `/ws` - 实时进度推送和状态更新

## 关键技术实现

### 1. OAuth令牌管理
```python
class OAuthTokenManager:
    async def refresh_token_if_needed(self, user_id: int) -> bool:
        # 检查访问令牌是否即将过期
        # 使用refresh_token获取新的访问令牌
        # 加密存储新令牌
        # 刷新失败时通知用户
        pass
```

### 2. 定时任务可靠性
```python
class TaskScheduler:
    async def schedule_daily_report(self, user_id: int):
        # 检查是否已有运行中的任务（分布式锁）
        # 创建任务记录
        # 执行任务，支持重试机制
        # 更新任务状态
        pass
```

### 3. 实时进度推送
```python
class ProgressWebSocket:
    async def send_progress(self, user_id: int, progress: dict):
        # 查找用户的WebSocket连接
        # 发送进度更新
        # 处理连接断开的情况
        pass
```

### 4. 结构化日志
```python
import structlog
logger = structlog.get_logger()

# 使用示例
logger.info("邮件处理开始", user_id=123, email_count=50)
logger.error("Gmail API调用失败", user_id=123, error=str(e))
```

## 数据流设计

### 邮件处理流程
1. 定时任务触发 → EmailProcessor节点
2. 获取用户Gmail邮件 → Gmail API调用
3. 检索用户偏好向量 → pgvector查询
4. LLM分析邮件重要性 → 分类和评分
5. 生成日报 → 数据库存储
6. 通知用户 → WebSocket推送

### 用户交互流程
1. 用户发送消息 → ConversationHandler节点
2. 理解用户意图 → LLM分析
3. 调用相应工具 → 执行操作
4. 返回结果 → 实时响应

## 安全设计

### 数据保护
- Gmail令牌加密存储
- 用户数据隔离
- API访问控制

### 权限管理
- JWT认证
- 用户授权验证
- 操作权限检查

## 性能优化

### 数据库优化
- 索引优化
- 连接池管理
- 查询优化

### LLM调用优化
- 批量处理
- 结果缓存
- 多Provider支持

### 前端优化
- 懒加载
- 状态管理
- 缓存策略