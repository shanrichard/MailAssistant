#!/bin/bash

# MailAssistant å¼€å‘çŽ¯å¢ƒåˆå§‹åŒ–è„šæœ¬
# åœ¨å®¹å™¨åˆ›å»ºåŽæ‰§è¡Œï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰

set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º

echo "ðŸš€ Setting up MailAssistant development environment..."
echo "=================================================="

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. åˆ›å»ºå¿…è¦çš„ç›®å½•
echo -e "${YELLOW}Creating necessary directories...${NC}"
mkdir -p /workspace/logs
mkdir -p /workspace/data
mkdir -p /workspace/temp

# 2. è®¾ç½®çŽ¯å¢ƒå˜é‡æ–‡ä»¶
echo -e "${YELLOW}Setting up environment variables...${NC}"
if [ ! -f /workspace/.env ]; then
    if [ -f /workspace/.env.example ]; then
        cp /workspace/.env.example /workspace/.env
        echo -e "${GREEN}âœ“ Created .env file from .env.example${NC}"
    else
        echo -e "${YELLOW}âš  No .env.example found, creating basic .env file${NC}"
        cat > /workspace/.env << EOL
# MailAssistant Environment Variables
# Generated by devcontainer post-create script

# Database
DATABASE_URL=postgresql://postgres:postgres@db:5432/mailassistant

# Redis (Currently not used)
# REDIS_URL=redis://redis:6379

# Security
SECRET_KEY=dev-secret-key-change-in-production
ENCRYPTION_KEY=dev-encryption-key-change-in-production

# OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI=http://localhost:3000/auth/callback

# LLM APIs (Optional)
OPENAI_API_KEY=your-openai-api-key
ANTHROPIC_API_KEY=your-anthropic-api-key

# Frontend
REACT_APP_API_URL=http://localhost:8000
EOL
        echo -e "${GREEN}âœ“ Created basic .env file${NC}"
    fi
else
    echo -e "${GREEN}âœ“ .env file already exists${NC}"
fi

# 3. ç­‰å¾…æ•°æ®åº“å°±ç»ª
echo -e "${YELLOW}Waiting for PostgreSQL to be ready...${NC}"
max_retries=60
retries=0
while ! pg_isready -h db -p 5432 -U postgres > /dev/null 2>&1; do
    retries=$((retries + 1))
    if [ $retries -eq $max_retries ]; then
        echo -e "${YELLOW}âš  PostgreSQL is not ready after $max_retries attempts${NC}"
        break
    fi
    echo -n "."
    sleep 1
done
echo ""

if pg_isready -h db -p 5432 -U postgres > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“ PostgreSQL is ready${NC}"
    
    # 4. è¿è¡Œæ•°æ®åº“è¿ç§»
    echo -e "${YELLOW}Running database migrations...${NC}"
    cd /workspace/backend
    
    if [ -f alembic.ini ]; then
        # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ– alembic
        if ! alembic current 2>/dev/null; then
            echo "Initializing database..."
            alembic stamp head
        fi
        
        # è¿è¡Œè¿ç§»
        alembic upgrade head
        echo -e "${GREEN}âœ“ Database migrations completed${NC}"
    else
        echo -e "${YELLOW}âš  No alembic.ini found, skipping migrations${NC}"
    fi
else
    echo -e "${YELLOW}âš  Skipping database setup - PostgreSQL not available${NC}"
fi

# 5. å®‰è£… Git hooksï¼ˆå¦‚æžœæœ‰ï¼‰
echo -e "${YELLOW}Setting up Git hooks...${NC}"
cd /workspace
if [ -d .git ] && [ -f .pre-commit-config.yaml ]; then
    pre-commit install || echo -e "${YELLOW}âš  pre-commit not available${NC}"
    echo -e "${GREEN}âœ“ Git hooks installed${NC}"
fi

# 6. åˆ›å»º VS Code å·¥ä½œåŒºè®¾ç½®
echo -e "${YELLOW}Configuring VS Code workspace...${NC}"
mkdir -p /workspace/.vscode
if [ ! -f /workspace/.vscode/settings.json ]; then
    cat > /workspace/.vscode/settings.json << EOL
{
    "python.defaultInterpreterPath": "/usr/local/bin/python",
    "python.terminal.activateEnvironment": true,
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "editor.formatOnSave": true,
    "editor.rulers": [80, 120],
    "files.exclude": {
        "**/__pycache__": true,
        "**/*.pyc": true,
        "**/node_modules": true,
        "**/.pytest_cache": true
    }
}
EOL
    echo -e "${GREEN}âœ“ VS Code workspace settings created${NC}"
fi

# 7. æ˜¾ç¤ºæ¬¢è¿Žä¿¡æ¯
echo ""
echo -e "${GREEN}=================================================="
echo -e "âœ¨ MailAssistant development environment is ready!"
echo -e "=================================================="
echo ""
echo "Quick start commands:"
echo "  Backend:  cd /workspace/backend && python start_backend.py"
echo "  Frontend: cd /workspace/frontend && npm run dev"
echo ""
echo "Useful URLs:"
echo "  - Frontend: http://localhost:3000"
echo "  - Backend API: http://localhost:8000"
echo "  - API Docs: http://localhost:8000/docs"
echo "  - pgAdmin: http://localhost:5050 (if enabled)"
echo ""
echo "Database connection:"
echo "  - Host: db"
echo "  - Port: 5432"
echo "  - Database: mailassistant"
echo "  - User: postgres"
echo "  - Password: postgres"
echo -e "${NC}"